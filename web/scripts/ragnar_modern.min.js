let socket,reconnectAttempts=0;const RECONNECT_WARNING_THRESHOLD=5,RECONNECT_DELAY_MAX=15e3;let currentTab="dashboard",autoRefreshIntervals={},preloadedTabs=new Set,pendingFileHighlight=null,manualModeActive=!1,manualDataPrimed=!1,imagesLoaded=!1;const PWN_STATUS_POLL_INTERVAL=15e3,PWN_STATUS_FAST_INTERVAL=4e3,PWN_LOG_POLL_INTERVAL=2500;let pwnStatus={state:"not_installed",message:"Waiting for status...",phase:"idle",installed:!1,installing:!1,mode:"ragnar",target_mode:"ragnar",last_switch:"",service_active:!1,service_enabled:!1,timestamp:null,log_file:null},lastPwnState=null,currentPwnStatusInterval=15e3,pwnLogCursor=0,pwnLogStreamTimer=null,pwnLogStreaming=!1,pwnLogStopTimeout=null,pwnLogActiveFile=null,pwnLogFetchInFlight=!1,headlessMode=!1;const RELEASE_GATE_DEFAULT_MESSAGE="A controlled release is rolling out. Updating manually may cause instability.";let releaseGateState={enabled:!1,message:RELEASE_GATE_DEFAULT_MESSAGE},releaseGateResolver=null,releaseGatePendingPromise=null;const configMetadata={manual_mode:{label:"Pentest Mode",description:"Hold Ragnar in hands-on pentest control. Disable this to let the orchestrator continuously discover devices, run actions, and launch vulnerability scans automatically."},debug_mode:{label:"Debug Mode",description:"Enable verbose debug logging for deeper troubleshooting output."},scan_vuln_running:{label:"Vulnerability Scanning",description:"Enable automatic vulnerability scans on discovered hosts based on the configured interval."},scan_vuln_no_ports:{label:"Scan Hosts Without Ports",description:"When enabled, vulnerability scans will scan the top 50 common ports on hosts where no ports were discovered. When disabled, only hosts with discovered ports will be scanned."},enable_attacks:{label:"Enable Automatic Attacks",description:"Allow Ragnar to perform automated attacks (SSH, FTP, SMB, SQL, etc.) on discovered targets. Disable to only scan without attacking."},retry_success_actions:{label:"Retry Successful Actions",description:"Re-run actions that previously succeeded after the success retry delay to keep intelligence fresh."},retry_failed_actions:{label:"Retry Failed Actions",description:"Retry actions that failed after waiting the failed retry delay."},blacklistcheck:{label:"Honor Scan Blacklists",description:"Skip hosts or MAC addresses that appear in the scan blacklist lists when running automated actions."},displaying_csv:{label:"Display Scan CSV",description:"Push the most recent scan CSV results to the e-paper display after each network sweep."},log_debug:{label:"Log Debug Messages",description:"Include debug-level entries in Ragnar logs."},log_info:{label:"Log Info Messages",description:"Include informational entries in Ragnar logs."},log_warning:{label:"Log Warning Messages",description:"Include warning-level entries in Ragnar logs."},log_error:{label:"Log Error Messages",description:"Include error-level entries in Ragnar logs."},log_critical:{label:"Log Critical Messages",description:"Include critical-level entries in Ragnar logs."},startup_delay:{label:"Startup Delay (s)",description:"Seconds to wait after boot before the orchestrator begins automated activity."},web_delay:{label:"Web Update Delay (s)",description:"Seconds between refreshes of the web dashboards and API responses."},screen_delay:{label:"Screen Update Delay (s)",description:"Seconds between e-paper display refreshes."},comment_delaymin:{label:"Comment Delay Min (s)",description:"Minimum number of seconds between on-screen comment rotations."},comment_delaymax:{label:"Comment Delay Max (s)",description:"Maximum number of seconds between on-screen comment rotations."},livestatus_delay:{label:"Live Status Delay (s)",description:"Seconds between updates to the live status CSV that feeds dashboards."},image_display_delaymin:{label:"Image Display Min (s)",description:"Minimum time an image remains on the e-paper display."},image_display_delaymax:{label:"Image Display Max (s)",description:"Maximum time an image remains on the e-paper display."},scan_interval:{label:"Scan Interval (s)",description:"Seconds between full network discovery scans."},scan_vuln_interval:{label:"Vulnerability Scan Interval (s)",description:"Seconds between automated vulnerability scan cycles when enabled."},failed_retry_delay:{label:"Failed Retry Delay (s)",description:"Seconds to wait before retrying an action that previously failed."},success_retry_delay:{label:"Success Retry Delay (s)",description:"Seconds to wait before repeating an action that previously succeeded."},ref_width:{label:"Reference Width",description:"Reference pixel width used to scale drawings for the e-paper display."},ref_height:{label:"Reference Height",description:"Reference pixel height used to scale drawings for the e-paper display."},screen_reversed:{label:"Flip E-Paper Output",description:"Rotate the Waveshare e-paper output 180¬∞ so the content appears upright when the panel is mounted upside down."},epd_type:{label:"EPD Type",description:"Model identifier for the connected Waveshare e-paper display."},portlist:{label:"Additional Ports",description:"Comma separated list of extra ports to check on every host in addition to the sequential range."},mac_scan_blacklist:{label:"MAC Scan Blacklist",description:"Comma separated MAC addresses Ragnar should ignore during scans and automated actions."},ip_scan_blacklist:{label:"IP Scan Blacklist",description:"Comma separated IP addresses Ragnar should ignore during scans and automated actions."},steal_file_names:{label:"Target File Names",description:"Comma separated file name fragments that trigger file collection when encountered."},steal_file_extensions:{label:"Target File Extensions",description:"Comma separated file extensions that Ragnar should collect when found."},nmap_scan_aggressivity:{label:"Nmap Aggressiveness",description:"Timing template flag passed to nmap (for example -T2). Adjust to trade accuracy for speed."},portstart:{label:"Port Range Start",description:"First port in the sequential range scanned on every host."},portend:{label:"Port Range End",description:"Last port in the sequential range scanned on every host."},timewait_smb:{label:"SMB Retry Wait (s)",description:"Seconds to wait before retrying SMB actions against a host."},timewait_ssh:{label:"SSH Retry Wait (s)",description:"Seconds to wait before retrying SSH actions against a host."},timewait_telnet:{label:"Telnet Retry Wait (s)",description:"Seconds to wait before retrying Telnet actions against a host."},timewait_ftp:{label:"FTP Retry Wait (s)",description:"Seconds to wait before retrying FTP actions against a host."},timewait_sql:{label:"SQL Retry Wait (s)",description:"Seconds to wait before retrying SQL actions against a host."},timewait_rdp:{label:"RDP Retry Wait (s)",description:"Seconds to wait before retrying RDP actions against a host."},wifi_known_networks:{label:"Known Wi-Fi Networks",description:"Comma separated list of SSIDs Ragnar should automatically join when detected."},wifi_ap_ssid:{label:"AP SSID",description:"Network name broadcast when Ragnar creates its own access point."},wifi_ap_password:{label:"AP Password",description:"Password clients must use to join Ragnar's access point."},wifi_connection_timeout:{label:"Wi-Fi Connection Timeout (s)",description:"Seconds to wait for each Wi-Fi connection attempt before considering it failed."},wifi_max_attempts:{label:"Wi-Fi Max Attempts",description:"Number of Wi-Fi connection retries before giving up or falling back to AP mode."},wifi_scan_interval:{label:"Wi-Fi Scan Interval (s)",description:"Seconds between wireless network scans performed by the Wi-Fi manager."},wifi_monitor_enabled:{label:"Wi-Fi Monitor",description:"Keep the Wi-Fi manager running so connectivity issues are detected quickly."},wifi_auto_ap_fallback:{label:"Auto AP Fallback",description:"Automatically enable Ragnar's access point if normal Wi-Fi connectivity cannot be restored."},wifi_ap_timeout:{label:"AP Timeout (s)",description:"Maximum duration before an active Ragnar access point session shuts down automatically."},wifi_ap_idle_timeout:{label:"AP Idle Timeout (s)",description:"Seconds of inactivity allowed before shutting down the Ragnar access point."},wifi_reconnect_interval:{label:"Wi-Fi Reconnect Interval (s)",description:"Seconds between Wi-Fi reconnect attempts when the device is offline."},wifi_ap_cycle_enabled:{label:"AP Smart Cycling",description:"Periodically cycle the access point when active to limit exposure."},wifi_initial_connection_timeout:{label:"Initial Wi-Fi Timeout (s)",description:"Timeout for the very first Wi-Fi connection attempt during boot."},network_device_retention_days:{label:"Device Retention (days)",description:"Number of days to keep inactive devices in the network database before pruning them."},network_resolution_timeout:{label:"Resolution Timeout (s)",description:"Seconds to wait before re-resolving details for the same device."},network_confirmation_scans:{label:"Confirmation Scans",description:"Number of extra scans required to confirm a detected network change."},network_change_grace:{label:"Change Grace Period (s)",description:"Grace period after detecting a network change before automation responds."},network_intelligence_enabled:{label:"Network Intelligence",description:"Enable the network intelligence engine that tracks devices and their state changes."},network_auto_resolution:{label:"Automatic Resolution",description:"Automatically resolve and enrich newly discovered or changed devices."},network_max_failed_pings:{label:"Max Failed Pings Before Offline",description:"Number of consecutive failed ping/ARP checks before marking a host as offline (red dot). With ARP scans every 60s, setting this to 5 means ~5 minutes, 15 means ~15 minutes, 30 means ~30 minutes before offline status."},ai_enabled:{label:"Enable AI Insights",description:"Enable AI-powered network analysis and vulnerability insights using OpenAI GPT."},openai_api_token:{label:"OpenAI API Token",description:"Your OpenAI API key for AI-powered features. Keep this confidential."}};function getConfigLabel(e){return configMetadata[e]&&configMetadata[e].label?configMetadata[e].label:e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}const displaySelectOptions={epd_type:[{value:"epd2in13_V4",label:'Waveshare 2.13" V4 (122x250)'},{value:"epd2in13_V3",label:'Waveshare 2.13" V3 (122x250)'},{value:"epd2in13_V2",label:'Waveshare 2.13" V2 (122x250)'},{value:"epd2in7",label:'Waveshare 2.7" (176x264)'}],screen_reversed:[{value:"false",label:"Normal orientation"},{value:"true",label:"Flip 180¬∞"}]};function getConfigDescription(e){return configMetadata[e]&&configMetadata[e].description?configMetadata[e].description:"No additional information available for this setting."}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function isValidIPv4(e){if(!e)return!1;return/^(25[0-5]|2[0-4]\d|1?\d{1,2})(\.(25[0-5]|2[0-4]\d|1?\d{1,2})){3}$/.test(e.trim())}function initializeSocket(){socket=io({reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:15e3}),socket.on("connect",function(){console.log("Connected to Ragnar server"),updateConnectionStatus(!0),reconnectAttempts=0,addConsoleMessage("Connected to Ragnar server","success"),socket.emit("request_status"),socket.emit("request_logs"),refreshPwnagotchiStatus({silent:!0})}),socket.on("disconnect",function(){console.log("Disconnected from Ragnar server"),updateConnectionStatus(!1),addConsoleMessage("Disconnected from server","error"),setTimeout(()=>{socket&&socket.disconnected&&(console.log("Attempting manual socket reconnection"),socket.connect())},2e3)}),socket.on("status_update",function(e){updateDashboardStatus(e)}),socket.on("log_update",function(e){updateConsole(e)}),socket.on("pwnagotchi_status",function(e){const t=pwnStatus.state;updatePwnagotchiUI(e),e&&e.state&&e.state!==t&&addConsoleMessage(`Pwnagotchi status changed: ${formatPwnStateLabel(e.state)}`,"info")}),socket.on("network_update",function(e){"network"===currentTab&&loadStableNetworkData()}),socket.on("credentials_update",function(e){"discovered"===currentTab&&displayCredentialsTable(e)}),socket.on("loot_update",function(e){"discovered"===currentTab&&displayLootTable(e)}),socket.on("config_updated",function(e){addConsoleMessage("Configuration updated successfully","info"),"config"===currentTab&&displayConfigForm(e),updateAttackWarningBanner(Boolean(e&&e.enable_attacks))}),socket.on("scan_started",function(e){handleScanStarted(e)}),socket.on("scan_progress",function(e){handleScanProgress(e)}),socket.on("scan_host_update",function(e){handleScanHostUpdate(e)}),socket.on("scan_completed",function(e){handleScanCompleted(e)}),socket.on("scan_error",function(e){handleScanError(e)}),socket.on("deep_scan_update",function(e){handleDeepScanUpdate(e)}),socket.on("lynis_update",function(e){handleLynisUpdate(e)}),socket.on("manual_attack_update",function(e){handleManualAttackUpdate(e)}),socket.on("connect_error",function(e){reconnectAttempts++,console.error("Connection error:",e),5===reconnectAttempts?addConsoleMessage("Reconnecting to server‚Ä¶ still attempting to reach backend","warning"):reconnectAttempts>5&&reconnectAttempts%5==0&&addConsoleMessage(`Still reconnecting (attempt ${reconnectAttempts}). Will keep trying until successful.`,"warning")})}function updateConnectionStatus(e){const t=document.getElementById("connection-status");t&&(t.innerHTML=e?'\n                <span class="w-2 h-2 bg-green-500 rounded-full pulse-glow"></span>\n                <span class="text-xs text-gray-400">Connected</span>\n            ':'\n                <span class="w-2 h-2 bg-red-500 rounded-full"></span>\n                <span class="text-xs text-gray-400">Disconnected</span>\n            ')}function setupEventListeners(){document.querySelectorAll("[data-tab]").forEach(e=>{e.addEventListener("click",function(){showTab(this.getAttribute("data-tab"))})}),document.addEventListener("click",function(e){e.target.classList.contains("refresh-btn")&&refreshCurrentTab()});const e=document.getElementById("clear-console");e&&e.addEventListener("click",clearConsole);const t=document.getElementById("custom-deep-scan-btn");t&&t.addEventListener("click",handleCustomDeepScanRequest);const n=document.getElementById("custom-deep-scan-ip");n&&n.addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),handleCustomDeepScanRequest())});const a=document.getElementById("manual-port-dropdown");a&&a.addEventListener("change",()=>{updateManualActions()});const s=document.getElementById("manual-action-dropdown");s&&s.addEventListener("change",()=>{window.manualActionPreference=s.value});const o=document.getElementById("automation-toggle-btn");o&&o.addEventListener("click",handleAutomationToggle)}function initializeTabs(){showTab("dashboard")}function showTab(e){currentTab=e,systemMonitoringInterval&&"system"!==e&&(clearInterval(systemMonitoringInterval),systemMonitoringInterval=null),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.add("hidden")}),document.querySelectorAll(".nav-btn, [data-tab]").forEach(e=>{e.classList.remove("bg-Ragnar-600"),e.classList.add("text-gray-300","hover:text-white","hover:bg-gray-700")});const t=document.getElementById(`${e}-tab`);t&&t.classList.remove("hidden");const n=document.querySelector(`[data-tab="${e}"]`);n&&(n.classList.add("bg-Ragnar-600"),n.classList.remove("text-gray-300","hover:text-white","hover:bg-gray-700")),loadTabData(e);const a=document.getElementById("mobile-menu");a&&a.classList.add("hidden")}function refreshCurrentTab(){loadTabData(currentTab),addConsoleMessage(`Refreshed ${currentTab} data`,"info")}function setupAutoRefresh(){autoRefreshIntervals.network=setInterval(()=>{"network"===currentTab&&socket&&socket.connected&&socket.emit("request_network")},1e4),autoRefreshIntervals.connect=setInterval(()=>{"connect"===currentTab&&refreshWifiStatus(),"pentest"===currentTab&&manualModeActive&&refreshBluetoothStatus()},15e3),autoRefreshIntervals.discovered=setInterval(()=>{"discovered"===currentTab&&socket&&socket.connected&&(socket.emit("request_credentials"),socket.emit("request_loot"),loadAttackLogs())},2e4),autoRefreshIntervals.console=setInterval(()=>{"dashboard"===currentTab&&loadConsoleLogs()},1e4),autoRefreshIntervals.dashboard=setInterval(()=>{"dashboard"===currentTab&&loadDashboardData()},2e4),autoRefreshIntervals.updates=setInterval(()=>{checkForUpdatesQuiet()},3e5),setTimeout(()=>{checkForUpdatesQuiet()},3e4),setPwnStatusPollInterval(15e3)}function initializeMobileMenu(){const e=document.getElementById("mobile-menu-btn"),t=document.getElementById("mobile-menu");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("hidden")})}async function loadInitialData(){try{const e=await fetchAPI("/api/dashboard/quick");e&&(updateDashboardStats(e),updateDashboardStatus(e)),setTimeout(()=>{refreshWifiStatus().catch(e=>console.warn("WiFi status load failed:",e))},200),setTimeout(()=>{loadConsoleLogs().then(()=>{addConsoleMessage("Ragnar Modern Web Interface Initialized","success"),addConsoleMessage("Dashboard loaded successfully","info")}).catch(e=>{console.warn("Console logs load failed:",e),addConsoleMessage("Error loading console logs","warning")})},1e3);let t=!1;const n=()=>{t||(t=!0,console.log("User interaction detected - starting background tab preload"),setTimeout(()=>preloadAllTabs(),100))};document.addEventListener("mousemove",n,{once:!0}),document.addEventListener("click",n,{once:!0}),document.addEventListener("scroll",n,{once:!0}),document.addEventListener("touchstart",n,{once:!0}),setTimeout(()=>{t||(t=!0,console.log("Auto-starting background tab preload after timeout"),preloadAllTabs())},1e4)}catch(e){console.error("Error loading initial data:",e),addConsoleMessage("Error loading critical dashboard data","error")}}async function preloadAllTabs(){console.log("Starting background preload of all tabs...");try{await loadNetworkData().catch(e=>console.warn("Network preload failed:",e)),preloadedTabs.add("network"),await new Promise(e=>setTimeout(e,500)),await Promise.all([loadCredentialsData().catch(e=>console.warn("Credentials preload failed:",e)),loadLootData().catch(e=>console.warn("Loot preload failed:",e)),loadAttackLogs().catch(e=>console.warn("Attack logs preload failed:",e)),loadVulnerabilityIntel().catch(e=>console.warn("Vulnerability intel preload failed:",e))]),preloadedTabs.add("discovered"),await new Promise(e=>setTimeout(e,500)),await loadThreatIntelData().catch(e=>console.warn("Threat intel preload failed:",e)),preloadedTabs.add("threat-intel"),await new Promise(e=>setTimeout(e,500)),await loadConnectData().catch(e=>console.warn("Connect preload failed:",e)),preloadedTabs.add("connect"),await new Promise(e=>setTimeout(e,500)),await loadEpaperDisplay().catch(e=>console.warn("E-Paper preload failed:",e)),preloadedTabs.add("epaper"),await new Promise(e=>setTimeout(e,500)),await Promise.all([loadFilesData().catch(e=>console.warn("Files preload failed:",e)),loadConfigData().catch(e=>console.warn("Config preload failed:",e))]),preloadedTabs.add("files"),preloadedTabs.add("config"),console.log("Background tab preload completed"),addConsoleMessage("All tabs preloaded and ready","success")}catch(e){console.error("Error during tab preloading:",e)}}async function loadTabData(e){const t=preloadedTabs.has(e);switch(e){case"dashboard":await loadDashboardData(),setTimeout(()=>loadConsoleLogs(),50);break;case"network":await loadNetworkData();break;case"connect":t?(await refreshWifiStatus().catch(e=>console.warn("WiFi refresh failed:",e)),await refreshBluetoothStatus().catch(e=>console.warn("Bluetooth refresh failed:",e))):await loadConnectData();break;case"pentest":manualModeActive?await loadPentestData():(addConsoleMessage("Enable Pentest Mode to access the Pentest tab","warning"),showTab("dashboard"));break;case"discovered":t||await Promise.all([loadCredentialsData(),loadLootData(),loadAttackLogs(),loadVulnerabilityIntel()]),await refreshPwnagotchiStatus({silent:!0});break;case"threat-intel":await loadThreatIntelData();break;case"files":t||await loadFilesData();break;case"system":loadSystemData();break;case"netkb":loadNetkbData();break;case"epaper":t||await loadEpaperDisplay();break;case"config":t?await refreshPwnagotchiStatus({silent:!0}):await loadConfigData()}}async function loadDashboardData(){try{const e=["target-count","target-total-count","target-inactive-count","port-count","vuln-count","cred-count","level-count","scanned-network-count","points-count"];e.forEach(e=>{const t=document.getElementById(e);t&&t.classList.add("animate-pulse")});const t=await fetchAPI("/api/dashboard/quick");e.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("animate-pulse")}),t&&(updateDashboardStats(t),updateDashboardStatus(t)),await loadAIInsights()}catch(e){console.error("Error loading dashboard data:",e);["target-count","target-total-count","target-inactive-count","port-count","vuln-count","cred-count","level-count","scanned-network-count","points-count"].forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("animate-pulse")})}}function toNumber(e,t=0){const n=Number(e);return Number.isFinite(n)?n:t}function formatRelativeTime(e){if(!Number.isFinite(e))return null;let t=Math.max(0,Math.floor(e));const n=[{label:"d",value:86400},{label:"h",value:3600},{label:"m",value:60},{label:"s",value:1}],a=[];for(const e of n){if(t>=e.value||"s"===e.label&&0===a.length){const n=Math.floor(t/e.value);(n>0||"s"===e.label)&&a.push(`${n}${e.label}`),t-=n*e.value}if(a.length>=2)break}return a.length>0?a.join(" "):"0s"}function buildLastSyncDisplay(e){if(!e)return"Sync pending‚Ä¶";const t=toNumber(e.last_sync_age_seconds,NaN),n=Number.isFinite(t)?`${formatRelativeTime(t)} ago`:"";let a=e.last_sync_iso??e.last_sync_time??e.last_sync_timestamp,s=null;"number"==typeof a?s=new Date(1e3*a).toISOString():"string"==typeof a&&a&&(s=a);let o="";if(s){const e=new Date(s);Number.isNaN(e.getTime())||(o=e.toLocaleString())}return n&&o?`${n} (${o})`:n||(o||"Sync pending‚Ä¶")}function updateDashboardStats(e){if(!e||"object"!=typeof e)return;const t=toNumber(e.active_target_count??e.target_count,0),n=toNumber(e.inactive_target_count??e.offline_target_count,0),a=toNumber(e.total_target_count??t+n,t+n),s=Array.isArray(e.new_target_ips)?e.new_target_ips:Array.isArray(e.new_targets)?e.new_targets:[],o=Array.isArray(e.lost_target_ips)?e.lost_target_ips:Array.isArray(e.lost_targets)?e.lost_targets:[],r=toNumber(e.new_target_count??e.new_targets??s.length,s.length),i=toNumber(e.lost_target_count??e.lost_targets??o.length,o.length),l=toNumber(e.port_count??e.open_port_count,0),c=toNumber(e.vulnerability_count??e.vuln_count,0),d=toNumber(e.vulnerable_hosts_count??e.vulnerable_host_count??0,0),u=toNumber(e.credential_count??e.cred_count,0),p=toNumber(e.level??e.levelnbr,0),g=toNumber(e.points??e.coins,0),m=Math.max(0,toNumber(e.scanned_network_count??e.networks_scanned,0));updateElement("target-count",t),scaleStatNumber("target-count",t),updateElement("target-total-count",a),updateElement("target-inactive-count",n),updateElement("target-new-count",r),updateElement("target-lost-count",i);const f=document.getElementById("target-new-count");f&&(f.title=s.length>0?s.join(", "):"No recent additions");const h=document.getElementById("target-lost-count");h&&(h.title=o.length>0?o.join(", "):"No recent drops"),updateElement("port-count",l),scaleStatNumber("port-count",l),updateElement("vuln-count",c),scaleStatNumber("vuln-count",c),updateElement("dashboard-vulnerable-hosts-count",d),updateElement("cred-count",u),scaleStatNumber("cred-count",u),updateElement("level-count",p),scaleStatNumber("level-count",p),updateElement("scanned-network-count",m),scaleStatNumber("scanned-network-count",m),updateElement("dashboard-scanned-network-count",m),scaleStatNumber("dashboard-scanned-network-count",m),updateElement("points-count",g);const y=r>0?`${r} new`:"No new targets",b=i>0?`${i} lost`:"No targets lost";updateElement("active-target-summary",a>0?`${t}/${a} active`:`${t} active`),updateElement("new-target-summary",y),updateElement("lost-target-summary",b),updateElement("last-sync-display",buildLastSyncDisplay(e))}async function loadNetworkData(){try{await loadStableNetworkData(),updateNetworkStatusBanner()}catch(e){console.error("Error loading network data:",e),addConsoleMessage("Failed to load network data","error")}}async function updateNetworkStatusBanner(){try{const e=await fetchAPI("/api/config");if(e&&e.success){const t=e.config.network_max_failed_pings||15,n=Math.round(60*t/60),a=document.getElementById("network-status-failed-pings"),s=document.getElementById("network-status-offline-time");a&&(a.textContent=t),s&&(s.textContent=`${n} minutes`)}}catch(e){console.debug("Could not update network status banner:",e)}}async function loadStableNetworkData(){try{const e=await fetchAPI("/api/network/stable");e.success?(displayStableNetworkTable(e),addConsoleMessage(`Network data loaded: ${e.count} hosts`,"info")):addConsoleMessage(`Failed to load network data: ${e.error}`,"error")}catch(e){console.error("Error loading stable network data:",e),addConsoleMessage(`Network data error: ${e.message}`,"error")}}function displayStableNetworkTable(e){const t=document.getElementById("network-hosts-table"),n=document.getElementById("host-count");if(!t)return;if(t.querySelectorAll("tr[data-ip]").forEach(e=>{const t=e.getAttribute("data-ip");t&&saveDeepScanButtonState(t)}),t.innerHTML="",!e.hosts||0===e.hosts.length)return t.innerHTML='\n            <tr>\n                <td colspan="8" class="text-center py-8 text-gray-400">\n                    No hosts discovered yet. Network scanning is running in the background.\n                </td>\n            </tr>\n        ',void(n&&(n.textContent="0 hosts"));const a=document.createDocumentFragment();e.hosts.forEach((e,t)=>{t<5&&(console.log(`üîç Host ${t}:`,e),console.log("   IP field:",e.ip,typeof e.ip),console.log("   All fields:",Object.keys(e)));const n=document.createElement("tr");n.className="border-b border-slate-700 hover:bg-slate-700/50 transition-colors";const s="up"===e.status?'<span class="flex items-center"><div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>Online</span>':'<span class="flex items-center"><div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>Unknown</span>';let o="Unknown"===e.mac?'<span class="text-gray-500">Unknown</span>':`<span class="font-mono text-xs">${e.mac}</span>`,r="Unknown"===e.ports||"Scanning..."===e.ports?'<span class="text-gray-500">Unknown</span>':`<span class="text-xs">${e.ports}</span>`,i="0"===e.vulnerabilities?'<span class="text-gray-500">None</span>':`<span class="text-orange-400">${e.vulnerabilities}</span>`,l="Never"===e.last_scan||"Unknown"===e.last_scan?'<span class="text-gray-500">Never</span>':`<span class="text-xs">${formatTimeAgo(e.last_scan)}</span>`;n.innerHTML=`\n            <td class="py-3 px-4">${s}</td>\n            <td class="py-3 px-4 font-mono text-sm">${e.ip}</td>\n            <td class="py-3 px-4">${"Unknown"===e.hostname?'<span class="text-gray-500">Unknown</span>':e.hostname}</td>\n            <td class="py-3 px-4">${o}</td>\n            <td class="py-3 px-4">${r}</td>\n            <td class="py-3 px-4">${i}</td>\n            <td class="py-3 px-4">${l}</td>\n            <td class="py-3 px-4">\n                <button onclick="triggerDeepScan('${e.ip}', { mode: 'full' })" \n                        id="deep-scan-btn-${e.ip.replace(/\./g,"-")}"\n                        data-scan-status="idle"\n                        class="deep-scan-button bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded transition-all duration-300"\n                        title="Scan all 65535 ports with TCP connect (-sT). IP: ${e.ip}">\n                    Deep Scan\n                </button>\n            </td>\n        `,n.setAttribute("data-ip",e.ip),a.appendChild(n)}),t.appendChild(a),e.hosts.forEach(e=>{restoreDeepScanButtonState(e.ip)}),n&&(n.textContent=`${e.hosts.length} hosts`),cleanupOldDeepScanStates()}function formatTimeAgo(e){try{if(!e||"Never"===e||"Unknown"===e)return"Never";if(e.includes("ago")||e.includes("Recently"))return e;const t=new Date(e);if(isNaN(t.getTime()))return e;const n=new Date-t,a=Math.floor(n/6e4),s=Math.floor(n/36e5),o=Math.floor(n/864e5);return a<1?"Just now":a<60?`${a}m ago`:s<24?`${s}h ago`:o<7?`${o}d ago`:t.toLocaleDateString()}catch(t){return e}}document.addEventListener("DOMContentLoaded",function(){initializeSocket(),initializeTabs(),initializeMobileMenu(),loadInitialData(),setupAutoRefresh(),setupEpaperAutoRefresh(),setupEventListeners(),initializePwnUI(),initializePwnagotchiVisibility()});let currentScanState={isScanning:!1,totalHosts:0,scannedHosts:0,currentTarget:"",startTime:null},deepScanButtonStates=new Map;function saveDeepScanButtonState(e){const t=`deep-scan-btn-${e.replace(/\./g,"-")}`,n=document.getElementById(t);if(n){const t={status:n.dataset.scanStatus||"idle",text:n.textContent,classes:n.className,disabled:n.disabled,title:n.title};deepScanButtonStates.set(e,t),console.log(`üíæ Saved deep scan button state for ${e}:`,t)}}function restoreDeepScanButtonState(e){const t=`deep-scan-btn-${e.replace(/\./g,"-")}`,n=document.getElementById(t),a=deepScanButtonStates.get(e);n&&a?(n.textContent=a.text,n.className=a.classes,n.disabled=a.disabled,n.title=a.title,n.dataset.scanStatus=a.status,console.log(`üîÑ Restored deep scan button state for ${e}:`,a)):n&&!a&&console.log(`‚ö†Ô∏è No saved state found for ${e}, keeping default button state`)}function clearDeepScanButtonState(e){deepScanButtonStates.has(e)&&(deepScanButtonStates.delete(e),console.log(`üóëÔ∏è Cleared deep scan button state for ${e}`))}function cleanupOldDeepScanStates(){let e=0;for(const[t]of deepScanButtonStates){const n=`deep-scan-btn-${t.replace(/\./g,"-")}`;document.getElementById(n)||(deepScanButtonStates.delete(t),e++)}e>0&&console.log(`üßπ Cleaned up ${e} old deep scan button states`)}async function startRealtimeScan(){const e=document.getElementById("start-network-scan"),t=document.getElementById("stop-network-scan");try{e.disabled=!0,e.innerHTML="‚è≥ Starting...";if(!(await fetch("/api/scan/start-realtime",{method:"POST",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to start scan");currentScanState.isScanning=!0,currentScanState.startTime=new Date,t.disabled=!1,e.innerHTML="‚è≥ Scanning...",document.getElementById("scan-progress").classList.remove("hidden"),addConsoleMessage("Real-time network scan started","info")}catch(e){console.error("Error starting scan:",e),addConsoleMessage("Failed to start network scan: "+e.message,"error"),resetScanButtons()}}async function stopRealtimeScan(){const e=document.getElementById("stop-network-scan");try{e.disabled=!0,e.innerHTML="‚è≥ Stopping...",socket.emit("stop_scan"),addConsoleMessage("Stopping network scan...","info")}catch(t){console.error("Error stopping scan:",t),addConsoleMessage("Failed to stop network scan: "+t.message,"error"),e.disabled=!1,e.innerHTML="‚èπÔ∏è Stop Scan"}}function resetScanButtons(){const e=document.getElementById("start-network-scan"),t=document.getElementById("stop-network-scan");e.disabled=!1,e.innerHTML='<span class="group-disabled:hidden">üîç</span> Start Full Scan',t.disabled=!0,t.innerHTML="‚èπÔ∏è Stop Scan",currentScanState.isScanning=!1,document.getElementById("scan-progress").classList.add("hidden")}function handleScanStarted(e){currentScanState.totalHosts=e.total_hosts||0,currentScanState.scannedHosts=0,updateScanProgress(),addConsoleMessage(`Started scanning ${currentScanState.totalHosts} hosts`,"info")}function handleScanProgress(e){currentScanState.scannedHosts=e.completed||0,currentScanState.currentTarget=e.current_target||"",updateScanProgress()}function handleScanHostUpdate(e){if(!e)return;const t=e.type||e.event||"host_update";if("sep_scan_output"!==t){if("sep_scan_error"===t){return void addConsoleMessage(`${e.ip?`sep-scan error for ${e.ip}`:"sep-scan error"}: ${e.message||"Unknown error"}`,"error")}if("sep_scan_completed"===t){return addConsoleMessage(`sep-scan completed for ${e.ip||"target"} ${"success"===e.status?"successfully":"with issues"}`,"success"===e.status?"success":"warning"),void("network"===currentTab&&loadNetworkData())}return"host_updated"===t||e.ip||e.IPs?("network"===currentTab&&updateHostInTable(e),void(e.vulnerabilities&&e.vulnerabilities.length>0&&("threat-intel"===currentTab&&loadThreatIntelData(),"netkb"===currentTab&&loadNetkbData()))):void 0}if(e.message){addConsoleMessage(`${e.ip?`[sep-scan ${e.ip}]`:"[sep-scan]"} ${e.message}`,"info")}}function handleScanCompleted(e){addConsoleMessage(`Network scan completed. Found ${e.hosts_discovered||0} hosts, ${e.vulnerabilities_found||0} vulnerabilities`,"success"),resetScanButtons(),"network"===currentTab&&loadNetworkData()}function handleScanError(e){addConsoleMessage(`Scan error: ${e.error}`,"error"),resetScanButtons()}async function handleCustomDeepScanRequest(){const e=document.getElementById("custom-deep-scan-ip"),t=document.getElementById("custom-deep-scan-status"),n=document.getElementById("custom-deep-scan-btn");if(!e||!t||!n)return;const a=e.value.trim();if(!a)return t.textContent="Enter a target IP address before scanning.",void addConsoleMessage("Manual deep scan aborted: no IP provided","warning");if(!isValidIPv4(a))return t.textContent="Please enter a valid IPv4 address (e.g., 192.168.1.192).",void addConsoleMessage(`Manual deep scan aborted: invalid IPv4 (${a})`,"error");const s=n.dataset.defaultText||n.textContent;n.dataset.defaultText=s,n.disabled=!0,n.classList.add("cursor-wait","opacity-80"),n.textContent="Starting...",t.dataset.currentIp=a,t.textContent=`Launching custom scan for ${a} (top 3000 ports)...`,addConsoleMessage(`Manual deep scan request queued for ${a} (top 3000 ports)`,"info");try{await triggerDeepScan(a,{mode:"top3000",source:"custom"})?t.textContent=`Scan running on ${a}. Watch the console for live updates.`:(t.textContent=`Failed to start scan for ${a}. See console for details.`,t.dataset.currentIp="")}catch(e){t.textContent=`Unexpected error starting scan: ${e.message}`,t.dataset.currentIp=""}finally{n.disabled=!1,n.classList.remove("cursor-wait","opacity-80"),n.textContent=n.dataset.defaultText}}function testDeepScan(){console.log("üß™ Testing deep scan with hardcoded IP..."),triggerDeepScan("192.168.1.211")}async function triggerDeepScan(e,t={}){try{if(console.log("üîç triggerDeepScan CALLED"),console.log("   Received IP parameter:",e),console.log("   IP type:",typeof e),console.log("   IP length:",e?e.length:"null/undefined"),!e)return console.error("‚ùå IP parameter is empty in triggerDeepScan!"),void addConsoleMessage("Error: No IP address provided for deep scan","error");const n=(t.mode||"full").toLowerCase(),a=Number.isInteger(t.portstart)?t.portstart:void 0,s=Number.isInteger(t.portend)?t.portend:void 0,o="top3000"===n?"top 3000 ports":"all 65535 ports",r=`deep-scan-btn-${e.replace(/\./g,"-")}`,i=document.getElementById(r);i&&(i.classList.remove("bg-purple-600","hover:bg-purple-700"),i.classList.add("bg-blue-600","cursor-wait"),i.disabled=!0,i.textContent="Initiating...",i.dataset.scanStatus="initiating",saveDeepScanButtonState(e)),addConsoleMessage(`Starting deep scan on ${e} (${o})...`,"info"),console.log("üì§ Sending POST request to /api/scan/deep");const l={ip:e};n&&(l.mode=n),void 0!==a&&(l.portstart=a),void 0!==s&&(l.portend=s),console.log("   Request body:",JSON.stringify(l));const c=await fetch("/api/scan/deep",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});console.log("üì• Response received, status:",c.status);const d=await c.json();return console.log("üìã Response data:",d),"success"===d.status?(addConsoleMessage(`Deep scan initiated for ${e} - scanning ${o}`,"success"),!0):(addConsoleMessage(`Failed to start deep scan: ${d.message}`,"error"),i&&(i.classList.remove("bg-blue-600","cursor-wait"),i.classList.add("bg-purple-600","hover:bg-purple-700"),i.disabled=!1,i.textContent="Deep Scan",i.dataset.scanStatus="idle",clearDeepScanButtonState(e)),!1)}catch(t){console.error("Error triggering deep scan:",t),addConsoleMessage(`Error starting deep scan: ${t.message}`,"error");const n=`deep-scan-btn-${e.replace(/\./g,"-")}`,a=document.getElementById(n);return a&&(a.classList.remove("bg-blue-600","cursor-wait"),a.classList.add("bg-purple-600","hover:bg-purple-700"),a.disabled=!1,a.textContent="Deep Scan",a.dataset.scanStatus="idle",clearDeepScanButtonState(e)),!1}}function handleLynisUpdate(e){const{type:t,ip:n,message:a,stage:s,details:o}=e,r=document.getElementById("manual-lynis-btn"),i=document.getElementById("lynis-audit-status");switch(t){case"lynis_started":addConsoleMessage(`üîê ${a}`,"info"),r&&(r.classList.remove("bg-red-600","hover:bg-red-700"),r.classList.add("bg-blue-600","cursor-wait"),r.disabled=!0,r.textContent="Audit started"),i&&(i.textContent=a,i.className="text-sm text-blue-600 mt-2");break;case"lynis_progress":if(r){const t=e.event;"connecting"===t?r.textContent="Connecting...":"connected"===t?r.textContent="Connected":"installing"===t?r.textContent="Installing Lynis...":"lynis_found"===t?r.textContent="Lynis ready":"audit_starting"===t?r.textContent="Running audit...":"processing"===t&&(r.textContent="Processing results...")}i&&a&&(i.textContent=a,o&&(i.textContent+=` (${o})`)),s&&["connection","setup","audit","processing"].includes(s)&&addConsoleMessage(`   ${a}`,"info");break;case"lynis_completed":addConsoleMessage(`‚úÖ ${a}`,"success"),r&&(r.classList.remove("bg-blue-600","cursor-wait"),r.classList.add("bg-green-600"),r.textContent="‚úÖ Audit complete",r.disabled=!0,setTimeout(()=>{r&&(r.classList.remove("bg-green-600"),r.classList.add("bg-red-600","hover:bg-red-700"),r.textContent="Run Lynis Audit",r.disabled=!1)},3e3)),i&&(i.textContent=`Audit completed for ${n}. Check vulnerabilities directory for results.`,i.className="text-sm text-green-600 mt-2");break;case"lynis_error":addConsoleMessage(`‚ùå ${a}`,"error"),r&&(r.classList.remove("bg-blue-600","cursor-wait"),r.classList.add("bg-red-600"),r.textContent="‚ùå Audit failed",r.disabled=!0,setTimeout(()=>{r&&(r.classList.remove("bg-red-600"),r.classList.add("bg-red-600","hover:bg-red-700"),r.textContent="Run Lynis Audit",r.disabled=!1)},3e3)),i&&(i.textContent=a,i.className="text-sm text-red-600 mt-2")}}function handleDeepScanUpdate(e){const{type:t,ip:n,message:a}=e,s=`deep-scan-btn-${n.replace(/\./g,"-")}`,o=document.getElementById(s),r=document.getElementById("custom-deep-scan-status"),i=r&&r.dataset.currentIp===n;switch(t){case"deep_scan_started":addConsoleMessage(`üîç ${a}`,"info"),o&&(o.classList.remove("bg-purple-600","hover:bg-purple-700"),o.classList.add("bg-blue-600","cursor-wait"),o.disabled=!0,o.textContent="Scan started",o.dataset.scanStatus="scanning",saveDeepScanButtonState(n)),i&&a&&(r.textContent=a);break;case"deep_scan_progress":if(o){const t=e.event;if("scanning"===t)o.textContent="Scanning...";else if("hostname"===t)o.textContent=a;else if("port_found"===t){const t=e.port;e.service;o.textContent=`Port ${t} found`}o.dataset.scanStatus="scanning",saveDeepScanButtonState(n)}i&&a&&(r.textContent=a);break;case"deep_scan_completed":const t=e.open_ports?e.open_ports.length:0,l=e.scan_duration?e.scan_duration.toFixed(2):"unknown";if(addConsoleMessage(`‚úÖ Deep scan of ${n} complete: ${t} ports found in ${l}s`,"success"),e.open_ports&&e.open_ports.length>0){addConsoleMessage(`   Open ports: ${e.open_ports.slice(0,10).join(", ")}${e.open_ports.length>10?` (+${e.open_ports.length-10} more)`:""}`,"info")}o&&(o.classList.remove("bg-blue-600","cursor-wait"),o.classList.add("bg-green-600"),o.textContent=`‚úÖ ${t} ports`,o.disabled=!0,o.dataset.scanStatus="completed",saveDeepScanButtonState(n),setTimeout(()=>{document.getElementById(s)&&(o.classList.remove("bg-green-600"),o.classList.add("bg-purple-600","hover:bg-purple-700"),o.textContent="Deep Scan",o.disabled=!1,o.dataset.scanStatus="idle",clearDeepScanButtonState(n))},3e3)),i&&(r.textContent=`Scan complete for ${n}: ${t} open ports found.`,r.dataset.currentIp=""),"network"===currentTab&&loadNetworkData();break;case"deep_scan_error":addConsoleMessage(`‚ùå Deep scan error for ${n}: ${a}`,"error"),o&&(o.classList.remove("bg-blue-600","cursor-wait"),o.classList.add("bg-red-600"),o.textContent="‚ùå Error",o.disabled=!0,o.dataset.scanStatus="error",saveDeepScanButtonState(n),setTimeout(()=>{document.getElementById(s)&&(o.classList.remove("bg-red-600"),o.classList.add("bg-purple-600","hover:bg-purple-700"),o.textContent="Deep Scan",o.disabled=!1,o.dataset.scanStatus="idle",clearDeepScanButtonState(n))},3e3)),i&&(r.textContent=a||`Scan error for ${n}.`,r.dataset.currentIp="");break;default:addConsoleMessage(`Deep scan update: ${a}`,"info"),i&&a&&(r.textContent=a)}}let enhancedNetworkScanInterval=null,isEnhancedRealTimeScanning=!1;async function startEnhancedRealTimeScan(){const e=document.getElementById("start-network-scan"),t=document.getElementById("stop-network-scan");if(e&&t)try{addConsoleMessage("Starting enhanced real-time network scanning (ARP + Nmap)...","info"),e.disabled=!0,t.disabled=!1,isEnhancedRealTimeScanning=!0,document.getElementById("scan-progress").classList.remove("hidden"),await performCombinedNetworkScan(),enhancedNetworkScanInterval=setInterval(async()=>{isEnhancedRealTimeScanning&&await performCombinedNetworkScan()},15e3),addConsoleMessage("Enhanced real-time network scanning started","info")}catch(e){console.error("Error starting enhanced real-time scan:",e),addConsoleMessage("Failed to start network scan: "+e.message,"error"),resetEnhancedScanButtons()}}async function stopEnhancedRealTimeScan(){const e=document.getElementById("stop-network-scan"),t=document.getElementById("start-network-scan");enhancedNetworkScanInterval&&(clearInterval(enhancedNetworkScanInterval),enhancedNetworkScanInterval=null),isEnhancedRealTimeScanning=!1,e&&t&&(addConsoleMessage("Stopping enhanced network scan...","info"),resetEnhancedScanButtons())}function resetEnhancedScanButtons(){const e=document.getElementById("start-network-scan"),t=document.getElementById("stop-network-scan");e&&t&&(e.disabled=!1,t.disabled=!0,isEnhancedRealTimeScanning=!1,document.getElementById("scan-progress").classList.add("hidden"))}async function performCombinedNetworkScan(){try{const e=await fetchAPI("/api/scan/combined-network");e.success?(updateNetworkTableWithScanData(e),addConsoleMessage(`Network scan found ${e.count} hosts (ARP: ${e.arp_count}, Nmap: ${e.nmap_count})`,"success")):addConsoleMessage(`Network scan failed: ${e.error}`,"error")}catch(e){console.error("Error performing network scan:",e),addConsoleMessage(`Network scan error: ${e.message}`,"error")}}function updateNetworkTableWithScanData(e){const t=document.getElementById("network-hosts-table"),n=document.getElementById("host-count");if(!t)return;if(t.innerHTML="",!e.hosts||0===Object.keys(e.hosts).length)return t.innerHTML='\n            <tr>\n                <td colspan="8" class="text-center py-8 text-gray-400">\n                    No hosts discovered. Check network connectivity and try again.\n                </td>\n            </tr>\n        ',void(n&&(n.textContent="0 hosts"));const a=Object.values(e.hosts);document.createDocumentFragment();a.forEach(e=>{const n=document.createElement("tr");n.className="border-b border-slate-700 hover:bg-slate-700/50 transition-colors";const a="up"===e.status?'<span class="flex items-center"><div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>Online</span>':'<span class="flex items-center"><div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>Offline</span>';let s=e.mac||"Unknown";e.vendor&&(s+=`<br><span class="text-xs text-gray-400">${e.vendor}</span>`);const o={arp:'<span class="text-xs px-2 py-1 bg-blue-600 rounded">ARP</span>',nmap:'<span class="text-xs px-2 py-1 bg-purple-600 rounded">NMAP</span>',"arp+nmap":'<span class="text-xs px-2 py-1 bg-green-600 rounded">ARP+NMAP</span>'}[e.source]||"";n.innerHTML=`\n            <td class="py-3 px-4">${a}</td>\n            <td class="py-3 px-4 font-mono text-sm">${e.ip}</td>\n            <td class="py-3 px-4">${e.hostname||"Unknown"}</td>\n            <td class="py-3 px-4 font-mono text-xs">${s}</td>\n            <td class="py-3 px-4">\n                <span class="text-xs px-2 py-1 bg-gray-600 rounded">Scanning...</span>\n            </td>\n            <td class="py-3 px-4">\n                <span class="text-xs px-2 py-1 bg-gray-600 rounded">Checking...</span>\n            </td>\n            <td class="py-3 px-4 text-sm text-gray-400">${(new Date).toLocaleTimeString()}</td>\n            <td class="py-3 px-4">\n                <div class="flex space-x-2">\n                    ${o}\n                    <button onclick="scanSingleHostEnhanced('${e.ip}')" \n                            class="text-xs px-2 py-1 bg-Ragnar-600 hover:bg-Ragnar-700 rounded transition-colors">\n                        Scan\n                    </button>\n                </div>\n            </td>\n        `,t.appendChild(n)}),n&&(n.textContent=`${a.length} hosts`)}async function scanSingleHostEnhanced(e){try{addConsoleMessage(`Scanning host ${e}...`,"info");const t=await postAPI("/api/scan/host",{ip:e,scan_type:"full"});t.success?(addConsoleMessage(`Host ${e} scan completed`,"success"),await performCombinedNetworkScan()):addConsoleMessage(`Host ${e} scan failed: ${t.error}`,"error")}catch(e){console.error("Error scanning host:",e),addConsoleMessage(`Host scan error: ${e.message}`,"error")}}function updateScanProgress(){const e=document.getElementById("scan-progress-text"),t=document.getElementById("scan-progress-bar"),n=document.getElementById("current-scan-target"),a=currentScanState.totalHosts>0?currentScanState.scannedHosts/currentScanState.totalHosts*100:0;e&&(e.textContent=`${currentScanState.scannedHosts}/${currentScanState.totalHosts} hosts`),t&&(t.style.width=`${a}%`),n&&(n.textContent=currentScanState.currentTarget?`Currently scanning: ${currentScanState.currentTarget}`:"")}function escapeSelector(e){return window.CSS&&"function"==typeof CSS.escape?CSS.escape(e):e.replace(/([ #;?%&,.+*~\':"!^$\[\]()=>|\/])/g,"\\$1")}function parseCompactTimestamp(e){if(!e)return null;const t=e.replace(/[^0-9]/g,"");if(t.length<8)return null;const n=Number(t.slice(0,4)),a=Number(t.slice(4,6))-1,s=Number(t.slice(6,8)),o=t.length>=10?Number(t.slice(8,10)):0,r=t.length>=12?Number(t.slice(10,12)):0,i=t.length>=14?Number(t.slice(12,14)):0,l=new Date(n,a,s,o,r,i);return Number.isNaN(l.getTime())?null:l}function buildLastScanInfo(e,t){const n={label:"Never",className:"text-gray-400",timestampText:"",tooltip:"",rawStatus:e||"",rawTimestamp:t||""};let a=(e||"").toString().trim(),s=null;if(a.includes("_")){const e=a.split("_");a=e[0];s=parseCompactTimestamp(e.slice(1).join("_"))}if(!s&&t){const e=new Date(t);Number.isNaN(e.getTime())||(s=e)}if(!s&&e){const t=e.replace(/[^0-9]/g,"");if(t.length>=8){const e=parseCompactTimestamp(t);e&&(s=e)}}const o=a.toLowerCase();a?o.startsWith("success")?(n.label="Success",n.className="text-green-400"):o.startsWith("failed")?(n.label="Failed",n.className="text-red-400"):["running","scanning","pending","inprogress","in_progress"].includes(o)?(n.label=a.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),n.className="text-yellow-400"):(n.label=a.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),n.className="text-slate-300"):s?(n.label="Completed",n.className="text-blue-400"):(n.label="Never",n.className="text-gray-400"),s&&(n.timestampText=s.toLocaleString());const r=[];return n.rawStatus&&r.push(`Status: ${n.rawStatus}`),n.timestampText&&r.push(`Completed: ${n.timestampText}`),n.rawTimestamp&&!n.timestampText&&r.push(`Reported: ${n.rawTimestamp}`),n.tooltip=r.join("\n"),n}function normalizeHostRecord(e){if(!e)return null;const t=e.IPs||e.ip||e.address||e.target||"";if(!t)return null;const n=e.Hostnames||e.Hostname||e.hostname||e.name||"",a=e["MAC Address"]||e.MAC||e.mac||"",s=e.Alive??e.alive??e.Status??e.status??"",o=null==s?"":String(s).trim(),r=o.toLowerCase(),i=["1","true","online","up","active","success"].includes(r),l=["0","false","offline","down","inactive","failed"].includes(r);let c="Unknown";i?c="Active":l?c="Inactive":o&&(c=o.charAt(0).toUpperCase()+o.slice(1));const d=i?"text-green-400":l?"text-red-400":"text-yellow-400",u=e.Ports??e.ports??e.port_list??e.open_ports;let p=[];Array.isArray(u)?p=u.map(e=>String(e).trim()).filter(Boolean):"string"==typeof u?p=u.split(/[,;\s]+/).map(e=>e.trim()).filter(Boolean):u&&(p=[String(u).trim()]);const g=(Array.isArray(e.vulnerabilities)?e.vulnerabilities:[]).map(e=>"string"==typeof e?e:e&&"object"==typeof e&&(e.vulnerability||e.raw_output||e.description||e.id)||"").filter(Boolean);let m=e["Nmap Vulnerabilities"]||e.nmap_vulnerabilities||e.vulnerability_summary||"";m||"string"!=typeof e.NmapVulnerabilities||(m=e.NmapVulnerabilities);const f=[...g,..."string"==typeof m&&m.trim()?m.split(";").map(e=>e.trim()).filter(Boolean):[]],h=[],y=new Set;f.forEach(e=>{const t=e.toLowerCase();y.has(t)||(y.add(t),h.push(e))});const b=buildLastScanInfo(e.NmapVulnScanner||e.nmap_vuln_scanner||e.scan_status||"",e.last_scan||e.LastScan||e.last_vuln_scan||"");return{ip:String(t).trim(),hostname:n||"",mac:a||"",ports:p,statusText:c,statusClass:d,vulnerabilityCount:h.length,vulnerabilityPreview:h.slice(0,2).join("; "),vulnerabilityFull:h.join("; "),lastScan:b,raw:e}}function formatPortsCell(e){if(!e||0===e.length)return'<span class="text-gray-400">None</span>';const t=e.slice(0,5),n=escapeHtml(t.join(", ")),a=e.length>5?"‚Ä¶":"";return`<span title="${escapeHtml(e.join(", "))}">${n}${a}</span>`}function formatVulnerabilityCell(e){if(!e||0===e.vulnerabilityCount)return'<span class="text-gray-400">None</span>';const t=`${e.vulnerabilityCount} ${1===e.vulnerabilityCount?"issue":"issues"}`,n=e.vulnerabilityFull||e.vulnerabilityPreview||t,a=escapeHtml(n);return`<span class="text-red-400 font-medium" title="${a}">${t}</span>${e.vulnerabilityPreview?`<div class="text-xs text-slate-300 truncate max-w-xs" title="${a}">${escapeHtml(e.vulnerabilityPreview)}</div>`:""}`}function formatLastScanCell(e){if(!e)return'<span class="text-gray-400">Never</span>';const t=e.tooltip?` title="${escapeHtml(e.tooltip)}"`:"",n=e.timestampText?`<div class="text-xs text-gray-400">${escapeHtml(e.timestampText)}</div>`:"";return`<div${t}><span class="${e.className}">${escapeHtml(e.label)}</span>${n}</div>`}function renderHostRow(e){const t=e.hostname?escapeHtml(e.hostname):"Unknown",n=e.mac?escapeHtml(e.mac):"Unknown",a=escapeHtml(e.ip),s=e.statusClass.includes("green"),o=e.statusClass.includes("red"),r=`<span class="inline-block w-2 h-2 rounded-full ${s?"bg-green-500":o?"bg-red-500":"bg-yellow-500"} mr-1"></span>`;return`\n        <td class="py-3 px-4" data-label="Status">\n            <span class="px-2 py-1 rounded text-xs ${e.statusClass} flex items-center">\n                ${r}${escapeHtml(e.statusText)}\n            </span>\n        </td>\n        <td class="py-3 px-4 font-mono" data-label="IP Address">${a}</td>\n        <td class="py-3 px-4" data-label="Hostname">${t||"Unknown"}</td>\n        <td class="py-3 px-4 font-mono text-sm" data-label="MAC Address">${n||"Unknown"}</td>\n        <td class="py-3 px-4 text-sm" data-label="Open Ports">${formatPortsCell(e.ports)}</td>\n        <td class="py-3 px-4 text-sm" data-label="Vulnerabilities">${formatVulnerabilityCell(e)}</td>\n        <td class="py-3 px-4 text-sm" data-label="Last Scan">${formatLastScanCell(e.lastScan)}</td>\n        <td class="py-3 px-4" data-label="Actions">\n                <button onclick="triggerDeepScan('${e.ip}', { mode: 'full' })" \n                    id="deep-scan-btn-${e.ip.replace(/\./g,"-")}"\n                    data-scan-status="idle"\n                    class="deep-scan-button bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded transition-all duration-300"\n                    title="Scan all 65535 ports with TCP connect (-sT). IP: ${e.ip}">\n                Deep Scan\n            </button>\n        </td>\n    `}function updateHostCountDisplay(){const e=document.getElementById("network-hosts-table"),t=document.getElementById("host-count");if(!e||!t)return;const n=e.querySelectorAll("tr[data-ip]").length;t.textContent=`${n} host${1!==n?"s":""}`}function updateHostInTable(e){const t=document.getElementById("network-hosts-table");if(!t)return;const n=normalizeHostRecord(e);if(!n)return;const a=t.querySelector('td[colspan="8"]');a&&a.parentElement.remove();const s=`tr[data-ip="${escapeSelector(n.ip)}"]`;let o=t.querySelector(s);o&&saveDeepScanButtonState(n.ip),o||(o=document.createElement("tr"),o.setAttribute("data-ip",n.ip),o.className="border-b border-slate-700 hover:bg-slate-700/50 transition-colors",t.appendChild(o)),o.innerHTML=renderHostRow(n),restoreDeepScanButtonState(n.ip),updateHostCountDisplay()}async function scanSingleHost(e){try{if(!(await fetch("/api/scan/host",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ip:e})})).ok)throw new Error("Failed to start host scan");addConsoleMessage(`Started scan of ${e}`,"info")}catch(t){console.error("Error scanning host:",t),addConsoleMessage(`Failed to scan ${e}: ${t.message}`,"error")}}async function loadCredentialsData(){try{displayCredentialsTable(await fetchAPI("/api/credentials"))}catch(e){console.error("Error loading credentials:",e)}}async function loadLootData(){try{displayLootTable(await fetchAPI("/api/loot"))}catch(e){console.error("Error loading loot data:",e)}}let currentAttackFilter="all",attackLogsCache=null,attackLogsETag=null,attackLogsInFlight=null;async function loadAttackLogs(e={}){const{force:t=!1}=e;if(attackLogsInFlight)return attackLogsInFlight;const n={};return!t&&attackLogsETag&&(n["If-None-Match"]=attackLogsETag),attackLogsCache||(document.getElementById("attack-logs-container").innerHTML='\n            <div class="text-center text-gray-400 py-8">\n                <svg class="w-8 h-8 inline animate-spin mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n                </svg>\n                <p>Loading attack logs...</p>\n            </div>\n        '),attackLogsInFlight=(async()=>{try{const e=await fetch("/api/attack?limit=200&days=7",{headers:n});if(304===e.status)return console.debug("Attack logs unchanged; skipping DOM update"),attackLogsCache;if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();return attackLogsCache=t,attackLogsETag=e.headers.get("ETag")||attackLogsETag,displayAttackLogs(t),t}catch(e){return console.error("Error loading attack logs:",e),attackLogsCache||(document.getElementById("attack-logs-container").innerHTML=`\n                    <div class="text-center text-red-400 py-8">\n                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                        </svg>\n                        <p>Error loading attack logs</p>\n                        <p class="text-sm text-gray-500 mt-2">${e.message}</p>\n                    </div>\n                `),attackLogsCache}finally{attackLogsInFlight=null}})(),attackLogsInFlight}function filterAttackLogs(e){currentAttackFilter=e,document.querySelectorAll(".attack-filter-btn").forEach(t=>{t.getAttribute("data-filter")===e?t.classList.add("ring-2","ring-white"):t.classList.remove("ring-2","ring-white")}),attackLogsCache&&displayAttackLogs(attackLogsCache)}async function refreshAttackLogs(){await loadAttackLogs({force:!0})}function displayAttackLogs(e){if(!e||!e.attack_logs)return void(document.getElementById("attack-logs-container").innerHTML='\n            <div class="text-center text-gray-400 py-8">\n                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>\n                </svg>\n                <p>No attack logs found</p>\n            </div>\n        ');document.getElementById("attack-stat-total").textContent=e.total_count||0,document.getElementById("attack-stat-success").textContent=e.success_count||0,document.getElementById("attack-stat-failed").textContent=e.failed_count||0;const t=e.attack_logs.filter(e=>"timeout"===e.status).length;document.getElementById("attack-stat-timeout").textContent=t;let n=e.attack_logs;if("all"!==currentAttackFilter&&(n=n.filter(e=>e.status===currentAttackFilter)),0===n.length)return void(document.getElementById("attack-logs-container").innerHTML=`\n            <div class="text-center text-gray-400 py-8">\n                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>\n                </svg>\n                <p>No ${"all"===currentAttackFilter?"":currentAttackFilter} attacks found</p>\n            </div>\n        `);const a={};n.forEach(e=>{const t=e.target_ip||"Unknown";a[t]||(a[t]=[]),a[t].push(e)});const s=Object.keys(a).sort();let o='<div class="space-y-4">';s.forEach(e=>{const t=a[e],n=t.filter(e=>"success"===e.status).length,s=t.filter(e=>"failed"===e.status).length,r=t.filter(e=>"timeout"===e.status).length;o+=`\n            <div class="bg-slate-800 bg-opacity-50 rounded-lg border border-slate-700 overflow-hidden">\n                <div class="px-4 py-3 bg-slate-900 bg-opacity-50 flex items-center justify-between cursor-pointer hover:bg-opacity-70 transition-colors" onclick="toggleAttackHost('${e}')">\n                    <div class="flex items-center space-x-3">\n                        <svg class="w-5 h-5 text-Ragnar-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>\n                        </svg>\n                        <span class="font-semibold text-lg">${e}</span>\n                        <span class="text-sm text-gray-400">(${t.length} attacks)</span>\n                    </div>\n                    <div class="flex items-center space-x-4">\n                        <span class="text-sm text-green-400">‚úì ${n}</span>\n                        <span class="text-sm text-red-400">‚úó ${s}</span>\n                        <span class="text-sm text-yellow-400">‚è± ${r}</span>\n                        <svg id="attack-chevron-${e.replace(/\./g,"-")}" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>\n                        </svg>\n                    </div>\n                </div>\n                <div id="attack-host-${e.replace(/\./g,"-")}" class="hidden px-4 py-3 space-y-2">\n        `,t.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),t.forEach(e=>{const t={success:"bg-green-900 bg-opacity-30 border-green-500",failed:"bg-red-900 bg-opacity-30 border-red-500",timeout:"bg-yellow-900 bg-opacity-30 border-yellow-500"}[e.status]||"bg-gray-900 bg-opacity-30 border-gray-500",n={success:"‚úì",failed:"‚úó",timeout:"‚è±"}[e.status]||"‚Ä¢",a={success:"text-green-400",failed:"text-red-400",timeout:"text-yellow-400"}[e.status]||"text-gray-400";o+=`\n                <div class="border-l-4 ${t} p-3 rounded-r-lg">\n                    <div class="flex items-start justify-between">\n                        <div class="flex-1">\n                            <div class="flex items-center space-x-2 mb-1">\n                                <span class="font-semibold ${a}">${n} ${e.attack_type}</span>\n                                ${e.target_port?`<span class="text-xs text-gray-400">Port ${e.target_port}</span>`:""}\n                                <span class="text-xs text-gray-500">${e.timestamp}</span>\n                            </div>\n                            ${e.message?`<p class="text-sm text-gray-300 mb-2">${escapeHtml(e.message)}</p>`:""}\n                            ${Object.keys(e.details||{}).length>0?`\n                                <div class="text-xs space-y-1 mt-2">\n                                    ${Object.entries(e.details).map(([e,t])=>`\n                                        <div class="flex items-center space-x-2">\n                                            <span class="text-gray-500">${e}:</span>\n                                            <span class="text-gray-300 font-mono">${escapeHtml(String(t))}</span>\n                                        </div>\n                                    `).join("")}\n                                </div>\n                            `:""}\n                        </div>\n                    </div>\n                </div>\n            `}),o+="\n                </div>\n            </div>\n        "}),o+="</div>",document.getElementById("attack-logs-container").innerHTML=o}function toggleAttackHost(e){const t=`attack-host-${e.replace(/\./g,"-")}`,n=`attack-chevron-${e.replace(/\./g,"-")}`,a=document.getElementById(t),s=document.getElementById(n);a.classList.contains("hidden")?(a.classList.remove("hidden"),s.classList.add("rotate-180")):(a.classList.add("hidden"),s.classList.remove("rotate-180"))}async function loadVulnerabilityIntel(){try{const e=document.getElementById("vulnerability-intel-container");e.innerHTML='\n            <div class="text-center text-gray-400 py-8">\n                <svg class="w-8 h-8 inline animate-spin mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n                </svg>\n                <p>Loading service intelligence...</p>\n            </div>\n        ';const t=await fetchAPI("/api/vulnerability-intel");if(!t)return void(e.innerHTML='\n                <div class="text-center text-red-400 py-8">\n                    <p>Error loading service intelligence</p>\n                </div>\n            ');document.getElementById("intel-stat-scanned").textContent=t.statistics.total_scanned||0,document.getElementById("intel-stat-interesting").textContent=t.statistics.interesting_hosts||0,document.getElementById("intel-stat-services").textContent=t.statistics.services_with_intel||0,document.getElementById("intel-stat-scripts").textContent=t.statistics.script_outputs||0,displayVulnerabilityIntel(t.scans)}catch(e){console.error("Error loading vulnerability intelligence:",e);document.getElementById("vulnerability-intel-container").innerHTML=`\n            <div class="text-center text-red-400 py-8">\n                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <p>Error loading service intelligence</p>\n                <p class="text-sm text-gray-500 mt-2">${e.message}</p>\n            </div>\n        `}}function displayVulnerabilityIntel(e){const t=document.getElementById("vulnerability-intel-container");if(!e||0===e.length)return void(t.innerHTML='\n            <div class="text-center text-gray-400 py-8">\n                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>\n                </svg>\n                <p>No interesting intelligence found</p>\n                <p class="text-sm text-gray-500 mt-2">Scanned hosts without interesting data are filtered out</p>\n            </div>\n        ');let n='<div class="space-y-4">';e.forEach(e=>{const t=e.total_services||0,a=e.services.reduce((e,t)=>e+(t.scripts?.length||0),0);n+=`\n            <div class="bg-slate-800 bg-opacity-50 rounded-lg border border-slate-700 overflow-hidden">\n                <div class="px-4 py-3 bg-slate-900 bg-opacity-50 flex items-center justify-between cursor-pointer hover:bg-opacity-70 transition-colors" onclick="toggleVulnHost('${e.ip}')">\n                    <div class="flex items-center space-x-3">\n                        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                        </svg>\n                        <div>\n                            <div class="font-semibold text-lg">${escapeHtml(e.hostname)}</div>\n                            <div class="text-sm text-gray-400">${escapeHtml(e.ip)}</div>\n                        </div>\n                    </div>\n                    <div class="flex items-center space-x-4">\n                        ${e.download_url?`\n                            <a href="${e.download_url}" target="_blank" rel="noopener noreferrer"\n                               class="text-xs px-3 py-1 rounded-full bg-cyan-900/60 text-cyan-200 border border-cyan-500/40 hover:bg-cyan-800/80 transition">\n                                ${"lynis"===e.scan_type?"Download full report":"View full report"}\n                            </a>\n                        `:""}\n                        ${e.log_url&&e.log_url!==e.download_url?`\n                            <a href="${e.log_url}" target="_blank" rel="noopener noreferrer"\n                               class="text-xs px-3 py-1 rounded-full bg-slate-900/60 text-slate-200 border border-slate-500/40 hover:bg-slate-800/80 transition">\n                                View audit log\n                            </a>\n                        `:""}\n                        <span class="text-sm text-cyan-400">üì° ${t} services</span>\n                        ${a>0?`<span class="text-sm text-purple-400">üìú ${a} scripts</span>`:""}\n                        <span class="text-xs text-gray-500">${e.scan_date}</span>\n                        <svg id="vuln-chevron-${e.ip.replace(/\./g,"-")}" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>\n                        </svg>\n                    </div>\n                </div>\n                \n                <div id="vuln-host-${e.ip.replace(/\./g,"-")}" class="hidden px-4 py-3 border-t border-slate-700">\n                    <div class="space-y-3">\n                        ${e.services.sort((e,t)=>{const n="system"===e.port||"lynis pentest"===e.service,a="system"===t.port||"lynis pentest"===t.service;if(n&&!a)return-1;if(!n&&a)return 1;if(!n&&!a){return(parseInt(e.port)||99999)-(parseInt(t.port)||99999)}return 0}).map(e=>{const t=e.scripts&&e.scripts.length>0,n="system"===e.port||"lynis pentest"===e.service;return`\n                                <div class="${n?"bg-blue-900 bg-opacity-30 border border-blue-500/30":"bg-slate-700 bg-opacity-50"} rounded-lg p-4">\n                                    <div class="flex items-start justify-between mb-2">\n                                        <div class="flex-1">\n                                            <div class="flex items-center space-x-2 mb-1">\n                                                ${n?'<svg class="w-4 h-4 text-blue-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>\n                                                    </svg>\n                                                    <span class="font-semibold text-blue-200">üñ•Ô∏è System Audit</span>':`<span class="font-semibold text-white">${escapeHtml(e.port)}</span>`}\n                                                <span class="text-sm ${n?"text-blue-300":"text-gray-400"}">${escapeHtml(e.service)}</span>\n                                            </div>\n                                            ${e.version?`\n                                                <div class="text-sm text-cyan-300 font-mono bg-slate-900 bg-opacity-50 px-2 py-1 rounded inline-block">\n                                                    ${escapeHtml(e.version)}\n                                                </div>\n                                            `:""}\n                                        </div>\n                                    </div>\n                                    \n                                    ${t?`\n                                        <div class="mt-3 space-y-2">\n                                            ${e.scripts.map(e=>`\n                                                <div class="bg-slate-900 bg-opacity-50 rounded p-3">\n                                                    <div class="text-sm font-semibold text-purple-400 mb-2">\n                                                        üìú ${escapeHtml(e.name)}\n                                                    </div>\n                                                    <pre class="text-xs text-gray-300 font-mono whitespace-pre-wrap overflow-x-auto max-h-96 scrollbar-thin">${escapeHtml(e.output)}</pre>\n                                                </div>\n                                            `).join("")}\n                                        </div>\n                                    `:""}\n                                </div>\n                            `}).join("")}\n                    </div>\n                </div>\n            </div>\n        `}),n+="</div>",t.innerHTML=n}function toggleVulnHost(e){const t=`vuln-host-${e.replace(/\./g,"-")}`,n=`vuln-chevron-${e.replace(/\./g,"-")}`,a=document.getElementById(t),s=document.getElementById(n);a.classList.contains("hidden")?(a.classList.remove("hidden"),s.classList.add("rotate-180")):(a.classList.add("hidden"),s.classList.remove("rotate-180"))}async function refreshVulnerabilityIntel(){showNotification("Refreshing service intelligence...","info"),await loadVulnerabilityIntel()}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function loadConfigData(){try{const e=await fetchAPI("/api/config");displayConfigForm(e),loadAIConfiguration(e),await loadHardwareProfiles(),displayCurrentProfile(e),updateVulnerabilityCount(),await refreshPwnagotchiStatus({silent:!0}),checkForUpdates()}catch(e){console.error("Error loading config:",e)}}function setPwnStatusPollInterval(e=15e3){const t=Math.max(2e3,e||15e3);currentPwnStatusInterval===t&&autoRefreshIntervals.pwn||(autoRefreshIntervals.pwn&&clearInterval(autoRefreshIntervals.pwn),currentPwnStatusInterval=t,autoRefreshIntervals.pwn=setInterval(()=>{"config"!==currentTab&&"discovered"!==currentTab||refreshPwnagotchiStatus({silent:!0})},t))}function initializePwnUI(){if(!document.getElementById("pwn-status-badge"))return;const e=document.getElementById("pwn-install-btn");e&&e.addEventListener("click",handlePwnInstallClick);const t=document.getElementById("pwn-swap-to-pwn-btn");t&&t.addEventListener("click",()=>handlePwnSwap("pwnagotchi"));const n=document.getElementById("pwn-refresh-btn");n&&n.addEventListener("click",()=>refreshPwnagotchiStatus());const a=document.getElementById("pwn-log-refresh-btn");a&&a.addEventListener("click",()=>fetchPwnLogs({initial:0===pwnLogCursor})),updatePwnButtons(),resetPwnLogState(),refreshPwnagotchiStatus({silent:!0})}async function refreshPwnagotchiStatus(e={}){const t=Boolean(e&&e.silent);try{const e=await fetchAPI("/api/pwnagotchi/status");if(e&&e.success&&e.status)return updatePwnagotchiUI(e.status),e.status;t||addConsoleMessage("Unable to load Pwnagotchi status","warning")}catch(e){console.error("Error refreshing Pwnagotchi status:",e),t||addConsoleMessage(`Pwnagotchi status error: ${e.message}`,"error")}return null}function updatePwnagotchiUI(e={}){if(!e||"object"!=typeof e)return;const t=Boolean(pwnStatus.installing);pwnStatus={...pwnStatus,...e},pwnStatus.installing=Boolean(pwnStatus.installing);const n=getPwnStateVisuals(pwnStatus),a=document.getElementById("pwn-status-badge");a&&(a.textContent=n.badgeText,a.className=`text-xs font-semibold uppercase tracking-wide px-3 py-1 rounded-full ${n.badgeClass}`),updateElement("pwn-status-message",pwnStatus.message||"Waiting for status...");const s=formatPwnModeLabel(pwnStatus.mode);updateElement("pwn-mode-value",s);const o=document.getElementById("pwn-mode-value");o&&(o.className="font-semibold "+("pwnagotchi"===pwnStatus.mode?"text-fuchsia-300":"text-green-400")),updateElement("pwn-target-value",formatPwnModeLabel(pwnStatus.target_mode)),updateElement("pwn-phase-value",formatPwnPhaseLabel(pwnStatus.phase)),updateElement("pwn-service-state",pwnStatus.service_active?"Running":"Stopped");const r=document.getElementById("pwn-service-state");r&&(r.className="font-semibold "+(pwnStatus.service_active?"text-green-400":"text-slate-200")),updateElement("pwn-service-enabled",pwnStatus.service_enabled?"Enabled":"Disabled");const i=document.getElementById("pwn-service-enabled");i&&(i.className="font-semibold "+(pwnStatus.service_enabled?"text-green-300":"text-slate-200")),updateElement("pwn-last-switch-value",pwnStatus.last_switch?formatTimestamp(pwnStatus.last_switch):"Never"),updateElement("pwn-last-updated",pwnStatus.timestamp?formatTimestamp(pwnStatus.timestamp):(new Date).toLocaleString());const l=document.getElementById("pwn-status-alert");l&&(pwnStatus.message?(l.className=`mt-4 p-4 rounded-lg border text-sm text-gray-200 ${n.alertClass}`,l.innerHTML=`\n                <div class="flex items-start gap-3">\n                    <div class="text-xl">${n.icon}</div>\n                    <div>\n                        <p class="font-semibold">${escapeHtml(pwnStatus.message)}</p>\n                        <p class="text-xs text-gray-300 mt-1">Phase: ${formatPwnPhaseLabel(pwnStatus.phase)} | Mode: ${s}</p>\n                    </div>\n                </div>\n            `,l.classList.remove("hidden")):l.classList.add("hidden")),updatePwnDiscoveredCard(pwnStatus,n),updatePwnButtons(),pwnStatus.installing&&!t&&resetPwnLogState("Installer output will stream here during installation."),ensurePwnLogStreamingForStatus(pwnStatus),lastPwnState=pwnStatus.state}function updatePwnButtons(){const e=document.getElementById("pwn-install-btn");if(e){const t=pwnStatus.installed?"Reinstall Pwnagotchi":"Install Pwnagotchi";e.textContent=pwnStatus.installing?"Installing...":t,e.disabled=pwnStatus.installing,e.classList.toggle("opacity-70",pwnStatus.installing),e.classList.toggle("cursor-not-allowed",pwnStatus.installing)}const t=document.getElementById("pwn-swap-to-pwn-btn");if(t){const e="switching"===pwnStatus.state,n=e&&"pwnagotchi"===pwnStatus.target_mode,a=!pwnStatus.installed||pwnStatus.installing||e;t.disabled=a,t.textContent=n?"Switch Scheduled...":"Switch to Pwnagotchi",t.classList.toggle("opacity-60",a),t.classList.toggle("cursor-not-allowed",a)}const n=document.getElementById("pwn-swap-hint");if(n){let e="Ragnar UI becomes unavailable once the service stops. Plan to reboot via SSH to come back.";pwnStatus.installed?pwnStatus.installing?e="Installer is still running. Swapping will be available once it completes.":"switching"===pwnStatus.state&&(e="Switch scheduled. Wait for the service hand-off to complete before sending another request."):e="Install Pwnagotchi first to enable service swapping.",n.textContent=e}}function updatePwnDiscoveredCard(e,t=null){if(!e||"object"!=typeof e)return;const n=document.getElementById("pwn-discovered-card");if(!n)return;if(!arePwnFeaturesEnabled())return void n.classList.add("hidden");if(!Boolean(e.installing||e.installed))return void n.classList.add("hidden");n.classList.remove("hidden");const a=t||getPwnStateVisuals(e),s=document.getElementById("pwn-card-badge");s&&(s.textContent=a.badgeText,s.className=`text-xs font-semibold uppercase tracking-wide px-3 py-1 rounded-full ${a.badgeClass}`),updateElement("pwn-card-message",e.message||"Waiting for status...");const o=document.getElementById("pwn-card-mode");o&&(o.textContent=formatPwnModeLabel(e.mode),o.className="text-xl font-semibold "+("pwnagotchi"===e.mode?"text-fuchsia-300":"text-green-400")),updateElement("pwn-card-phase",formatPwnPhaseLabel(e.phase));const r=document.getElementById("pwn-card-service");r&&(r.textContent=e.service_active?"Running":"Stopped",r.className="text-xl font-semibold "+(e.service_active?"text-green-400":"text-slate-200"));const i=document.getElementById("pwn-card-enabled");i&&(i.textContent=e.service_enabled?"Yes":"No",i.className=e.service_enabled?"text-green-300 font-semibold":"text-slate-200 font-semibold"),updateElement("pwn-card-target",formatPwnModeLabel(e.target_mode)),updateElement("pwn-card-last-switch",e.last_switch?formatTimestamp(e.last_switch):"Never"),updateElement("pwn-card-updated",`Updated: ${e.timestamp?formatTimestamp(e.timestamp):(new Date).toLocaleString()}`)}function resetPwnLogState(e){pwnLogCursor=0,pwnLogActiveFile=null,clearPwnLogViewer(e||"Installer output will stream here during installation."),updatePwnLogPath(null),setPwnLogIndicator(!1)}function clearPwnLogViewer(e){const t=document.getElementById("pwn-log-viewer"),n=document.getElementById("pwn-log-empty");t&&n&&(t.querySelectorAll('[data-pwn-log-line="true"]').forEach(e=>e.remove()),e&&(n.textContent=e),n.classList.remove("hidden"))}function setPwnLogIndicator(e){const t=document.getElementById("pwn-log-stream-indicator");t&&t.classList.toggle("hidden",!e)}function updatePwnLogPath(e){const t=document.getElementById("pwn-log-path");t&&(e?(t.textContent=e,t.classList.remove("text-gray-500")):(t.textContent="Log path will appear once the installer starts.",t.classList.add("text-gray-500")))}function appendPwnLogEntries(e=[]){const t=document.getElementById("pwn-log-viewer");if(!t||!Array.isArray(e)||0===e.length)return;const n=document.getElementById("pwn-log-empty");n&&n.classList.add("hidden");const a=t.scrollHeight-t.clientHeight-t.scrollTop<40;e.forEach(e=>{const n=document.createElement("div");n.dataset.pwnLogLine="true",n.className=`whitespace-pre-wrap break-words leading-snug ${getPwnLogLineClass(e)}`,n.textContent=e||" ",t.appendChild(n)}),trimPwnLogBuffer(),a&&(t.scrollTop=t.scrollHeight)}function trimPwnLogBuffer(e=600){const t=document.getElementById("pwn-log-viewer");if(!t)return;const n=t.querySelectorAll('[data-pwn-log-line="true"]');if(n.length<=e)return;const a=n.length-e;for(let e=0;e<a;e++)n[e].remove()}function getPwnLogLineClass(e=""){const t=e.toLowerCase();return t.includes("error")||t.includes("failed")||t.includes("[err")?"text-red-300":t.includes("warn")?"text-yellow-200":t.includes("info")||t.includes("[info")?"text-blue-200":"text-gray-200"}function startPwnLogStreaming(e={}){document.getElementById("pwn-log-viewer")&&(pwnLogStreamTimer||(pwnLogStopTimeout&&(clearTimeout(pwnLogStopTimeout),pwnLogStopTimeout=null),pwnLogStreaming=!0,setPwnLogIndicator(!0),fetchPwnLogs({initial:Boolean(e.initial)||0===pwnLogCursor,silent:!0}),pwnLogStreamTimer=setInterval(()=>fetchPwnLogs({silent:!0}),2500)))}function stopPwnLogStreaming(){pwnLogStreamTimer&&(clearInterval(pwnLogStreamTimer),pwnLogStreamTimer=null),pwnLogStreaming=!1,setPwnLogIndicator(!1)}function schedulePwnLogStop(){pwnLogStopTimeout||(pwnLogStopTimeout=setTimeout(()=>{stopPwnLogStreaming(),pwnLogStopTimeout=null},12e3))}function setPwnLogEmptyMessage(e){const t=document.getElementById("pwn-log-empty");t&&(t.textContent=e,t.classList.remove("hidden"))}async function fetchPwnLogs(e={}){if(pwnLogFetchInFlight)return;if(document.getElementById("pwn-log-viewer")){pwnLogFetchInFlight=!0;try{const t=new URLSearchParams;pwnLogCursor>0&&!e.initial?t.set("cursor",pwnLogCursor.toString()):t.set("tail","8192");const n=await fetchAPI(`/api/pwnagotchi/logs?${t.toString()}`);if(!n||!1===n.success)return e.silent||setPwnLogEmptyMessage(n&&n.error?n.error:"Installer log not available yet"),void(n&&n.installing||schedulePwnLogStop());"number"==typeof n.cursor&&(pwnLogCursor=n.cursor),n.file&&n.file!==pwnLogActiveFile&&(pwnLogActiveFile=n.file,clearPwnLogViewer("Streaming installer output‚Ä¶"),updatePwnLogPath(n.file)),Array.isArray(n.entries)&&n.entries.length>0?appendPwnLogEntries(n.entries):e.silent||pwnLogStreaming||setPwnLogEmptyMessage("No installer activity yet."),n.installing||schedulePwnLogStop()}catch(t){console.error("Error fetching Pwnagotchi logs:",t),e.silent||setPwnLogEmptyMessage(`Failed to load installer log (${t.message})`)}finally{pwnLogFetchInFlight=!1}}}function ensurePwnLogStreamingForStatus(e){e&&(e.log_file&&e.log_file!==pwnLogActiveFile&&(pwnLogActiveFile=e.log_file,updatePwnLogPath(e.log_file)),e.installing?(setPwnStatusPollInterval(4e3),startPwnLogStreaming({initial:0===pwnLogCursor})):(setPwnStatusPollInterval(15e3),pwnLogStreaming&&schedulePwnLogStop()))}function getPwnStateVisuals(e){const t=(e.state||"not_installed").toLowerCase();return t.includes("fail")||t.includes("error")?{badgeText:"Error",badgeClass:"bg-red-700 text-red-100",alertClass:"border-red-500 bg-red-900/30",icon:"‚ö†Ô∏è"}:e.installing||["preflight","dependencies","python","installing"].includes(t)?{badgeText:"Installing",badgeClass:"bg-yellow-700 text-yellow-100",alertClass:"border-yellow-500 bg-yellow-900/30",icon:"‚è≥"}:"switching"===t?{badgeText:"Switching",badgeClass:"bg-orange-700 text-orange-100",alertClass:"border-orange-500 bg-orange-900/30",icon:"üîÑ"}:"running"===t?{badgeText:"Running",badgeClass:"bg-green-700 text-green-100",alertClass:"border-green-500 bg-green-900/30",icon:"‚úÖ"}:"installed"===t?{badgeText:"Installed",badgeClass:"bg-blue-700 text-blue-100",alertClass:"border-blue-500 bg-blue-900/30",icon:"‚ÑπÔ∏è"}:{badgeText:"Not Installed",badgeClass:"bg-slate-700 text-slate-200",alertClass:"border-slate-700 bg-slate-900",icon:"‚ÑπÔ∏è"}}function formatPwnStateLabel(e){return e?e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()):"Unknown"}function formatPwnModeLabel(e){return"pwnagotchi"===e?"Pwnagotchi":"Ragnar"}function formatPwnPhaseLabel(e){return e?e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()):"Idle"}async function handlePwnInstallClick(){if(pwnStatus.installing)return void addConsoleMessage("Pwnagotchi installer already running","warning");const e=document.getElementById("pwn-install-btn");e&&(e.disabled=!0,e.textContent="Starting installer...",e.classList.add("opacity-70","cursor-not-allowed")),resetPwnLogState("Installer requested. Waiting for output..."),startPwnLogStreaming({initial:!0});try{const e=await postPwnAPI("/api/pwnagotchi/install",{});addConsoleMessage("Pwnagotchi installer started","success"),e&&e.status?updatePwnagotchiUI(e.status):refreshPwnagotchiStatus({silent:!0})}catch(e){console.error("Failed to start Pwnagotchi installer:",e),addConsoleMessage(`Install failed: ${e.message}`,"error"),stopPwnLogStreaming(),setPwnLogEmptyMessage("Installer failed to start. Check Ragnar logs for details.")}finally{updatePwnButtons()}}async function handlePwnSwap(e){const t="pwnagotchi"===e?"pwnagotchi":"ragnar";if("pwnagotchi"===t&&!pwnStatus.installed)return void addConsoleMessage("Install Pwnagotchi before swapping","warning");const n="pwnagotchi"===t?"pwn-swap-to-pwn-btn":"pwn-swap-to-ragnar-btn",a=document.getElementById(n);a&&(a.disabled=!0,a.textContent="Scheduling switch...",a.classList.add("opacity-60","cursor-not-allowed"));try{const e=await postPwnAPI("/api/pwnagotchi/swap",{target:t});addConsoleMessage(e&&e.message?e.message:`Switch scheduled to ${formatPwnModeLabel(t)}`,"info"),e&&e.status?updatePwnagotchiUI(e.status):refreshPwnagotchiStatus({silent:!0})}catch(e){console.error("Failed to schedule Pwnagotchi swap:",e),addConsoleMessage(`Swap failed: ${e.message}`,"error")}finally{updatePwnButtons()}}async function postPwnAPI(e,t={}){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});let a=null;try{a=await n.json()}catch(e){a=null}if(!n.ok||a&&!1===a.success){const e=a&&(a.error||a.message)?a.error||a.message:`Request failed (${n.status})`;throw new Error(e)}return a||{success:!0}}async function loadConnectData(){try{await loadWifiInterfaces(),console.log("Loading connect tab, refreshing connectivity status..."),await Promise.all([refreshWifiStatus(),refreshBluetoothStatus()])}catch(e){console.error("Error loading connect data:",e)}}async function loadFilesData(){try{displayDirectoryTree(),loadFiles("/")}catch(e){console.error("Error loading files data:",e)}}function arePwnFeaturesEnabled(){return"true"===localStorage.getItem("pwnagotchi-enabled")}function applyPwnVisibilityPreference(e){const t=document.getElementById("pwnagotchi-section");t&&(t.style.display=e?"block":"none"),updatePwnDiscoveredCard(pwnStatus)}function togglePwnagotchiVisibility(){const e=document.getElementById("pwnagotchi-enabled");if(!e)return;if(e.disabled)return void(e.checked=!1);const t=e.checked;localStorage.setItem("pwnagotchi-enabled",t?"true":"false"),applyPwnVisibilityPreference(t)}function initializePwnagotchiVisibility(){const e=document.getElementById("pwnagotchi-enabled");if(!e)return;const t=arePwnFeaturesEnabled();e.checked=t,applyPwnVisibilityPreference(t)}function updatePwnToggleAvailability(e){headlessMode=Boolean(e);const t=document.getElementById("pwnagotchi-enabled");if(!t)return;const n=document.getElementById("pwn-toggle-wrapper"),a=document.getElementById("pwn-headless-warning");headlessMode?(t.checked&&(t.checked=!1,localStorage.setItem("pwnagotchi-enabled","false"),applyPwnVisibilityPreference(!1)),t.disabled=!0,t.setAttribute("aria-disabled","true"),n&&n.classList.add("cursor-not-allowed","opacity-60","pointer-events-none"),a&&a.classList.remove("hidden")):(t.disabled=!1,t.removeAttribute("aria-disabled"),n&&n.classList.remove("cursor-not-allowed","opacity-60","pointer-events-none"),a&&a.classList.add("hidden"))}async function loadHardwareProfiles(){try{const e=await fetchAPI("/api/config/hardware-profiles"),t=document.getElementById("hardware-profile-select");document.getElementById("apply-profile-btn");if(!t)return;t.innerHTML='<option value="">Select a hardware profile...</option>',window.hardwareProfiles=e;for(const[n,a]of Object.entries(e)){const e=document.createElement("option");e.value=n,e.textContent=`${a.name} (${a.ram}MB RAM)`,t.appendChild(e)}t.addEventListener("change",function(){const t=this.value,n=document.getElementById("apply-profile-btn");t&&e[t]?(showProfileDetails(e[t]),n.disabled=!1):(hideProfileDetails(),n.disabled=!0)})}catch(e){console.error("Error loading hardware profiles:",e),addConsoleMessage("Failed to load hardware profiles","error");const t=document.getElementById("hardware-profile-select");t&&(t.innerHTML='<option value="">Error loading profiles</option>')}}function showProfileDetails(e){const t=document.getElementById("profile-details");t&&(document.getElementById("profile-description").textContent=e.description||"No description available",document.getElementById("profile-ram").textContent=`${e.ram}MB`,document.getElementById("profile-threads").textContent=e.settings.scanner_max_threads||"N/A",document.getElementById("profile-concurrent").textContent=e.settings.orchestrator_max_concurrent||"N/A",document.getElementById("profile-speed").textContent=e.settings.nmap_scan_aggressivity||"N/A",t.classList.remove("hidden"))}function hideProfileDetails(){const e=document.getElementById("profile-details");e&&e.classList.add("hidden")}async function applySelectedProfile(){const e=document.getElementById("hardware-profile-select").value;e?await confirmApplyProfile(e,window.hardwareProfiles[e]):addConsoleMessage("Please select a hardware profile first","warning")}async function detectAndApplyHardware(){try{addConsoleMessage("Detecting hardware...","info");const e=document.getElementById("hardware-detection-info");e.innerHTML='<span class="text-Ragnar-400">üîç Detecting hardware...</span>';const t=await fetchAPI("/api/config/detect-hardware");e.innerHTML=`\n            <div class="space-y-2">\n                <div class="flex justify-between">\n                    <span class="text-gray-400">Detected Model:</span>\n                    <span class="text-white font-semibold">${t.model}</span>\n                </div>\n                <div class="flex justify-between">\n                    <span class="text-gray-400">Total RAM:</span>\n                    <span class="text-white font-semibold">${t.ram_gb} GB (${t.ram_mb} MB)</span>\n                </div>\n                <div class="flex justify-between">\n                    <span class="text-gray-400">CPU Cores:</span>\n                    <span class="text-white font-semibold">${t.cpu_count}</span>\n                </div>\n                <div class="flex justify-between">\n                    <span class="text-gray-400">Recommended Profile:</span>\n                    <span class="text-Ragnar-400 font-semibold">${t.recommended_profile}</span>\n                </div>\n            </div>\n        `,addConsoleMessage(`Detected: ${t.model} with ${t.ram_gb}GB RAM`,"success"),t.recommended_profile&&(addConsoleMessage(`Applying recommended profile: ${t.recommended_profile}`,"info"),await applyHardwareProfile(t.recommended_profile))}catch(e){console.error("Error detecting hardware:",e),addConsoleMessage("Failed to detect hardware","error"),document.getElementById("hardware-detection-info").innerHTML='<span class="text-red-400">‚ùå Failed to detect hardware. Try manual selection.</span>'}}async function confirmApplyProfile(e,t){confirm(`Apply profile "${t.name}"?\n\n${t.description}\n\nThis will update system resource settings and requires a service restart to take full effect.`)&&await applyHardwareProfile(e)}async function applyHardwareProfile(e){try{addConsoleMessage(`Applying hardware profile: ${e}...`,"info");const t=await postAPI("/api/config/apply-profile",{profile_id:e});t.success?(addConsoleMessage(`‚úÖ Profile applied: ${t.profile.name}`,"success"),addConsoleMessage("‚ö†Ô∏è Service restart required for changes to take effect","warning"),displayCurrentProfile({hardware_profile:e,hardware_profile_name:t.profile.name,hardware_profile_applied:t.profile.hardware_profile_applied||(new Date).toISOString()}),confirm("Hardware profile applied successfully!\n\nRestart the Ragnar service now to apply changes?")&&await restartService()):addConsoleMessage("‚ùå Failed to apply profile","error")}catch(e){console.error("Error applying hardware profile:",e),addConsoleMessage(`Failed to apply hardware profile: ${e.message}`,"error")}}function displayCurrentProfile(e){const t=document.getElementById("current-profile-status"),n=document.getElementById("current-profile-name"),a=document.getElementById("current-profile-applied");if(e.hardware_profile&&e.hardware_profile_name)if(t.classList.remove("hidden"),n.textContent=e.hardware_profile_name,e.hardware_profile_applied){const t=new Date(e.hardware_profile_applied);a.textContent=`Applied: ${t.toLocaleString()}`}else a.textContent="Applied recently";else t.classList.add("hidden")}function updateReleaseGateState(e={}){const t=Boolean(e&&e.enabled),n="string"==typeof(e&&e.message)?e.message.trim():"";releaseGateState={enabled:t,message:n||RELEASE_GATE_DEFAULT_MESSAGE};const a=document.getElementById("update-btn");if(a&&(a.dataset.releaseGate=t?"true":"false",["ring-2","ring-yellow-500/50","ring-offset-2","ring-offset-slate-900"].forEach(e=>{t?a.classList.add(e):a.classList.remove(e)})),!t&&releaseGateResolver){const e=releaseGateResolver;releaseGateResolver=null,releaseGatePendingPromise=null,hideReleaseGateModal(),e(!0)}}function showReleaseGateModal(){const e=document.getElementById("release-gate-modal"),t=document.getElementById("release-gate-modal-message");t&&(t.textContent=releaseGateState.message||RELEASE_GATE_DEFAULT_MESSAGE),e&&(e.classList.remove("hidden"),e.classList.add("flex"))}function hideReleaseGateModal(){const e=document.getElementById("release-gate-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))}function ensureReleaseGateAcknowledged(){return releaseGateState.enabled?releaseGatePendingPromise?(showReleaseGateModal(),releaseGatePendingPromise):(releaseGatePendingPromise=new Promise(e=>{releaseGateResolver=e,showReleaseGateModal()}),releaseGatePendingPromise):Promise.resolve(!0)}function handleReleaseGateDecision(e){if(hideReleaseGateModal(),releaseGateResolver){const t=releaseGateResolver;releaseGateResolver=null,releaseGatePendingPromise=null,t(Boolean(e))}}async function checkForUpdates(){try{const e=document.getElementById("update-btn"),t=document.getElementById("update-status");e&&(e.onclick=performUpdate,e.disabled=!0,e.className="w-full bg-gray-600 text-white py-2 px-4 rounded cursor-not-allowed"),updateElement("update-btn-text","Update System"),updateElement("update-status","Checking..."),t&&(t.className="text-sm px-2 py-1 rounded bg-gray-700 text-gray-300"),updateElement("update-info","Checking for updates..."),addConsoleMessage("Checking for system updates...","info");const n=await fetchAPI("/api/system/check-updates"),a=n.git_status||{};console.log("Update check response:",n),addConsoleMessage(`Debug: Repo path: ${n.repo_path}`,"info"),addConsoleMessage(`Debug: Current commit: ${n.current_commit}`,"info"),addConsoleMessage(`Debug: Latest commit: ${n.latest_commit}`,"info"),addConsoleMessage(`Debug: Commits behind: ${n.commits_behind}`,"info");let s="";n.updates_available&&n.commits_behind>0?(s=`${n.commits_behind} commits behind. Latest: ${n.latest_commit||"Unknown"}`,updateElement("update-status","Update Available"),t&&(t.className="text-sm px-2 py-1 rounded bg-orange-700 text-orange-300"),e&&(e.disabled=!1,e.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors"),addConsoleMessage(`Update available: ${n.commits_behind} commits behind`,"warning")):(s="System is up to date",updateElement("update-status","Up to Date"),t&&(t.className="text-sm px-2 py-1 rounded bg-green-700 text-green-300"),e&&(e.disabled=!0,e.className="w-full bg-gray-600 text-white py-2 px-4 rounded cursor-not-allowed"),addConsoleMessage("System is up to date","success"));const o=[],r=Array.isArray(a.modified_files)?a.modified_files.length:0;if(a.has_conflicts?o.push("Local merge conflicts detected"):a.is_dirty&&o.push(`${r} local change${1===r?"":"s"}`),a.status_error&&o.push(`git status error: ${a.status_error}`),updateElement("update-info",s),a.has_conflicts)return e&&(e.disabled=!0,e.onclick=null,e.className="w-full bg-red-700 text-white py-2 px-4 rounded cursor-not-allowed",updateElement("update-btn-text","Resolve Git Conflicts")),updateElement("update-status","Local Conflict"),t&&(t.className="text-sm px-2 py-1 rounded bg-red-700 text-red-200"),void addConsoleMessage("Local git conflicts detected. Resolve them before updating.","error");n.updates_available&&n.commits_behind>0&&e&&(a.is_dirty?(e.onclick=autoStashAndUpdate,e.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors",updateElement("update-btn-text","Update System"),addConsoleMessage("Local edits detected. Ragnar will handle them automatically during the update.","info")):(e.onclick=performUpdate,updateElement("update-btn-text","Update System")))}catch(e){if(console.error("Error checking for updates:",e),updateElement("update-status","Error"),document.getElementById("update-status").className="text-sm px-2 py-1 rounded bg-red-700 text-red-300",e.message&&e.message.includes("safe.directory")){updateElement("update-info","Git safe directory issue detected"),addConsoleMessage("Git safe directory error detected. Click the Fix Git button.","error");const e=document.getElementById("update-btn");e.textContent="Fix Git Config",e.disabled=!1,e.className="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded transition-colors",e.onclick=fixGitConfig}else updateElement("update-info","Failed to check for updates"),addConsoleMessage(`Failed to check for updates: ${e.message}`,"error")}}async function fixGitConfig(){try{updateElement("update-btn-text","Fixing...");const e=document.getElementById("update-btn");e.disabled=!0,addConsoleMessage("Fixing git configuration...","info");const t=await postAPI("/api/system/fix-git",{});t.success?(addConsoleMessage("Git configuration fixed successfully","success"),e.textContent="Update System",e.onclick=performUpdate,setTimeout(()=>{checkForUpdates()},1e3)):(addConsoleMessage(`Failed to fix git configuration: ${t.error}`,"error"),e.disabled=!1,updateElement("update-btn-text","Fix Git Config"))}catch(e){console.error("Error fixing git config:",e),addConsoleMessage("Failed to fix git configuration","error");document.getElementById("update-btn").disabled=!1,updateElement("update-btn-text","Fix Git Config")}}async function performUpdate(){if(await ensureReleaseGateAcknowledged()){if(confirm("This will update the system and restart the service. Continue?"))try{updateElement("update-btn-text","Update now");const e=document.getElementById("update-btn");e.disabled=!0,e.className="w-full bg-gray-600 text-white py-2 px-4 rounded cursor-not-allowed",addConsoleMessage("Starting system update...","info");const t=await postAPI("/api/system/update",{});t.success?(addConsoleMessage("Update completed successfully","success"),addConsoleMessage("System will restart automatically...","info"),updateElement("update-info","Update completed. System restarting..."),setTimeout(async()=>{await verifyServiceRestart()},1e4)):(addConsoleMessage(`Update failed: ${t.error||"Unknown error"}`,"error"),updateElement("update-btn-text","Update System"),e.disabled=!1,e.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors")}catch(e){console.error("Error performing update:",e),addConsoleMessage("Update failed due to network error","error"),updateElement("update-btn-text","Update System");const t=document.getElementById("update-btn");t.disabled=!1,t.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors"}}else addConsoleMessage("Update postponed until the release window opens.","info")}async function autoStashAndUpdate(){if(!await ensureReleaseGateAcknowledged())return void addConsoleMessage("Update postponed until the release window opens.","info");if(!confirm("This will update the system and restart the service. Continue?"))return;const e=document.getElementById("update-btn"),t=(t,n)=>{e&&(e.disabled=!!t,e.className=t?"w-full bg-gray-600 text-white py-2 px-4 rounded cursor-wait":"w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors",updateElement("update-btn-text",n))};try{t(!0,"Updating..."),addConsoleMessage("Applying update...","info");const n=await postAPI("/api/system/stash-update",{});if(!n.success)throw new Error(n.error||"Update failed");addConsoleMessage("Update completed successfully.","success"),addConsoleMessage("System will restart automatically...","info"),updateElement("update-info","Update applied. System restarting..."),e&&(e.className="w-full bg-gray-600 text-white py-2 px-4 rounded cursor-not-allowed",updateElement("update-btn-text","Updating...")),setTimeout(async()=>{await verifyServiceRestart()},1e4)}catch(e){console.error("Auto update error:",e),addConsoleMessage(`Update failed: ${e.message}`,"error"),t(!1,"Update System"),updateElement("update-info","Update failed. Fix issues and retry.")}}async function verifyServiceRestart(){let e=0;addConsoleMessage("Verifying service is back online...","info"),updateElement("update-info","Verifying service restart...");const t=async()=>{e++;try{const e=await fetch("/api/stats",{method:"GET",headers:{"Content-Type":"application/json"},timeout:5e3});if(e.ok){addConsoleMessage("‚úÖ Service verified online after update","success"),updateElement("update-info","Update completed successfully. Service is online.");const e=document.getElementById("update-btn");return updateElement("update-btn-text","Update System"),e.disabled=!1,e.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors",void setTimeout(()=>{checkForUpdates()},5e3)}throw new Error(`HTTP ${e.status}`)}catch(n){if(console.log(`Service check attempt ${e}/12 failed:`,n.message),e>=12){addConsoleMessage("‚ö†Ô∏è Service restart verification timeout. Manual check may be needed.","warning"),updateElement("update-info","Update completed, but service verification timed out.");const e=document.getElementById("update-btn");return updateElement("update-btn-text","Update System"),e.disabled=!1,void(e.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors")}addConsoleMessage(`Service check ${e}/12 - waiting for restart...`,"info"),setTimeout(t,1e4)}};t()}async function checkForUpdatesQuiet(){try{const e=await fetchAPI("/api/system/check-updates");if(e.updates_available&&e.commits_behind>0){"config"!==currentTab&&addConsoleMessage(`üîÑ System update available: ${e.commits_behind} commits behind`,"warning");const t=document.querySelector('[data-tab="config"]');if(t&&!t.querySelector(".update-indicator")){const e=document.createElement("span");e.className="update-indicator absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full pulse-glow",t.style.position="relative",t.appendChild(e)}}else{const e=document.querySelector('[data-tab="config"]'),t=e?.querySelector(".update-indicator");t&&t.remove()}}catch(e){console.debug("Background update check failed:",e)}}async function restartService(){if(confirm("This will restart the Ragnar service. The web interface may be temporarily unavailable. Continue?"))try{addConsoleMessage("Restarting Ragnar service...","info"),updateElement("service-status","Restarting..."),document.getElementById("service-status").className="text-sm px-2 py-1 rounded bg-yellow-700 text-yellow-300";const e=await postAPI("/api/system/restart-service",{});e.success?(addConsoleMessage("Service restart initiated","success"),addConsoleMessage("Service will be back online shortly...","info"),setTimeout(()=>{updateElement("service-status","Running"),document.getElementById("service-status").className="text-sm px-2 py-1 rounded bg-green-700 text-green-300",addConsoleMessage("Service restart completed","success")},1e4)):(addConsoleMessage(`Service restart failed: ${e.error||"Unknown error"}`,"error"),updateElement("service-status","Error"),document.getElementById("service-status").className="text-sm px-2 py-1 rounded bg-red-700 text-red-300")}catch(e){console.error("Error restarting service:",e),addConsoleMessage("Failed to restart service","error"),updateElement("service-status","Error"),document.getElementById("service-status").className="text-sm px-2 py-1 rounded bg-red-700 text-red-300"}}async function rebootSystem(){if(confirm("This will reboot the entire system. The device will be offline for several minutes. Continue?"))try{addConsoleMessage("Initiating system reboot...","warning");const e=await postAPI("/api/system/reboot",{});e.success?(addConsoleMessage("System reboot initiated","success"),addConsoleMessage("Device will be offline for several minutes...","warning"),updateConnectionStatus(!1)):addConsoleMessage(`Reboot failed: ${e.error||"Unknown error"}`,"error")}catch(e){console.error("Error rebooting system:",e),addConsoleMessage("Failed to initiate system reboot","error")}}async function resetVulnerabilities(){if(confirm("‚ö†Ô∏è Reset All Vulnerabilities?\n\nThis will permanently delete:\n‚Ä¢ All discovered vulnerabilities\n‚Ä¢ Vulnerability scan results\n‚Ä¢ Network intelligence vulnerability data\n\nThis action cannot be undone. Continue?"))try{addConsoleMessage("Resetting vulnerabilities...","warning");const e=await postAPI("/api/data/reset-vulnerabilities",{});e.success?(addConsoleMessage(`Vulnerabilities reset: ${e.deleted_count||0} entries removed`,"success"),updateElement("vuln-count","0"),updateElement("vulnerability-count","0"),"network"!==currentTab&&"discovered"!==currentTab&&"threat-intel"!==currentTab||setTimeout(()=>{refreshCurrentTab()},500)):addConsoleMessage(`Reset failed: ${e.error||"Unknown error"}`,"error")}catch(e){console.error("Error resetting vulnerabilities:",e),addConsoleMessage("Failed to reset vulnerabilities","error")}}async function resetThreatIntelligence(){if(confirm("‚ö†Ô∏è Reset Threat Intelligence?\n\nThis will permanently delete:\n‚Ä¢ All threat intelligence findings\n‚Ä¢ Enriched threat data\n‚Ä¢ Threat cache\n\nThis action cannot be undone. Continue?"))try{addConsoleMessage("Resetting threat intelligence...","warning");const e=await postAPI("/api/data/reset-threat-intel",{});e.success?(addConsoleMessage("Threat intelligence data reset successfully","success"),"threat-intel"===currentTab&&setTimeout(()=>{refreshCurrentTab()},500)):addConsoleMessage(`Reset failed: ${e.error||"Unknown error"}`,"error")}catch(e){console.error("Error resetting threat intelligence:",e),addConsoleMessage("Failed to reset threat intelligence","error")}}async function updateVulnerabilityCount(){try{const e=await fetchAPI("/api/stats");updateElement("vuln-count",(e.vulnerability_count||0).toString())}catch(e){console.error("Error updating vulnerability count:",e),updateElement("vuln-count","?")}}async function startAPMode(){if(confirm('Start AP Mode?\n\nThis will:\n‚Ä¢ Disconnect from current Wi-Fi\n‚Ä¢ Start "Ragnar" access point\n‚Ä¢ Enable 3-minute smart cycling\n‚Ä¢ Allow Wi-Fi configuration via AP\n\nContinue?'))try{addConsoleMessage("Starting AP Mode...","info"),updateWifiStatus("Starting AP Mode...","connecting");const e=await postAPI("/api/wifi/ap/enable",{});e.success?(addConsoleMessage(`AP Mode started: ${e.ap_config.ssid}`,"success"),updateWifiStatus(`AP Mode Active: "${e.ap_config.ssid}" | ${e.ap_config.timeout}s timeout | Smart cycling enabled`,"ap-mode"),setTimeout(refreshWifiStatus,2e3)):(addConsoleMessage(`Failed to start AP Mode: ${e.message}`,"error"),updateWifiStatus(`Failed to start AP Mode: ${e.message}`,"error"))}catch(e){console.error("Error starting AP mode:",e),addConsoleMessage("Error starting AP Mode","error"),updateWifiStatus("Error starting AP Mode","error")}}async function refreshWifiStatus(){try{const e=await fetchAPI("/api/wifi/status");console.log("Wi-Fi status data received:",e);const t=document.getElementById("wifi-status-indicator"),n=document.getElementById("wifi-info");if(!t||!n)return console.error("Wi-Fi status elements not found in DOM"),void console.log("Looking for elements: wifi-status-indicator and wifi-info");if(console.log("Wi-Fi status elements found, updating..."),e.ap_mode_active){const a=`AP Mode Active: "${e.ap_ssid||"Ragnar"}" | Connect to configure Wi-Fi`;console.log("Setting AP mode status:",a),updateWifiStatus(a,"ap-mode"),t.textContent="AP Mode",t.className="text-sm px-2 py-1 rounded bg-orange-700 text-orange-300",n.textContent=a}else if(e.wifi_connected){const a=`Connected to: ${e.current_ssid||"Unknown Network"}`;console.log("Setting connected status:",a),updateWifiStatus(a,"connected"),t.textContent="Connected",t.className="text-sm px-2 py-1 rounded bg-green-700 text-green-300",n.textContent=a}else console.log("Setting disconnected status"),updateWifiStatus("Wi-Fi disconnected","disconnected"),t.textContent="Disconnected",t.className="text-sm px-2 py-1 rounded bg-red-700 text-red-300",n.textContent="No Wi-Fi connection";console.log("Wi-Fi status updated successfully")}catch(e){console.error("Error refreshing Wi-Fi status:",e),updateWifiStatus("Error checking Wi-Fi status","error");const t=document.getElementById("wifi-status-indicator"),n=document.getElementById("wifi-info");t&&(t.textContent="Error",t.className="text-sm px-2 py-1 rounded bg-red-700 text-red-300"),n&&(n.textContent="Error checking Wi-Fi status")}}function updateWifiStatus(e,t=""){addConsoleMessage(e,"error"===t?"error":"ap-mode"===t?"warning":"info")}let currentWifiNetworks=[],selectedWifiNetwork=null;const WIFI_INTERFACE_STORAGE_KEY="wifi-selected-interface";let selectedWifiInterface=null;function handleWifiInterfaceChange(e){selectedWifiInterface=(e?.target?.value||"").trim()||null,selectedWifiInterface?localStorage.setItem(WIFI_INTERFACE_STORAGE_KEY,selectedWifiInterface):localStorage.removeItem(WIFI_INTERFACE_STORAGE_KEY)}function getActiveWifiInterface(){if(selectedWifiInterface)return selectedWifiInterface;const e=localStorage.getItem(WIFI_INTERFACE_STORAGE_KEY);if(e)return selectedWifiInterface=e,selectedWifiInterface;const t=document.getElementById("wifi-interface-select");return t&&t.value?(selectedWifiInterface=t.value,selectedWifiInterface):null}async function loadWifiInterfaces(){try{const e=await fetchAPI("/api/wifi/interfaces"),t=document.getElementById("wifi-interface-select");if(!t)return;const n=localStorage.getItem(WIFI_INTERFACE_STORAGE_KEY);let a=!1;e.success&&e.interfaces&&e.interfaces.length>0?(t.innerHTML="",e.interfaces.forEach(e=>{const s=document.createElement("option");s.value=e.name,s.textContent=`${e.name}${e.is_default?" (default)":""} - ${e.state}`,(!a&&n&&e.name===n||!a&&e.is_default)&&(s.selected=!0,a=!0),t.appendChild(s)}),console.log("Loaded Wi-Fi interfaces:",e.interfaces)):(t.innerHTML='<option value="wlan0">wlan0 (default)</option>',a=!0),!a&&t.options.length>0&&(t.options[0].selected=!0),selectedWifiInterface=t.value||null,selectedWifiInterface&&localStorage.setItem(WIFI_INTERFACE_STORAGE_KEY,selectedWifiInterface),t.removeEventListener("change",handleWifiInterfaceChange),t.addEventListener("change",handleWifiInterfaceChange)}catch(e){console.error("Error loading Wi-Fi interfaces:",e);const t=document.getElementById("wifi-interface-select");t&&(t.innerHTML='<option value="wlan0">wlan0 (default)</option>')}}async function scanWifiNetworks(){const e=document.getElementById("scan-wifi-btn"),t=document.getElementById("wifi-networks-list");if(!t)return;const n=getActiveWifiInterface();try{e&&(e.disabled=!0,e.innerHTML='\n                <svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n                </svg>\n                Scanning...\n            '),t.innerHTML='\n            <div class="text-center text-gray-400 py-8">\n                <svg class="w-8 h-8 inline animate-spin mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n                </svg>\n                <p>Scanning for Wi-Fi networks...</p>\n            </div>\n        ';const a=n?{interface:n}:{};await postAPI("/api/wifi/scan",a),await new Promise(e=>setTimeout(e,3e3));const s=n?`/api/wifi/networks?interface=${encodeURIComponent(n)}`:"/api/wifi/networks",o=await fetchAPI(s);console.log("Wi-Fi networks data:",o),displayWifiNetworks(o)}catch(e){console.error("Error scanning Wi-Fi networks:",e),t.innerHTML=`\n            <div class="text-center text-red-400 py-8">\n                <p>Error scanning for networks</p>\n                <p class="text-sm mt-2">${e.message}</p>\n            </div>\n        `}finally{e&&(e.disabled=!1,e.innerHTML='\n                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>\n                </svg>\n                Scan Networks\n            ')}}function displayWifiNetworks(e){const t=document.getElementById("wifi-networks-list");if(!t)return;let n=[],a=[];const s=e.interface||getActiveWifiInterface(),o=s?`\n        <div class="text-xs text-gray-400 mb-3">\n            Showing results for interface <span class="font-semibold text-gray-100">${s}</span>\n        </div>\n    `:"";s?t.dataset.interface=s:delete t.dataset.interface,e.available?n=e.available:e.networks&&(n=e.networks),e.known&&(a=e.known.map(e=>e.ssid||e)),console.log("Displaying networks:",n),console.log("Known networks:",a),n&&0!==n.length?(n.sort((e,t)=>(t.signal||0)-(e.signal||0)),currentWifiNetworks=n,t.innerHTML=o+n.map(e=>{const t=e.ssid||e.SSID||"Unknown Network",n=e.signal||0,s="open"!==e.security&&"Open"!==e.security,o=e.known||e.has_system_profile||a.includes(t);let r="";r=n>=70?'<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">\n                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>\n            </svg>':n>=50?'<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">\n                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7z"></path>\n            </svg>':'<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">\n                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5z"></path>\n            </svg>';const i=s?'\n            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">\n                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>\n            </svg>\n        ':"";let l="";return e.in_use||!1?l='<span class="text-xs px-2 py-1 rounded bg-green-600 text-white ml-2">Connected</span>':o&&(l='<span class="text-xs px-2 py-1 rounded bg-blue-600 text-white ml-2">Saved</span>'),`\n            <div class="bg-slate-800 rounded-lg p-3 hover:bg-slate-700 transition-colors cursor-pointer"\n                 onclick="openWifiConnectModal('${t.replace(/'/g,"\\'")}', ${o})">\n                <div class="flex items-center justify-between">\n                    <div class="flex items-center space-x-3 flex-1">\n                        ${r}\n                        <div class="flex-1">\n                            <div class="flex items-center">\n                                <span class="font-medium">${t}</span>\n                                ${l}\n                            </div>\n                            <div class="text-xs text-gray-400 mt-1">\n                                ${s?"Secured":"Open"} ‚Ä¢ Signal: ${n}%\n                            </div>\n                        </div>\n                    </div>\n                    <div class="flex items-center space-x-2">\n                        ${i}\n                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>\n                        </svg>\n                    </div>\n                </div>\n            </div>\n        `}).join("")):t.innerHTML=`\n            ${o}\n            <div class="text-center text-gray-400 py-8">\n                <p>No Wi-Fi networks found</p>\n                <p class="text-sm mt-2">Try scanning again or check your Wi-Fi interface</p>\n            </div>\n        `}function openWifiConnectModal(e,t){const n=document.getElementById("wifi-connect-modal"),a=document.getElementById("wifi-connect-ssid"),s=document.getElementById("wifi-password-section"),o=document.getElementById("wifi-connect-password"),r=document.getElementById("wifi-connect-status");n&&a&&(selectedWifiNetwork={ssid:e,isKnown:t},a.value=e,o&&(o.value=""),s&&(s.style.display=t?"none":"block"),r&&r.classList.add("hidden"),n.classList.remove("hidden"),n.classList.add("flex"))}function closeWifiConnectModal(){const e=document.getElementById("wifi-connect-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex")),selectedWifiNetwork=null}function togglePasswordVisibility(){const e=document.getElementById("wifi-connect-password"),t=document.getElementById("password-eye-icon");e&&("password"===e.type?(e.type="text",t&&(t.innerHTML='\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>\n            ')):(e.type="password",t&&(t.innerHTML='\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>\n            ')))}async function connectToWifiNetwork(){if(!selectedWifiNetwork)return;const e=document.getElementById("wifi-connect-password"),t=document.getElementById("wifi-password-section"),n=document.getElementById("wifi-save-network"),a=document.getElementById("wifi-connect-status"),s=document.getElementById("wifi-connect-submit-btn"),o=selectedWifiNetwork.ssid,r=selectedWifiNetwork.isKnown,i=r?null:e?e.value:"",l=!n||n.checked;if(r||i)try{s&&(s.disabled=!0,s.innerHTML='\n                <svg class="w-4 h-4 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n                </svg>\n                Connecting...\n            '),a&&(a.classList.remove("hidden"),a.innerHTML=`\n                <div class="bg-blue-600 rounded p-3 text-sm">\n                    <svg class="w-4 h-4 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n                    </svg>\n                    Connecting to ${o}...\n                </div>\n            `);const n=await postAPI("/api/wifi/connect",{ssid:o,password:i,save:l});n.success?(a&&(a.innerHTML=`\n                    <div class="bg-green-600 rounded p-3 text-sm">\n                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>\n                        </svg>\n                        ${n.message||"Connected successfully!"}\n                    </div>\n                `),addConsoleMessage(`Connected to Wi-Fi: ${o}`,"success"),setTimeout(()=>{closeWifiConnectModal(),refreshWifiStatus()},2e3)):(a&&(a.innerHTML=`\n                    <div class="bg-red-600 rounded p-3 text-sm">\n                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                        </svg>\n                        ${n.message||"Connection failed"}\n                    </div>\n                `),addConsoleMessage(`Failed to connect to Wi-Fi: ${o}`,"error"),r&&t&&(t.style.display="block",e&&(e.value="",e.placeholder="Stored password failed - enter correct password"),selectedWifiNetwork&&(selectedWifiNetwork.isKnown=!1)))}catch(n){console.error("Error connecting to Wi-Fi:",n),a&&(a.classList.remove("hidden"),a.innerHTML=`\n                <div class="bg-red-600 rounded p-3 text-sm">\n                    Error: ${n.message}\n                </div>\n            `),addConsoleMessage(`Error connecting to Wi-Fi: ${n.message}`,"error"),r&&t&&(t.style.display="block",e&&(e.value="",e.placeholder="Connection error - please enter password"),selectedWifiNetwork&&(selectedWifiNetwork.isKnown=!1))}finally{s&&(s.disabled=!1,s.innerHTML="Connect")}else a&&(a.classList.remove("hidden"),a.innerHTML='<div class="bg-red-600 rounded p-3 text-sm">Please enter a password</div>')}async function loadConsoleLogs(){try{const e=await fetchAPI("/api/logs");e&&e.logs&&updateConsole(e.logs)}catch(e){console.error("Error loading console logs:",e),addConsoleMessage("Unable to load historical logs from server","warning"),addConsoleMessage("Console will show new messages as they occur","info")}}let currentBluetoothDevices=[],isBluetoothScanning=!1,bluetoothScanInterval=null;async function refreshBluetoothStatus(){try{updateBluetoothStatus(await fetchAPI("/api/bluetooth/status"))}catch(e){console.error("Error refreshing Bluetooth status:",e),updateBluetoothStatus({enabled:!1,discoverable:!1,error:"Failed to get Bluetooth status"})}}function updateBluetoothStatus(e){const t=document.getElementById("bluetooth-status-indicator"),n=document.getElementById("bluetooth-info"),a=document.getElementById("bluetooth-power-btn"),s=document.getElementById("bluetooth-power-text"),o=document.getElementById("bluetooth-discoverable-btn"),r=document.getElementById("bluetooth-discoverable-text");if(t&&n&&a&&s){if(e.error)return t.className="text-sm px-2 py-1 rounded bg-red-700 text-red-300",t.textContent="Error",n.textContent=e.error,s.textContent="Enable Bluetooth",void(r&&(r.textContent="Make Discoverable"));if(e.enabled){t.className="text-sm px-2 py-1 rounded bg-green-700 text-green-300",t.textContent="Enabled",s.textContent="Disable Bluetooth",a.className="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition-colors";let i="Bluetooth is enabled";e.address&&(i+=` | Address: ${e.address}`),e.name&&(i+=` | Name: ${e.name}`),n.textContent=i,o&&r&&(e.discoverable?(r.textContent="Hide Device",o.className="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded transition-colors"):(r.textContent="Make Discoverable",o.className="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 px-4 rounded transition-colors"),o.disabled=!1)}else t.className="text-sm px-2 py-1 rounded bg-gray-700 text-gray-300",t.textContent="Disabled",n.textContent="Bluetooth is disabled",s.textContent="Enable Bluetooth",a.className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors",o&&r&&(r.textContent="Make Discoverable",o.className="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded transition-colors",o.disabled=!0)}}async function toggleBluetoothPower(){const e=document.getElementById("bluetooth-power-btn"),t=document.getElementById("bluetooth-power-text");if(!e||!t)return;const n=t.textContent;t.textContent="Processing...",e.disabled=!0;try{const e="Disable Bluetooth"===n,t=e?"/api/bluetooth/disable":"/api/bluetooth/enable",a=await postAPI(t,{});if(!a.success)throw new Error(a.error||"Failed to toggle Bluetooth");addConsoleMessage(`Bluetooth ${e?"disabled":"enabled"} successfully`,"success"),setTimeout(refreshBluetoothStatus,1e3)}catch(e){console.error("Error toggling Bluetooth power:",e),addConsoleMessage(`Error toggling Bluetooth: ${e.message}`,"error"),t.textContent=n}finally{e.disabled=!1,"Processing..."===t.textContent&&(t.textContent=n)}}async function toggleBluetoothDiscoverable(){const e=document.getElementById("bluetooth-discoverable-btn"),t=document.getElementById("bluetooth-discoverable-text");if(!e||!t)return;const n=t.textContent;t.textContent="Processing...",e.disabled=!0;try{const e="Hide Device"===n,t=e?"/api/bluetooth/discoverable/off":"/api/bluetooth/discoverable/on",a=await postAPI(t,{});if(!a.success)throw new Error(a.error||"Failed to toggle discoverable mode");addConsoleMessage("Bluetooth "+(e?"hidden":"made discoverable"),"success"),setTimeout(refreshBluetoothStatus,1e3)}catch(e){console.error("Error toggling Bluetooth discoverable:",e),addConsoleMessage(`Error toggling discoverable mode: ${e.message}`,"error"),t.textContent=n}finally{e.disabled=!1,"Processing..."===t.textContent&&(t.textContent=n)}}async function startBluetoothScan(){const e=document.getElementById("bluetooth-scan-btn"),t=document.getElementById("bluetooth-scan-text"),n=document.getElementById("bluetooth-scan-status");if(e&&t&&n)if(isBluetoothScanning)stopBluetoothScan();else{isBluetoothScanning=!0,t.textContent="Stop Scan",e.className="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition-colors mb-2",n.className="text-sm px-2 py-1 rounded bg-blue-700 text-blue-300",n.textContent="Scanning...";try{const e=await postAPI("/api/bluetooth/scan/start",{});if(!e.success)throw new Error(e.error||"Failed to start Bluetooth scan");addConsoleMessage("Started Bluetooth device scan","info");try{displayBluetoothDevices((await fetchAPI("/api/bluetooth/devices")).devices||[])}catch(e){console.error("Error getting initial Bluetooth devices:",e)}bluetoothScanInterval=setInterval(async()=>{try{displayBluetoothDevices((await fetchAPI("/api/bluetooth/devices")).devices||[])}catch(e){console.error("Error getting Bluetooth devices:",e)}},2e3)}catch(e){console.error("Error starting Bluetooth scan:",e),addConsoleMessage(`Error starting Bluetooth scan: ${e.message}`,"error"),stopBluetoothScan()}}}function stopBluetoothScan(){const e=document.getElementById("bluetooth-scan-btn"),t=document.getElementById("bluetooth-scan-text"),n=document.getElementById("bluetooth-scan-status");isBluetoothScanning=!1,bluetoothScanInterval&&(clearInterval(bluetoothScanInterval),bluetoothScanInterval=null),e&&t&&n&&(t.textContent="Start Scan",e.className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded transition-colors mb-2",n.className="text-sm px-2 py-1 rounded bg-gray-700 text-gray-300",n.textContent="Ready"),postAPI("/api/bluetooth/scan/stop",{}).catch(e=>{}).catch(e=>{console.error("Error stopping Bluetooth scan:",e)}),addConsoleMessage("Stopped Bluetooth device scan","info")}function displayBluetoothDevices(e){const t=document.getElementById("bluetooth-devices-list");t&&(currentBluetoothDevices=e,e&&0!==e.length?t.innerHTML=e.map(e=>`\n        <div class="glass rounded-lg p-3 hover:bg-slate-700 transition-colors cursor-pointer"\n             onclick="showBluetoothDeviceDetails('${e.address}')">\n            <div class="flex items-center justify-between">\n                <div class="flex-1">\n                    <div class="font-medium text-white">\n                        ${escapeHtml(e.name||"Unknown Device")}\n                    </div>\n                    <div class="text-sm text-gray-400">\n                        ${e.address} ${e.rssi?`‚Ä¢ ${e.rssi} dBm`:""}\n                    </div>\n                    ${e.device_class?`\n                        <div class="text-xs text-gray-500 mt-1">\n                            ${escapeHtml(e.device_class)}\n                        </div>\n                    `:""}\n                </div>\n                <div class="flex items-center space-x-2">\n                    ${e.rssi?`\n                        <div class="text-xs px-2 py-1 rounded ${getRSSIClass(e.rssi)}">\n                            ${e.rssi} dBm\n                        </div>\n                    `:""}\n                    ${e.paired?'\n                        <div class="text-xs px-2 py-1 rounded bg-green-700 text-green-300">\n                            Paired\n                        </div>\n                    ':""}\n                </div>\n            </div>\n        </div>\n    `).join(""):t.innerHTML=`\n            <div class="text-center text-gray-400 py-8">\n                ${isBluetoothScanning?"Scanning for devices...":"No devices found. Start a scan to discover nearby devices."}\n            </div>\n        `)}function getRSSIClass(e){return e>=-40?"bg-green-700 text-green-300":e>=-60?"bg-yellow-700 text-yellow-300":e>=-80?"bg-orange-700 text-orange-300":"bg-red-700 text-red-300"}function showBluetoothDeviceDetails(e){const t=currentBluetoothDevices.find(t=>t.address===e);if(!t)return;const n=document.getElementById("bluetooth-device-modal"),a=document.getElementById("bt-device-name"),s=document.getElementById("bt-device-mac"),o=document.getElementById("bt-device-rssi"),r=document.getElementById("bt-device-class"),i=document.getElementById("bt-device-services"),l=document.getElementById("bt-pair-btn");n&&a&&s&&(a.value=t.name||"Unknown Device",s.value=t.address,o&&(o.value=t.rssi?`${t.rssi} dBm`:"Unknown"),r&&(r.value=t.device_class||"Unknown"),i&&(t.services&&t.services.length>0?i.innerHTML=t.services.map(e=>`\n                <div class="mb-1 text-sm">${escapeHtml(e)}</div>\n            `).join(""):i.innerHTML='<div class="text-gray-400">No services detected</div>'),l&&(t.paired?(l.innerHTML='\n                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>\n                </svg>\n                Unpair Device\n            ',l.className="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition-colors"):(l.innerHTML='\n                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>\n                </svg>\n                Pair Device\n            ',l.className="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors"),l.setAttribute("data-device-address",t.address)),n.classList.remove("hidden"),n.classList.add("flex"))}function closeBluetoothDeviceModal(){const e=document.getElementById("bluetooth-device-modal"),t=document.getElementById("bt-device-status");e&&(e.classList.add("hidden"),e.classList.remove("flex")),t&&(t.classList.add("hidden"),t.innerHTML="")}async function pairBluetoothDevice(){const e=document.getElementById("bt-pair-btn"),t=document.getElementById("bt-device-status");if(!e)return;const n=e.getAttribute("data-device-address");if(!n)return;const a=currentBluetoothDevices.find(e=>e.address===n);if(!a)return;const s=e.innerHTML;e.innerHTML="Processing...",e.disabled=!0,t&&(t.classList.remove("hidden"),t.innerHTML=`\n            <div class="bg-blue-600 rounded p-3 text-sm">\n                ${a.paired?"Unpairing":"Pairing"} device ${a.name||n}...\n            </div>\n        `);try{const e=a.paired?"/api/bluetooth/unpair":"/api/bluetooth/pair",s=await fetchAPI(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:n})});if(!s.success)throw new Error(s.error||`Failed to ${a.paired?"unpair":"pair"} device`);{const e=a.paired?"unpaired":"paired";addConsoleMessage(`Device ${a.name||n} ${e} successfully`,"success"),t&&(t.innerHTML=`\n                    <div class="bg-green-600 rounded p-3 text-sm">\n                        Device ${e} successfully\n                    </div>\n                `),setTimeout(()=>{isBluetoothScanning&&fetchAPI("/api/bluetooth/devices").then(e=>{displayBluetoothDevices(e.devices||[])}).catch(e=>{console.error("Error refreshing devices:",e)}),closeBluetoothDeviceModal()},2e3)}}catch(e){console.error("Error pairing/unpairing device:",e),addConsoleMessage(`Error: ${e.message}`,"error"),t&&(t.innerHTML=`\n                <div class="bg-red-600 rounded p-3 text-sm">\n                    Error: ${e.message}\n                </div>\n            `)}finally{e.disabled=!1,"Processing..."===e.innerHTML&&(e.innerHTML=s)}}async function enumerateBluetoothServices(){const e=document.getElementById("bt-enumerate-btn"),t=document.getElementById("bt-device-status"),n=document.getElementById("bt-device-services");if(!e)return;const a=document.getElementById("bt-pair-btn")?.getAttribute("data-device-address");if(!a)return;const s=currentBluetoothDevices.find(e=>e.address===a);if(!s)return;const o=e.innerHTML;e.innerHTML="Enumerating...",e.disabled=!0,t&&(t.classList.remove("hidden"),t.innerHTML=`\n            <div class="bg-blue-600 rounded p-3 text-sm">\n                Enumerating services for ${s.name||a}...\n            </div>\n        `);try{const e=await postAPI("/api/bluetooth/enumerate",{address:a});if(!e.success||!e.services)throw new Error(e.error||"Failed to enumerate services");addConsoleMessage(`Found ${e.services.length} services on ${s.name||a}`,"success"),n&&(e.services.length>0?n.innerHTML=e.services.map(e=>`\n                        <div class="mb-2 p-2 bg-slate-800 rounded text-sm">\n                            <div class="font-medium">${escapeHtml(e.name||"Unknown Service")}</div>\n                            <div class="text-gray-400 text-xs">${e.uuid}</div>\n                            ${e.description?`<div class="text-gray-500 text-xs mt-1">${escapeHtml(e.description)}</div>`:""}\n                        </div>\n                    `).join(""):n.innerHTML='<div class="text-gray-400">No services found</div>'),t&&(t.innerHTML=`\n                    <div class="bg-green-600 rounded p-3 text-sm">\n                        Found ${e.services.length} services\n                    </div>\n                `)}catch(e){console.error("Error enumerating services:",e),addConsoleMessage(`Error enumerating services: ${e.message}`,"error"),t&&(t.innerHTML=`\n                <div class="bg-red-600 rounded p-3 text-sm">\n                    Error: ${e.message}\n                </div>\n            `)}finally{e.disabled=!1,"Enumerating..."===e.innerHTML&&(e.innerHTML=o)}}function clearBluetoothDevices(){const e=document.getElementById("bluetooth-devices-list");e&&(e.innerHTML='\n            <div class="text-center text-gray-400 py-8">\n                Start a Bluetooth scan to discover nearby devices\n            </div>\n        '),currentBluetoothDevices=[],addConsoleMessage("Cleared Bluetooth device list","info")}async function startBeaconTracking(){const e=document.getElementById("beacon-track-btn"),t=document.getElementById("beacon-results"),n=document.getElementById("beacon-duration");if(!e||!t||!n)return;const a=parseInt(n.value)||60,s=e.textContent;e.disabled=!0,e.textContent="Tracking...",t.classList.remove("hidden"),t.textContent=`Tracking beacons for ${a} seconds...`;try{const e=await postAPI("/api/bluetooth/pentest/beacon-track",{duration:a});if(!e.success)throw new Error(e.error||"Beacon tracking failed");{const n=e.beacons_found||0;t.innerHTML=`\n                <div class="text-green-400">‚úì Found ${n} beacon(s)</div>\n                <div class="mt-1">${JSON.stringify(e.beacons,null,2)}</div>\n            `,addConsoleMessage(`Beacon tracking complete: ${n} beacons found`,"success"),updatePentestSummary("beacon_tracking",e)}}catch(e){console.error("Beacon tracking error:",e),t.innerHTML=`<div class="text-red-400">‚úó Error: ${e.message}</div>`,addConsoleMessage(`Beacon tracking failed: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=s}}async function startDataExfiltration(){const e=document.getElementById("exfil-btn"),t=document.getElementById("exfil-results"),n=document.getElementById("exfil-target");if(!e||!t||!n)return;const a=n.value.trim();if(!a||!a.match(/^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/))return t.classList.remove("hidden"),void(t.innerHTML='<div class="text-red-400">‚úó Invalid MAC address format</div>');const s=e.textContent;e.disabled=!0,e.textContent="Exfiltrating...",t.classList.remove("hidden"),t.textContent=`Extracting data from ${a}...`;try{const e=await postAPI("/api/bluetooth/pentest/exfiltrate",{target:a});if(!e.device_info)throw new Error(e.error||"Exfiltration failed");{const n=e.services?.length||0,s=e.files?.length||0,o=e.contacts?.length||0;t.innerHTML=`\n                <div class="text-green-400">‚úì Exfiltration complete</div>\n                <div class="mt-1 text-xs">\n                    Services: ${n} | Files: ${s} | Contacts: ${o}\n                </div>\n            `,addConsoleMessage(`Data exfiltration from ${a} complete`,"success"),updatePentestSummary("exfiltration",e)}}catch(e){console.error("Exfiltration error:",e),t.innerHTML=`<div class="text-red-400">‚úó Error: ${e.message}</div>`,addConsoleMessage(`Exfiltration failed: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=s}}async function startBlueBorneScan(){const e=document.getElementById("blueborne-btn"),t=document.getElementById("blueborne-results"),n=document.getElementById("blueborne-target");if(!e||!t||!n)return;const a=n.value.trim();if(!a||!a.match(/^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/))return t.classList.remove("hidden"),void(t.innerHTML='<div class="text-red-400">‚úó Invalid MAC address format</div>');const s=e.textContent;e.disabled=!0,e.textContent="Scanning...",t.classList.remove("hidden"),t.textContent=`Scanning ${a} for BlueBorne...`;try{const e=await postAPI("/api/bluetooth/pentest/blueborne-scan",{target:a}),n=e.vulnerabilities?.length||0,s=e.vulnerable||!1;t.innerHTML=`\n            <div class="${s?"text-red-400":"text-green-400"}">\n                ${s?"‚ö† Potentially vulnerable":"‚úì No vulnerabilities detected"}\n            </div>\n            ${n>0?`<div class="mt-1 text-xs">Found ${n} potential issue(s)</div>`:""}\n        `,addConsoleMessage(`BlueBorne scan of ${a} complete`,"info"),updatePentestSummary("blueborne_scan",e)}catch(e){console.error("BlueBorne scan error:",e),t.innerHTML=`<div class="text-red-400">‚úó Error: ${e.message}</div>`,addConsoleMessage(`BlueBorne scan failed: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=s}}async function startMovementTracking(){const e=document.getElementById("track-btn"),t=document.getElementById("track-results"),n=document.getElementById("track-target"),a=document.getElementById("track-duration");if(!(e&&t&&n&&a))return;const s=n.value.trim(),o=parseInt(a.value)||300;if(!s||!s.match(/^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/))return t.classList.remove("hidden"),void(t.innerHTML='<div class="text-red-400">‚úó Invalid MAC address format</div>');const r=e.textContent;e.disabled=!0,e.textContent="Tracking...",t.classList.remove("hidden"),t.textContent=`Tracking ${s} for ${o}s...`;try{const e=await postAPI("/api/bluetooth/pentest/track-movement",{target:s,duration:o});if(!(e.readings&&e.readings.length>0))throw new Error("No readings collected");{const n=e.readings.reduce((e,t)=>e+t.rssi,0)/e.readings.length,a=e.readings.reduce((e,t)=>e+t.distance_estimate,0)/e.readings.length;t.innerHTML=`\n                <div class="text-green-400">‚úì Tracking complete</div>\n                <div class="mt-1 text-xs">\n                    Readings: ${e.readings.length} | Avg RSSI: ${n.toFixed(1)} dBm | \n                    Avg Distance: ${a.toFixed(2)}m\n                </div>\n            `,addConsoleMessage(`Movement tracking of ${s} complete`,"success"),updatePentestSummary("movement_tracking",e)}}catch(e){console.error("Movement tracking error:",e),t.innerHTML=`<div class="text-red-400">‚úó Error: ${e.message}</div>`,addConsoleMessage(`Movement tracking failed: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=r}}let pentestResults={};function updatePentestSummary(e,t){pentestResults[e]={timestamp:(new Date).toISOString(),data:t};const n=document.getElementById("pentest-summary"),a=document.getElementById("pentest-summary-content");if(!n||!a)return;n.classList.remove("hidden");const s=[];if(pentestResults.beacon_tracking&&s.push(`Beacon Tracking: ${pentestResults.beacon_tracking.data.beacons_found||0} beacons found`),pentestResults.exfiltration){const e=pentestResults.exfiltration.data;s.push(`Data Exfiltration: ${e.services?.length||0} services, ${e.files?.length||0} files`)}if(pentestResults.blueborne_scan){const e=pentestResults.blueborne_scan.data.vulnerable?"Vulnerable":"Safe";s.push(`BlueBorne Scan: ${e}`)}if(pentestResults.movement_tracking){const e=pentestResults.movement_tracking.data.readings?.length||0;s.push(`Movement Tracking: ${e} readings collected`)}a.innerHTML=s.map(e=>`<div>‚Ä¢ ${e}</div>`).join("")}async function downloadPentestReport(){try{const e=await fetchAPI("/api/bluetooth/pentest/report");if(!e||!e.timestamp)throw new Error("No report data available");{const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=window.URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`bluetooth_pentest_${Date.now()}.json`,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(n),document.body.removeChild(a),addConsoleMessage("Pentest report downloaded","success")}}catch(e){console.error("Report download error:",e),addConsoleMessage(`Failed to download report: ${e.message}`,"error")}}const DEFAULT_MANUAL_ATTACK_MATRIX={ssh:{label:"SSH Brute Force",ports:["22"]},ftp:{label:"FTP Brute Force",ports:["21"]},telnet:{label:"Telnet Brute Force",ports:["23"]},smb:{label:"SMB Brute Force",ports:["139","445"]},rdp:{label:"RDP Brute Force",ports:["3389"]},sql:{label:"SQL Brute Force",ports:["3306"]}};function hydrateManualAttackMatrix(e){const t={};return new Set([...Object.keys(DEFAULT_MANUAL_ATTACK_MATRIX),...e?Object.keys(e):[]]).forEach(n=>{const a=DEFAULT_MANUAL_ATTACK_MATRIX[n]||{},s=e&&e[n]||{},o=s.label||a.label||`${n.toUpperCase()} Attack`,r=Array.isArray(a.ports)?a.ports:[],i=Array.isArray(s.ports)?s.ports:[],l=(i.length?i:r).map(e=>String(e));l.length&&(t[n]={label:o,ports:l})}),Object.keys(t).length?t:{...DEFAULT_MANUAL_ATTACK_MATRIX}}function getManualAttackMatrix(){return window.manualAttackMatrix||{...DEFAULT_MANUAL_ATTACK_MATRIX}}function getValidActionsForPort(e){if(!e)return[];const t=String(e).trim(),n=getManualAttackMatrix();return Object.entries(n).filter(([,e])=>Array.isArray(e.ports)&&e.ports.map(String).includes(t)).map(([e,t])=>({key:e,label:t.label||e.toUpperCase()}))}function isActionAllowedOnPort(e,t){if(!e||!t)return!1;const n=String(t).trim(),a=getManualAttackMatrix()[e];return Boolean(a&&a.ports&&a.ports.map(String).includes(n))}function setManualActionHelper(e,t="muted"){const n=document.getElementById("manual-action-helper");if(!n)return;const a={muted:"text-gray-500",warning:"text-yellow-400",error:"text-red-400",success:"text-green-400"};n.textContent=e,n.className=`text-[11px] mt-1 ${a[t]||a.muted}`}function syncManualModeUI(e){manualModeActive=e;const t=document.getElementById("manual-mode-hint");t&&t.classList.toggle("hidden",e),document.querySelectorAll(".pentest-nav-btn").forEach(t=>{t.classList.toggle("hidden",!e)}),e||"pentest"!==currentTab||showTab("dashboard"),e?manualDataPrimed||(loadManualModeData(),manualDataPrimed=!0):manualDataPrimed=!1}async function loadManualModeData(){try{const e=document.getElementById("manual-ip-dropdown")?.value||"",t=document.getElementById("manual-port-dropdown")?.value||"",n=document.getElementById("manual-action-dropdown")?.value||"",a=document.getElementById("vuln-ip-dropdown")?.value||"all",s=await fetchAPI("/api/manual/targets");window.manualAttackMatrix=hydrateManualAttackMatrix(s.attack_matrix),window.manualActionPreference=n;const o=document.getElementById("manual-ip-dropdown");o&&(o.innerHTML='<option value="">Select IP</option>',s.targets&&s.targets.length>0&&s.targets.forEach(t=>{const n=document.createElement("option");n.value=t.ip,n.textContent=`${t.ip} (${t.hostname})`,t.ip===e&&(n.selected=!0),o.appendChild(n)}));const r=document.getElementById("vuln-ip-dropdown");if(r){r.innerHTML="";const e=document.createElement("option");e.value="all",e.textContent="All Targets","all"!==a&&a||(e.selected=!0),r.appendChild(e),s.targets&&s.targets.length>0&&s.targets.forEach(e=>{const t=document.createElement("option");t.value=e.ip,t.textContent=`${e.ip} (${e.hostname})`,e.ip===a&&(t.selected=!0),r.appendChild(t)})}const i=document.getElementById("manual-action-dropdown");i&&(i.innerHTML='<option value="">Select Action</option>',i.disabled=!0),window.manualTargetsData=s.targets||[],e?(updateManualPorts(),setTimeout(()=>{const e=document.getElementById("manual-port-dropdown");e&&t&&(e.value=t),updateManualActions()},50)):updateManualActions()}catch(e){console.error("Error loading Pentest Mode data:",e),addConsoleMessage("Failed to load Pentest Mode data","error")}}async function loadPentestData(){try{await loadManualModeData(),await refreshBluetoothStatus()}catch(e){console.error("Error loading pentest data:",e),addConsoleMessage("Failed to load pentest data","error")}}function updateManualPorts(){const e=document.getElementById("manual-ip-dropdown"),t=document.getElementById("manual-port-dropdown");if(!e||!t)return;const n=e.value;if(t.innerHTML='<option value="">Select Port</option>',n&&window.manualTargetsData){const e=window.manualTargetsData.find(e=>e.ip===n);e&&e.ports&&e.ports.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)})}t&&(t.value=""),updateManualActions()}function updateManualActions(){const e=document.getElementById("manual-port-dropdown"),t=document.getElementById("manual-action-dropdown");if(!t)return;const n=e?e.value:"",a=window.manualActionPreference||t.value||"";if(t.innerHTML='<option value="">Select Action</option>',t.disabled=!0,!n)return void setManualActionHelper("Select a port to view compatible attack modules.","muted");const s=getValidActionsForPort(n);if(!s.length)return setManualActionHelper(`No supported attack modules detected for port ${n}.`,"warning"),void(window.manualActionPreference="");s.forEach(e=>{const n=document.createElement("option");n.value=e.key,n.textContent=e.label,t.appendChild(n)}),t.disabled=!1,a&&s.some(e=>e.key===a)?t.value=a:(t.value="",window.manualActionPreference=""),t.value?(window.manualActionPreference=t.value,setManualActionHelper(`${t.options[t.selectedIndex].text} ready for port ${n}.`,"success")):setManualActionHelper(`Found ${s.length} compatible ${1===s.length?"action":"actions"} on port ${n}. Choose one to proceed.`,"success")}"undefined"!=typeof window&&(window.manualAttackMatrix={...DEFAULT_MANUAL_ATTACK_MATRIX},window.manualActionPreference="");const MANUAL_ATTACK_LOG_LIMIT=40;function setManualAttackStatus(e,t="info"){const n=document.getElementById("manual-attack-status"),a=document.getElementById("manual-attack-status-message");if(!n||!a)return;const s={success:"border-green-500/40 bg-green-900/30 text-green-200",error:"border-red-500/50 bg-red-900/40 text-red-200",warning:"border-yellow-500/40 bg-yellow-900/30 text-yellow-200",info:"border-slate-700 bg-slate-900/70 text-gray-200"};n.classList.remove("hidden"),a.className=`rounded-lg px-4 py-3 text-sm ${s[t]||s.info}`,a.textContent=e}function appendManualAttackLog(e,t="info"){const n=document.getElementById("manual-attack-live-log");if(!n)return;const a={success:"text-green-300",error:"text-red-300",warning:"text-yellow-300",info:"text-gray-300"};"true"!==n.dataset.initialized&&(n.innerHTML="",n.dataset.initialized="true"),n.classList.remove("hidden");const s=document.createElement("div");for(s.className=`flex text-xs font-mono ${a[t]||a.info}`,s.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,n.appendChild(s);n.childElementCount>40;)n.removeChild(n.firstChild);n.scrollTop=n.scrollHeight}function handleManualAttackUpdate(e){if(!e||!e.action&&!e.ip)return;const t=e.status||"info",n=e.stage||"info",a=(e.action||"attack").toUpperCase(),s=e.ip?`${e.ip}${e.port?`:${e.port}`:""}`:"target",o=e.message||`${a} update`;appendManualAttackLog(`${a} on ${s} ‚Ä¢ ${o}`,t),"running"===n?setManualAttackStatus(o,"info"):"completed"===n?setManualAttackStatus(o,t):"error"===n?setManualAttackStatus(o,"error"):"queued"===n&&setManualAttackStatus(o,"info")}async function executeManualAttack(){const e=document.getElementById("manual-ip-dropdown")?.value,t=document.getElementById("manual-port-dropdown")?.value,n=document.getElementById("manual-action-dropdown")?.value,a=document.getElementById("manual-attack-launch-btn"),s=(e,t)=>{a&&(a.disabled=!!e,a.classList.toggle("cursor-wait",!!e),e?(a.classList.remove("bg-orange-600","hover:bg-orange-700"),a.classList.add("bg-orange-500")):(a.classList.remove("bg-orange-500"),a.classList.add("bg-orange-600","hover:bg-orange-700")),a.textContent=t||(e?"Launching...":"Execute Attack"))};if(!e||!t||!n)return addConsoleMessage("Please select IP, Port, and Action for manual attack","error"),setManualAttackStatus("Please select a target IP, port, and action before launching.","error"),void appendManualAttackLog("Manual attack aborted - missing selections.","error");if(!isActionAllowedOnPort(n,t)){const e=getManualAttackMatrix(),t=(e[n]?.ports||[]).join(", "),a=`${n.toUpperCase()} brute force is only available on port(s): ${t||"restricted"}.`;return addConsoleMessage(a,"error"),setManualAttackStatus(a,"error"),void appendManualAttackLog("Manual attack blocked due to incompatible port selection.","error")}const o=`${n.toUpperCase()} on ${e}:${t}`;try{addConsoleMessage(`Executing manual attack: ${o}`,"info"),setManualAttackStatus(`Dispatching ${o}. This may take up to a minute depending on module output.`,"info"),s(!0,"Launching...");const a=await postAPI("/api/manual/execute-attack",{ip:e,port:t,action:n});if(a.success){const e=a.message||"Manual attack accepted";addConsoleMessage(e,"info"),setManualAttackStatus(`${e}. Awaiting live module output...`,"info"),appendManualAttackLog(e,"info")}else{const e=a.message||"Unknown error";addConsoleMessage(`Manual attack failed: ${e}`,"error"),setManualAttackStatus(`Manual attack failed: ${e}`,"error"),appendManualAttackLog(`Attack failed: ${e}`,"error")}setTimeout(()=>s(!1),1200)}catch(e){console.error("Error executing manual attack:",e),addConsoleMessage("Failed to execute manual attack due to network error","error"),setManualAttackStatus(`Network error launching manual attack: ${e.message}`,"error"),appendManualAttackLog(`Network error: ${e.message}`,"error"),s(!1,"Execute Attack")}}async function startOrchestrator(){const e=document.getElementById("system-control-status");try{e&&(e.classList.remove("hidden"),e.textContent="Enabling automation...",e.className="text-sm text-blue-600 mt-4"),addConsoleMessage("Enabling automation...","info");const t=await postAPI("/api/automation/orchestrator/start",{});if(t.success){const n=!1!==t.automation_enabled,a=n?"Auto":"Sleeping",s=n?"text-green-400 font-semibold":"text-purple-300 font-semibold";addConsoleMessage("Automation enabled successfully","success"),updateElement("Ragnar-mode",a);const o=document.getElementById("Ragnar-mode");o&&(o.className=s),e&&(e.textContent=n?"Automation enabled - Orchestrator running":"Automation queued - waiting for Wi-Fi",e.className=n?"text-sm text-green-600 mt-4":"text-sm text-yellow-500 mt-4",setTimeout(()=>{e&&e.classList.add("hidden")},3e3))}else addConsoleMessage(`Failed to start automatic mode: ${t.message||"Unknown error"}`,"error"),e&&(e.textContent=`Error: ${t.message||"Failed to start automatic mode"}`,e.className="text-sm text-red-600 mt-4")}catch(t){console.error("Error starting orchestrator:",t),addConsoleMessage("Failed to start automatic mode","error"),e&&(e.textContent=`Error: ${t.message}`,e.className="text-sm text-red-600 mt-4")}}async function stopOrchestrator(){const e=document.getElementById("system-control-status");try{e&&(e.classList.remove("hidden"),e.textContent="Stopping automatic mode...",e.className="text-sm text-orange-600 mt-4"),addConsoleMessage("Disabling automation...","info");const t=await postAPI("/api/automation/orchestrator/stop",{});if(t.success){addConsoleMessage("Automation disabled - Orchestrator sleeping","warning"),updateElement("Ragnar-mode","Sleeping");const t=document.getElementById("Ragnar-mode");t&&(t.className="text-purple-300 font-semibold"),e&&(e.textContent="Automation disabled - Ragnar is sleeping",e.className="text-sm text-orange-600 mt-4",setTimeout(()=>{e&&e.classList.add("hidden")},3e3))}else addConsoleMessage(`Failed to stop automatic mode: ${t.message||"Unknown error"}`,"error"),e&&(e.textContent=`Error: ${t.message||"Failed to stop automatic mode"}`,e.className="text-sm text-red-600 mt-4")}catch(t){console.error("Error stopping orchestrator:",t),addConsoleMessage("Failed to stop automatic mode","error"),e&&(e.textContent=`Error: ${t.message}`,e.className="text-sm text-red-600 mt-4")}}async function triggerNetworkScan(){const e=document.getElementById("system-control-status");try{e&&(e.classList.remove("hidden"),e.textContent="Initiating network discovery scan...",e.className="text-sm text-blue-600 mt-4"),addConsoleMessage("Triggering network scan...","info");const t=await postAPI("/api/manual/scan/network",{});t.success?(addConsoleMessage("Network scan triggered successfully","success"),e&&(e.textContent="Network scan started - Check Network tab for progress",e.className="text-sm text-green-600 mt-4",setTimeout(()=>{e&&e.classList.add("hidden")},4e3))):(addConsoleMessage(`Failed to trigger network scan: ${t.message||"Unknown error"}`,"error"),e&&(e.textContent=`Error: ${t.message||"Failed to trigger network scan"}`,e.className="text-sm text-red-600 mt-4"))}catch(t){console.error("Error triggering network scan:",t),addConsoleMessage("Failed to trigger network scan","error"),e&&(e.textContent=`Error: ${t.message}`,e.className="text-sm text-red-600 mt-4")}}async function triggerVulnScan(){const e=document.getElementById("system-control-status");try{const t=document.getElementById("vuln-ip-dropdown"),n=t?t.value:"all",a=!n||"all"===n,s=a?"all targets":n;e&&(e.classList.remove("hidden"),e.textContent=`Starting vulnerability scan for ${s}...`,e.className="text-sm text-purple-600 mt-4"),addConsoleMessage(`Triggering vulnerability scan for ${s}...`,"info");const o=await postAPI("/api/manual/scan/vulnerability",{ip:a?"all":n});o.success?(addConsoleMessage("Vulnerability scan triggered successfully","success"),e&&(e.textContent=`Vulnerability scan initiated for ${s} - Check Threat Intel tab in a few minutes`,e.className="text-sm text-green-600 mt-4",setTimeout(()=>{e&&e.classList.add("hidden")},4e3))):(addConsoleMessage(`Failed to trigger vulnerability scan: ${o.message||"Unknown error"}`,"error"),e&&(e.textContent=`Error: ${o.message||"Failed to trigger vulnerability scan"}`,e.className="text-sm text-red-600 mt-4"))}catch(t){console.error("Error triggering vulnerability scan:",t),addConsoleMessage("Failed to trigger vulnerability scan","error"),e&&(e.textContent=`Error: ${t.message}`,e.className="text-sm text-red-600 mt-4")}}async function runManualLynisPentest(){const e=document.getElementById("manual-lynis-ip"),t=document.getElementById("manual-lynis-username"),n=document.getElementById("manual-lynis-password"),a=document.getElementById("manual-lynis-status"),s=document.getElementById("manual-lynis-status-message"),o=document.getElementById("manual-lynis-btn");if(!e||!t||!n)return void addConsoleMessage("Manual Lynis form is missing elements","error");const r=e.value.trim(),i=t.value.trim(),l=n.value,c=(e,t="info")=>{if(!a||!s)return;const n={success:"border-green-500/40 bg-green-900/30 text-green-200",error:"border-red-500/50 bg-red-900/40 text-red-200",info:"border-slate-700 bg-slate-900/70 text-gray-200"};a.classList.remove("hidden"),s.className=`rounded-lg px-4 py-3 text-sm ${n[t]||n.info}`,s.textContent=e};if(!r||!i||!l)return void c("IP, username, and password are required to run Lynis manually.","error");if(!isValidIPv4(r))return void c("Please enter a valid IPv4 address.","error");const d=document.getElementById("lynis-audit-status");d&&(d.classList.remove("hidden"),d.textContent="Initializing Lynis audit...",d.className="text-sm text-blue-600 mt-2"),o&&(o.disabled=!0,o.textContent="Starting audit...",o.classList.add("bg-blue-600","cursor-wait"),o.classList.remove("bg-red-600","hover:bg-red-700"));try{const e=await fetch("/api/manual/pentest/lynis",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ip:r,username:i,password:l})});let t={};try{t=await e.json()}catch(e){console.warn("Unable to parse manual Lynis response JSON",e)}if(!e.ok||t&&!1===t.success)throw new Error(t&&(t.error||t.message)||`Request failed (${e.status})`);const a=t&&t.message||`Lynis pentest initiated for ${r}`;return c(a,"success"),addConsoleMessage(a,"success"),void(n.value="")}catch(e){console.error("Error running manual Lynis pentest:",e),c(`Failed to start Lynis pentest: ${e.message}`,"error"),addConsoleMessage(`Manual Lynis error: ${e.message}`,"error"),o&&(o.disabled=!1,o.textContent="Run Lynis Pentest",o.classList.remove("bg-blue-600","cursor-wait"),o.classList.add("bg-red-600","hover:bg-red-700")),d&&(d.textContent=`Error: ${e.message}`,d.className="text-sm text-red-600 mt-2")}}async function fetchAPI(e,t={}){try{const n=await fetch(e,t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(t){throw console.error(`Error fetching ${e}:`,t),t}}async function postAPI(e,t){try{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(t){throw console.error(`Error posting to ${e}:`,t),t}}async function refreshDashboard(){try{updateDashboardStatus(await fetchAPI("/api/status"))}catch(e){console.error("Error refreshing dashboard:",e)}}function updateDashboardStatus(e){0===(e.target_count||0)&&0===(e.port_count||0)&&0===(e.vulnerability_count||0)&&0===(e.credential_count||0)?fetchAPI("/api/dashboard/stats").then(e=>{updateDashboardStats(e)}).catch(()=>{updateDashboardStats(e)}):updateDashboardStats(e),updateElement("Ragnar-status",e.ragnar_status||"IDLE"),updateElement("Ragnar-says",e.ragnar_says||"Hacking away...");const t="boolean"==typeof e.automation_enabled?e.automation_enabled:!Boolean(e.manual_mode),n=Boolean(e.manual_mode);let a="Auto",s="text-green-400 font-semibold";t?n&&(a="Manual",s="text-orange-400 font-semibold"):(a="Sleeping",s="text-purple-300 font-semibold"),updateElement("Ragnar-mode",a);const o=document.getElementById("Ragnar-mode");o&&(o.className=s),syncManualModeUI(n),updateAutomationToggleButton(t),updateConnectivityIndicator("wifi-status",e.wifi_connected,e.current_ssid,e.ap_mode_active),updateConnectivityIndicator("bluetooth-status",e.bluetooth_active),updateConnectivityIndicator("usb-status",e.usb_active),updateConnectivityIndicator("pan-status",e.pan_connected),updateReleaseGateState(e.release_gate),updatePwnToggleAvailability(Boolean(e.headless_mode))}function updateAutomationToggleButton(e,t={}){const n=document.getElementById("automation-toggle-btn");if(!n)return;const{force:a=!1}=t;if("true"===n.dataset.busy&&!a)return void(n.dataset.pendingState=e?"enabled":"disabled");a&&delete n.dataset.pendingState;const s="w-full sm:w-auto px-4 py-2 rounded-lg font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900";e?(n.textContent="Disable Automation",n.className=`${s} bg-orange-600 hover:bg-orange-500 text-white focus:ring-orange-500`,n.dataset.action="stop"):(n.textContent="Enable Automation",n.className=`${s} bg-green-600 hover:bg-green-500 text-white focus:ring-green-500`,n.dataset.action="start")}async function handleAutomationToggle(){const e=document.getElementById("automation-toggle-btn");if(!e||"true"===e.dataset.busy)return;const t=e.dataset.action||"stop",n="start"===t;e.dataset.busy="true",e.disabled=!0,e.classList.add("opacity-70"),e.textContent="start"===t?"Enabling...":"Disabling...";try{"start"===t?(await startOrchestrator(),updateAutomationToggleButton(!0,{force:!0})):(await stopOrchestrator(),updateAutomationToggleButton(!1,{force:!0})),refreshDashboard().catch(()=>{})}catch(e){console.error("Automation toggle failed:",e),addConsoleMessage("Failed to toggle automation","error"),updateAutomationToggleButton(!n,{force:!0})}finally{if(e.dataset.busy="false",e.disabled=!1,e.classList.remove("opacity-70"),e.dataset.pendingState){const t="enabled"===e.dataset.pendingState;delete e.dataset.pendingState,updateAutomationToggleButton(t,{force:!0})}}}function updateElement(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}function scaleStatNumber(e,t,n={}){const a=document.getElementById(e);if(!a)return;const s={mediumDigits:3,largeDigits:4,baseClass:"text-3xl",mediumClass:"text-2xl",smallClass:"text-xl",...n},o=Number(t),r=Number.isFinite(o)?Math.trunc(o):0,i=Math.abs(r).toString().length;a.classList.remove(s.baseClass,s.mediumClass,s.smallClass),i>=s.largeDigits?a.classList.add(s.smallClass):i>=s.mediumDigits?a.classList.add(s.mediumClass):a.classList.add(s.baseClass)}function updateConnectivityIndicator(e,t,n=null,a=!1){const s=document.getElementById(e);if(s&&(s.className=t?"w-3 h-3 bg-green-500 rounded-full pulse-glow":"w-3 h-3 bg-gray-600 rounded-full"),"wifi-status"===e){const e=document.getElementById("wifi-ssid-display");e&&(a?(e.textContent=n?`AP Mode: ${n}`:"AP Mode",e.className="text-xs text-blue-400 truncate"):t&&n?(e.textContent=n,e.className="text-xs text-gray-400 truncate"):(e.textContent="Not connected",e.className="text-xs text-gray-500 truncate"))}}const MAX_CONSOLE_LINES=200,CONSOLE_NOISE_PATTERNS=["comment.py - INFO - Comments loaded successfully from cache"],HISTORY_LOG_TYPE_COLORS={success:"text-green-400",error:"text-red-400",warning:"text-yellow-400",info:"text-gray-300"};let consoleBuffer=[],lastConsoleLogLine=null;function addConsoleMessage(e,t="info"){const n={success:"text-green-400",error:"text-red-400",warning:"text-yellow-400",info:"text-blue-400"},a={timestamp:(new Date).toLocaleTimeString(),message:e,type:t,colorClass:n[t]||n.info};consoleBuffer.push(a),consoleBuffer.length>MAX_CONSOLE_LINES&&(consoleBuffer=consoleBuffer.slice(-MAX_CONSOLE_LINES)),updateConsoleDisplay()}function shouldHideConsoleLog(e){return CONSOLE_NOISE_PATTERNS.some(t=>e.includes(t))}function determineConsoleLogType(e){if(!e)return"info";const t=e.toLowerCase();return t.includes("error")?"error":t.includes("warn")?"warning":t.includes("success")?"success":"info"}const LOG_TIMESTAMP_PATTERN=/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/;function extractLogTimestamp(e){if(!e||e.length<19)return(new Date).toLocaleTimeString();const t=e.slice(0,19);if(LOG_TIMESTAMP_PATTERN.test(t)){const e=new Date(t.replace(" ","T"));if(!Number.isNaN(e.getTime()))return e.toLocaleTimeString()}return(new Date).toLocaleTimeString()}function createConsoleEntryFromLog(e){const t=determineConsoleLogType(e);return{timestamp:extractLogTimestamp(e),message:e,type:t,colorClass:HISTORY_LOG_TYPE_COLORS[t]||HISTORY_LOG_TYPE_COLORS.info}}function updateConsole(e){if(!e||!Array.isArray(e))return void(0===consoleBuffer.length&&(addConsoleMessage("No historical logs available","warning"),addConsoleMessage("New activity will appear here as it occurs","info")));if(0===e.length)return void(0===consoleBuffer.length&&(addConsoleMessage("No recent activity logged","info"),addConsoleMessage("Waiting for new events...","info")));const t=e.map(e=>"string"==typeof e?e.trim():"").filter(e=>e&&!shouldHideConsoleLog(e));if(0===t.length)return;let n=[];if(lastConsoleLogLine){const e=t.lastIndexOf(lastConsoleLogLine);if(e===t.length-1)return void(lastConsoleLogLine=t[t.length-1]);-1!==e?n=t.slice(e+1):(consoleBuffer=[],n=t.slice(-MAX_CONSOLE_LINES))}else consoleBuffer=[],n=t.slice(-MAX_CONSOLE_LINES);0!==n.length?(n.forEach(e=>{consoleBuffer.push(createConsoleEntryFromLog(e))}),consoleBuffer.length>MAX_CONSOLE_LINES&&(consoleBuffer=consoleBuffer.slice(-MAX_CONSOLE_LINES)),lastConsoleLogLine=t[t.length-1],updateConsoleDisplay()):lastConsoleLogLine=t[t.length-1]}function updateConsoleDisplay(){const e=document.getElementById("console-output");e&&(e.innerHTML=consoleBuffer.map(e=>`<div class="${e.colorClass}">[${e.timestamp}] ${escapeHtml(e.message)}</div>`).join(""),e.scrollTop=e.scrollHeight)}function clearConsole(){consoleBuffer=[];const e=document.getElementById("console-output");e&&(e.innerHTML='<div class="text-green-400">Console cleared</div>')}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function displayNetworkTable(e){const t=document.getElementById("network-table"),n=document.getElementById("network-hosts-table");if(!t||!n)return;n.querySelectorAll("tr[data-ip]").forEach(e=>{const t=e.getAttribute("data-ip");t&&saveDeepScanButtonState(t)}),n.innerHTML="";const a=Array.isArray(e)?e:e&&Array.isArray(e.hosts)?e.hosts:[];if(!a||0===a.length)return n.innerHTML='\n            <tr>\n                <td colspan="8" class="text-center py-8 text-gray-400">\n                    No network data available. Start a scan to discover hosts.\n                </td>\n            </tr>\n        ',void updateHostCountDisplay();a.forEach(e=>{const t=normalizeHostRecord(e);if(!t)return;const a=document.createElement("tr");a.setAttribute("data-ip",t.ip),a.className="border-b border-slate-700 hover:bg-slate-700/50 transition-colors",a.innerHTML=renderHostRow(t),n.appendChild(a),restoreDeepScanButtonState(t.ip)}),updateHostCountDisplay(),cleanupOldDeepScanStates()}function displayCredentialsTable(e){const t=document.getElementById("credentials-table");if(!t)return;if(!e||0===Object.keys(e).length)return void(t.innerHTML='<p class="text-gray-400">No credentials discovered yet</p>');let n='<div class="space-y-6">';Object.entries(e).forEach(([e,t])=>{t&&t.length>0&&(n+=`\n                <div class="bg-gray-800 rounded-lg p-4">\n                    <h3 class="text-lg font-semibold text-Ragnar-400 mb-3">${e.toUpperCase()} (${t.length})</h3>\n                    <div class="overflow-x-auto">\n                        <table class="min-w-full divide-y divide-gray-700">\n                            <thead>\n                                <tr>\n                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">Target</th>\n                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">Username</th>\n                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">Password</th>\n                                </tr>\n                            </thead>\n                            <tbody class="divide-y divide-gray-700">\n            `,t.forEach(e=>{n+=`\n                    <tr class="hover:bg-gray-700 transition-colors">\n                        <td class="px-4 py-2 text-sm text-white">${e.ip||"N/A"}</td>\n                        <td class="px-4 py-2 text-sm text-green-400 font-mono">${e.username||"N/A"}</td>\n                        <td class="px-4 py-2 text-sm text-yellow-400 font-mono">${e.password||"N/A"}</td>\n                    </tr>\n                `}),n+="\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            ")}),n+="</div>",t.innerHTML='<div class="space-y-6"></div>'===n?'<p class="text-gray-400">No credentials discovered yet</p>':n}function displayLootTable(e){const t=document.getElementById("loot-table");if(!t)return;if(!e||0===e.length)return void(t.innerHTML='<p class="text-gray-400">No loot data available</p>');const n=e.length>6,a=e.slice(0,6),s=n?e.slice(6):[];function o(e){const t=escapeHtml(e.filename||"Unknown File"),n=escapeHtml(e.size||"N/A"),a=escapeHtml(e.source||"Unknown"),s=escapeHtml(e.timestamp||"Unknown"),o=e.path?encodeURIComponent(e.path):"";return`\n            <button type="button" class="${"bg-gray-800 rounded-lg p-4 text-left hover:bg-gray-700 transition-colors w-full "+(o?"":"opacity-60 cursor-not-allowed")}" ${o?`onclick="openLootFile('${o}')"`:'disabled aria-disabled="true"'}>\n                <div class="flex items-center justify-between mb-2">\n                    <h3 class="text-lg font-semibold text-Ragnar-400 truncate" title="${t}">${t}</h3>\n                    <span class="text-xs text-gray-400 ml-2">${n}</span>\n                </div>\n                <div class="space-y-2 text-sm text-gray-300">\n                    <p><span class="text-gray-400">Source:</span> ${a}</p>\n                    <p><span class="text-gray-400">Timestamp:</span> ${s}</p>\n                </div>\n                ${o?'<p class="text-xs text-Ragnar-400 mt-3">Open in Files ‚Üí</p>':""}\n            </button>\n        `}let r='<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="loot-preview-items">';a.forEach(e=>{r+=o(e)}),r+="</div>",n&&(r+=`\n            <div class="mt-4">\n                <button onclick="toggleLootExpansion()" \n                        class="flex items-center justify-center w-full py-3 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors text-gray-300 hover:text-white">\n                    <span id="loot-expand-text">Show ${s.length} more items</span>\n                    <svg id="loot-expand-arrow" class="w-4 h-4 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>\n                    </svg>\n                </button>\n                <div id="loot-hidden-items" class="hidden mt-4">\n                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">\n        `,s.forEach(e=>{r+=o(e)}),r+="\n                    </div>\n                </div>\n            </div>\n        "),t.innerHTML=r}function toggleLootExpansion(){const e=document.getElementById("loot-hidden-items"),t=document.getElementById("loot-expand-text"),n=document.getElementById("loot-expand-arrow");if(!e||!t||!n)return;if(e.classList.contains("hidden"))e.classList.remove("hidden"),t.textContent="Show less",n.style.transform="rotate(180deg)";else{e.classList.add("hidden");const a=e.querySelectorAll("button").length;t.textContent=`Show ${a} more items`,n.style.transform="rotate(0deg)"}}function openLootFile(e){if(e)try{const t=decodeURIComponent(e);if(!t||"/data_stolen"===t)return void showNotification("Unable to locate that file. It may have been moved or deleted.","warning");const n=t.lastIndexOf("/");if(-1===n)return void showNotification("Invalid file path received for loot item.","error");const a=0===n?"/":t.substring(0,n),s=t.substring(n+1);if(!s)return void showNotification("Unable to determine file name for loot item.","error");pendingFileHighlight={directory:a,file:s},showTab("files"),loadFiles(a,s),showNotification(`Opening ${s} in Files tab`,"info")}catch(e){console.error("Failed to open loot file:",e),showNotification("Failed to open file from loot item.","error")}else showNotification("No file path available for this loot item.","warning")}function displayConfigForm(e){const t=document.getElementById("config-form");let n='<div class="space-y-6"><form id="config-update-form">';const a={General:["manual_mode","debug_mode","scan_vuln_running","scan_vuln_no_ports","enable_attacks","blacklistcheck"],Network:["network_max_failed_pings"],Timing:["startup_delay","web_delay","screen_delay","scan_interval"],Display:["epd_type","screen_reversed"]},s=["manual_mode","debug_mode","scan_vuln_running","scan_vuln_no_ports","enable_attacks","blacklistcheck","screen_reversed"],o=new Set(["network_max_failed_pings"]),r={network_max_failed_pings:15},i={scan_vuln_running:"handleVulnScanToggle(this)",enable_attacks:"handleEnableAttacksToggle(this)"};for(const[t,l]of Object.entries(a))n+=`\n            <div class="bg-slate-800 bg-opacity-50 rounded-lg p-4">\n                <h3 class="text-lg font-bold mb-4 text-Ragnar-400">${t}</h3>\n                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n        `,l.forEach(t=>{const a=Object.prototype.hasOwnProperty.call(e,t);let l=e[t];if(!a&&s.includes(t)&&(l="manual_mode"!==t),!a&&o.has(t)&&(l=r[t]),a||s.includes(t)||o.has(t)){const a=displaySelectOptions[t],s="boolean"==typeof l?"checkbox":"text",o=getConfigLabel(t),r=escapeHtml(getConfigDescription(t));if(Array.isArray(a)){const e="boolean"==typeof l?String(l):l??"";n+=`\n                        <div class="space-y-2">\n                            <label class="flex items-center gap-2 text-sm text-gray-400">\n                                ${o}\n                                <span class="info-icon" tabindex="0" role="button" aria-label="${r}" data-tooltip="${r}">‚ìò</span>\n                            </label>\n                            <select name="${t}" class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-Ragnar-500 focus:ring-1 focus:ring-Ragnar-500">\n                                ${a.map(t=>`<option value="${t.value}" ${t.value===String(e)?"selected":""}>${t.label}</option>`).join("")}\n                            </select>\n                        </div>\n                    `}else if("checkbox"===s){const a="scan_vuln_no_ports"!==t||e.scan_vuln_running?"":"disabled";n+=`\n                        <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-slate-700 hover:bg-opacity-50 transition-colors cursor-pointer ${a?"opacity-50 cursor-not-allowed":""}">\n                            <input type="checkbox" name="${t}" ${l?"checked":""} ${a}\n                                   class="w-5 h-5 rounded bg-slate-700 border-slate-600 text-Ragnar-500 focus:ring-Ragnar-500"\n                                   ${i[t]?`onchange="${i[t]}"`:""}>\n                            <span class="flex items-center gap-2">\n                                ${o}\n                                <span class="info-icon" tabindex="0" role="button" aria-label="${r}" data-tooltip="${r}">‚ìò</span>\n                            </span>\n                        </label>\n                    `}else n+=`\n                        <div class="space-y-2">\n                            <label class="flex items-center gap-2 text-sm text-gray-400">\n                                ${o}\n                                <span class="info-icon" tabindex="0" role="button" aria-label="${r}" data-tooltip="${r}">‚ìò</span>\n                            </label>\n                            <input type="${s}" name="${t}" value="${l}"\n                                   class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-Ragnar-500 focus:ring-1 focus:ring-Ragnar-500">\n                        </div>\n                    `}}),n+="</div></div>";n+='\n        <button type="submit" class="w-full bg-Ragnar-600 hover:bg-Ragnar-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">\n            Save Configuration\n        </button>\n    </form></div>',t.innerHTML=n,document.getElementById("config-update-form").addEventListener("submit",async e=>{e.preventDefault(),await saveConfig(e.target)});updateAttackWarningBanner(!e.hasOwnProperty("enable_attacks")||Boolean(e.enable_attacks))}function handleVulnScanToggle(e){const t=document.querySelector('input[name="scan_vuln_no_ports"]'),n=t?t.closest("label"):null;t&&(t.disabled=!e.checked,n&&(e.checked?n.classList.remove("opacity-50","cursor-not-allowed"):n.classList.add("opacity-50","cursor-not-allowed")))}function updateAttackWarningBanner(e){const t=document.getElementById("attack-warning");t&&(e?t.classList.remove("hidden"):t.classList.add("hidden"))}function handleEnableAttacksToggle(e){if(e.checked){if(!confirm("Warning: enabling automated attacks will run offensive actions (bruteforce, credential reuse, file theft) against discovered hosts. Do you have authorization to continue?"))return e.checked=!1,updateAttackWarningBanner(!1),addConsoleMessage("Automated attacks remain disabled.","warning"),void showNotification("Automated attacks remain disabled.","info");showNotification("Automated attacks are enabled. Ensure you are authorized before proceeding.","warning"),addConsoleMessage("Automated attacks enabled. Ragnar will launch offensive actions on discovered hosts.","warning")}else addConsoleMessage("Automated attacks disabled.","info");updateAttackWarningBanner(e.checked)}async function saveConfig(e){const t=new FormData(e),n={},a=e.querySelectorAll('input[type="checkbox"]');a.forEach(e=>{n[e.name]=!1});for(const[a,s]of t.entries()){const t=e.elements[a];"checkbox"===t.type?n[a]=t.checked:"true"===s||"false"===s?n[a]="true"===s:isNaN(s)||""===s?n[a]=s:n[a]=Number(s)}a.forEach(e=>{n[e.name]=e.checked}),console.log("Saving config:",n);try{await postAPI("/api/config",n);addConsoleMessage("Configuration saved successfully","success"),n.hasOwnProperty("manual_mode")&&setTimeout(()=>{refreshDashboard()},500)}catch(e){console.error("Config save error:",e),addConsoleMessage("Failed to save configuration","error")}}async function loadAIConfiguration(e){const t=document.getElementById("ai-enabled-toggle");if(t){const n=!(!e||!Object.prototype.hasOwnProperty.call(e,"ai_enabled"))&&Boolean(e.ai_enabled);t.checked=n}try{const e=await fetchAPI("/api/ai/token"),t=document.getElementById("openai-api-token");t&&(e.configured&&e.token_preview?(t.value="",t.placeholder=`Configured: ${e.token_preview}`):(t.value="",t.placeholder="sk-..."))}catch(e){console.error("Failed to fetch AI token status:",e)}}async function toggleAIEnabled(){const e=document.getElementById("ai-enabled-toggle"),t=document.getElementById("ai-config-status"),n=document.getElementById("ai-config-status-message");if(!e||!t||!n)return;const a=e.checked,s={ai_enabled:a};try{const e=await postAPI("/api/config",s);if(a&&e&&!1===e.ai_reload_success)throw new Error(e.ai_reload_error||"AI engine failed to initialize. Check server logs.");t.className=a?"p-3 rounded-lg text-sm bg-green-900/30 border border-green-700":"p-3 rounded-lg text-sm bg-blue-900/30 border border-blue-700",n.textContent=a?"‚úì AI Insights enabled. Ragnar will request GPT analysis for dashboards.":"‚Ñπ AI Insights disabled. Ragnar will stop requesting GPT analysis until re-enabled.",t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},4e3),"dashboard"===currentTab&&setTimeout(()=>{loadAIInsights().catch(e=>console.error("Failed to refresh AI insights after toggle:",e))},500)}catch(s){console.error("Failed to toggle AI insights:",s),e.checked=!a,t.className="p-3 rounded-lg text-sm bg-red-900/30 border border-red-700",n.textContent=`‚úó Failed to ${a?"enable":"disable"} AI Insights (${s.message||"unknown error"})`,t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},5e3)}}async function saveAIToken(){const e=document.getElementById("openai-api-token"),t=document.getElementById("ai-config-status"),n=document.getElementById("ai-config-status-message"),a=e.value.trim();if(!a)return t.className="p-3 rounded-lg text-sm bg-yellow-900/30 border border-yellow-700",n.textContent="‚ö† Please enter an API token.",t.classList.remove("hidden"),void setTimeout(()=>t.classList.add("hidden"),3e3);try{const e=await postAPI("/api/ai/token",{token:a});if(!e.success)throw new Error(e.message||"Failed to save token");{t.className="p-3 rounded-lg text-sm bg-green-900/30 border border-green-700";let a=e.message||"‚úì API token saved to .bashrc successfully. AI features are now ready to use.";e.user&&(a+=` (User: ${e.user})`),n.textContent=a,t.classList.remove("hidden"),addConsoleMessage("OpenAI API token saved to environment variable","success");const s=await fetchAPI("/api/config");await loadAIConfiguration(s),setTimeout(()=>{t.classList.add("hidden")},8e3),"dashboard"===currentTab&&setTimeout(()=>refreshDashboard(),500)}}catch(e){console.error("Failed to save AI token:",e),t.className="p-3 rounded-lg text-sm bg-red-900/30 border border-red-700",n.textContent=`‚úó Failed to save API token: ${e.message||"Please try again."}`,t.classList.remove("hidden")}}async function loadEpaperDisplay(){try{const e=await fetchAPI("/api/epaper-display");if(updateElement("epaper-status-1",e.status_text||"Unknown"),updateElement("epaper-status-2",e.status_text2||"Unknown"),e.timestamp){updateElement("epaper-timestamp",new Date(1e3*e.timestamp).toLocaleString())}const t=document.getElementById("epaper-display-image"),n=document.getElementById("epaper-loading"),a=document.getElementById("epaper-connection");e.image?(t.src=e.image,t.style.display="block",n.style.display="none",e.width&&e.height&&updateElement("epaper-resolution",`${e.width} x ${e.height}`),a.textContent="Live",a.className="text-green-400 font-medium"):(t.style.display="none",n.style.display="flex",n.innerHTML=`\n                <div class="text-center text-gray-600">\n                    <svg class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                    </svg>\n                    <p>${e.message||"No display image available"}</p>\n                </div>\n            `,a.textContent="Offline",a.className="text-red-400 font-medium")}catch(e){console.error("Error loading e-paper display:",e),addConsoleMessage("Failed to load e-paper display","error");const t=document.getElementById("epaper-connection");t.textContent="Error",t.className="text-red-400 font-medium"}}function refreshEpaperDisplay(){addConsoleMessage("Refreshing e-paper display...","info"),loadEpaperDisplay()}let epaperSizeMode="large";function toggleEpaperSize(){const e=document.getElementById("epaper-display-image");"large"===epaperSizeMode?(e.style.maxHeight="1200px",e.style.minHeight="600px",epaperSizeMode="xlarge",addConsoleMessage("E-paper display size: Extra Large","info")):"xlarge"===epaperSizeMode?(e.style.maxHeight="600px",e.style.minHeight="300px",epaperSizeMode="medium",addConsoleMessage("E-paper display size: Medium","info")):(e.style.maxHeight="800px",e.style.minHeight="400px",epaperSizeMode="large",addConsoleMessage("E-paper display size: Large","info"))}function setupEpaperAutoRefresh(){setInterval(()=>{"epaper"===currentTab&&loadEpaperDisplay()},5e3)}let systemMonitoringInterval,currentDirectory="/",fileOperationInProgress=!1;function loadFiles(e="/",t=null){if(fileOperationInProgress)return;const n=t||(pendingFileHighlight&&pendingFileHighlight.directory===e?pendingFileHighlight.file:null);fetch(`/api/files/list?path=${encodeURIComponent(e)}`).then(e=>e.json()).then(t=>{displayFiles(t,e,n);updateCurrentPath(e),n&&(pendingFileHighlight=null)}).catch(e=>{console.error("Error loading files:",e),showFileError("Failed to load files: "+e.message)})}function displayFiles(e,t,n=null){const a=document.getElementById("file-list");if(currentDirectory=t,!a)return!1;if(0===e.length)return a.innerHTML='<p class="text-gray-400 p-4">No files found in this directory</p>',!1;let s='<div class="space-y-2">';if("/"!==t){const e=t.split("/").slice(0,-1).join("/")||"/";s+=`\n            <div class="flex items-center p-3 hover:bg-slate-700 rounded-lg cursor-pointer transition-colors" onclick="loadFiles('${e}')">\n                <svg class="w-5 h-5 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>\n                </svg>\n                <span class="text-blue-400">.. (Parent Directory)</span>\n            </div>\n        `}if(e.sort((e,t)=>e.is_directory&&!t.is_directory?-1:!e.is_directory&&t.is_directory?1:e.name.toLowerCase().localeCompare(t.name.toLowerCase())),e.forEach(e=>{const t=e.is_directory?'<svg class="w-5 h-5 mr-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-5l-2-2H5a2 2 0 00-2 2z"></path>\n            </svg>':'<svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>\n            </svg>',n=e.is_directory?"":formatBytes(e.size),a=e.modified?new Date(1e3*e.modified).toLocaleDateString():"",o=encodeURIComponent(e.name);s+=`\n            <div class="flex items-center justify-between p-3 hover:bg-slate-700 rounded-lg transition-colors" data-file-key="${o}">\n                <div class="flex items-center cursor-pointer flex-1" onclick="${e.is_directory?`loadFiles('${e.path}')`:""}">\n                    ${t}\n                    <div class="flex-1">\n                        <div class="font-medium">${e.name}</div>\n                        ${!e.is_directory&&n?`<div class="text-sm text-gray-400">${n} ‚Ä¢ ${a}</div>`:""}\n                    </div>\n                </div>\n                ${e.is_directory?"":`\n                    <div class="flex space-x-2">\n                        <button onclick="downloadFile('${e.path}')" class="p-2 text-blue-400 hover:bg-slate-600 rounded" title="Download">\n                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4m6 4H6"></path>\n                            </svg>\n                        </button>\n                        <button onclick="deleteFile('${e.path}')" class="p-2 text-red-400 hover:bg-slate-600 rounded" title="Delete">\n                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>\n                            </svg>\n                        </button>\n                    </div>\n                `}\n            </div>\n        `}),s+="</div>",a.innerHTML=s,n){const e=encodeURIComponent(n),s=a.querySelector(`[data-file-key="${e}"]`);if(s)return s.classList.add("ring-2","ring-Ragnar-500","ring-offset-2","ring-offset-slate-900"),s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{s.classList.remove("ring-2","ring-Ragnar-500","ring-offset-2","ring-offset-slate-900")},4e3),!0;addConsoleMessage(`Could not highlight ${n} under ${t}`,"warning")}return!1}function displayDirectoryTree(){const e=document.getElementById("directory-tree");if(!e)return;let t='<div class="space-y-1">';[{name:"Data Stolen",path:"/data_stolen",icon:"üóÉÔ∏è"},{name:"Scan Results",path:"/scan_results",icon:"üìä"},{name:"Cracked Passwords",path:"/crackedpwd",icon:"üîì"},{name:"Vulnerabilities",path:"/vulnerabilities",icon:"‚ö†Ô∏è"},{name:"Logs",path:"/logs",icon:"üìã"},{name:"Backups",path:"/backups",icon:"üíæ"},{name:"Uploads",path:"/uploads",icon:"üì§"}].forEach(e=>{t+=`\n            <div class="flex items-center p-3 hover:bg-slate-700 rounded-lg cursor-pointer transition-colors" onclick="loadFiles('${e.path}')">\n                <span class="mr-3">${e.icon}</span>\n                <span>${e.name}</span>\n            </div>\n        `}),t+="</div>",e.innerHTML=t}function updateCurrentPath(e){const t=document.getElementById("current-path");t&&(t.textContent=e)}function downloadFile(e){if(fileOperationInProgress)return;const t=`/api/files/download?path=${encodeURIComponent(e)}`,n=document.createElement("a");n.href=t,n.download="",document.body.appendChild(n),n.click(),document.body.removeChild(n),showFileSuccess(`Downloading ${e.split("/").pop()}`)}function deleteFile(e){if(fileOperationInProgress)return;const t=e.split("/").pop();showFileConfirmModal("Delete File",`Are you sure you want to delete "${t}"? This action cannot be undone.`,()=>{fileOperationInProgress=!0,fetch("/api/files/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})}).then(e=>e.json()).then(e=>{e.success?(showFileSuccess(`Deleted ${t}`),refreshFiles()):showFileError(`Failed to delete file: ${e.error}`)}).catch(e=>{showFileError(`Error deleting file: ${e.message}`)}).finally(()=>{fileOperationInProgress=!1,closeFileModal()})})}function uploadFile(){const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=function(e){const t=e.target.files;if(0===t.length)return;const n=new FormData;for(let e of t)n.append("file",e);n.append("path","/uploads"),fileOperationInProgress=!0,showFileLoading("Uploading files..."),fetch("/api/files/upload",{method:"POST",body:n}).then(e=>e.json()).then(e=>{e.success?(showFileSuccess(`Uploaded ${t.length} file(s)`),refreshFiles()):showFileError(`Upload failed: ${e.error}`)}).catch(e=>{showFileError(`Upload error: ${e.message}`)}).finally(()=>{fileOperationInProgress=!1})},e.click()}function clearFiles(){showFileConfirmModal("Clear Files",'\n        <div class="space-y-3">\n            <p>Choose the type of file clearing:</p>\n            <div class="space-y-2">\n                <label class="flex items-center">\n                    <input type="radio" name="clearType" value="light" checked class="mr-2">\n                    <span>Light Clear (logs, temporary files only)</span>\n                </label>\n                <label class="flex items-center">\n                    <input type="radio" name="clearType" value="full" class="mr-2">\n                    <span>Full Clear (all data including configs)</span>\n                </label>\n            </div>\n        </div>\n        ',()=>{const e=document.querySelector('input[name="clearType"]:checked')?.value||"light";fileOperationInProgress=!0,showFileLoading("Clearing files..."),fetch("/api/files/clear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:e})}).then(e=>e.json()).then(e=>{e.success?(showFileSuccess(e.message),refreshFiles()):showFileError(`Clear failed: ${e.error}`)}).catch(e=>{showFileError(`Clear error: ${e.message}`)}).finally(()=>{fileOperationInProgress=!1,closeFileModal()})})}function refreshFiles(){displayDirectoryTree(),loadFiles(currentDirectory)}function showFileSuccess(e){showNotification(e,"success")}function showFileError(e){showNotification(e,"error")}function showFileLoading(e){showNotification(e,"info")}function showFileConfirmModal(e,t,n){const a=document.getElementById("file-operations-modal"),s=document.getElementById("modal-title"),o=document.getElementById("modal-content"),r=document.getElementById("modal-confirm");if(!(a&&s&&o&&r))return;s.textContent=e,o.innerHTML=t;const i=r.cloneNode(!0);r.parentNode.replaceChild(i,r),i.addEventListener("click",n),a.classList.remove("hidden"),a.classList.add("flex")}function closeFileModal(){const e=document.getElementById("file-operations-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))}function formatBytes(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function showNotification(e,t){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-4 rounded-lg max-w-sm transform translate-x-full transition-transform duration-300 ${"success"===t?"bg-green-600":"error"===t?"bg-red-600":"bg-blue-600"} text-white`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.transform="translateX(0)"},100),setTimeout(()=>{n.style.transform="translateX(100%)",setTimeout(()=>{document.body.removeChild(n)},300)},3e3)}let currentProcessSort="cpu";function loadSystemData(){fetchSystemStatus(),fetchNetworkStats(),systemMonitoringInterval&&clearInterval(systemMonitoringInterval),systemMonitoringInterval=setInterval(()=>{"system"===currentTab&&(fetchSystemStatus(),fetchNetworkStats())},5e3)}function fetchSystemStatus(){fetch("/api/system/status").then(e=>e.json()).then(e=>{e.error?showSystemError("Failed to load system status: "+e.error):(updateSystemOverview(e),updateProcessList(e.processes),updateNetworkInterfaces(e.network_interfaces),updateTemperatureDisplay(e.temperatures))}).catch(e=>{console.error("Error fetching system status:",e),showSystemError("Failed to load system status")})}function fetchNetworkStats(){fetch("/api/system/network-stats").then(e=>e.json()).then(e=>{e.error?console.error("Network stats error:",e.error):updateNetworkStats(e)}).catch(e=>{console.error("Error fetching network stats:",e)})}function updateSystemOverview(e){const t=document.getElementById("cpu-usage"),n=document.getElementById("cpu-details"),a=document.getElementById("cpu-progress");t&&(t.textContent=`${e.cpu.percent}%`),n&&(n.textContent=`${e.cpu.count} cores`),a&&(a.style.width=`${e.cpu.percent}%`);const s=document.getElementById("memory-usage"),o=document.getElementById("memory-details"),r=document.getElementById("memory-progress");if(s&&(s.textContent=`${e.memory.percent}%`),o&&(o.textContent=`${e.memory.used_formatted} / ${e.memory.total_formatted}`),r&&(r.style.width=`${e.memory.percent}%`),e.swap){const t=document.getElementById("swap-usage"),n=document.getElementById("swap-details"),a=document.getElementById("swap-progress"),s=Number.isFinite(e.swap.percent)?e.swap.percent:0;t&&(t.textContent=`${s}%`),n&&(n.textContent=`${e.swap.used_formatted} / ${e.swap.total_formatted}`),a&&(a.style.width=`${s}%`)}const i=document.getElementById("disk-usage"),l=document.getElementById("disk-details"),c=document.getElementById("disk-progress");i&&(i.textContent=`${e.disk.percent}%`),l&&(l.textContent=`${e.disk.used_formatted} / ${e.disk.total_formatted}`),c&&(c.style.width=`${e.disk.percent}%`);const d=document.getElementById("uptime-display");d&&(d.textContent=e.uptime.formatted)}function updateProcessList(e){const t=document.getElementById("process-list");if(!t)return;if(0===e.length)return void(t.innerHTML='<p class="text-gray-400 text-center py-4">No process data available</p>');let n="";e.slice(0,10).forEach(e=>{const t=(e.cpu_percent||0).toFixed(1),a=(e.memory_percent||0).toFixed(1);n+=`\n            <div class="flex items-center justify-between p-2 bg-slate-800 rounded text-sm">\n                <div class="flex-1 truncate">\n                    <span class="font-medium">${e.name}</span>\n                    <span class="text-gray-400 ml-2">PID: ${e.pid}</span>\n                </div>\n                <div class="flex space-x-3 text-xs">\n                    <span class="text-blue-400">${t}% CPU</span>\n                    <span class="text-green-400">${a}% MEM</span>\n                </div>\n            </div>\n        `}),t.innerHTML=n}function updateNetworkInterfaces(e){const t=document.getElementById("network-interfaces");if(!t)return;if(0===e.length)return void(t.innerHTML='<p class="text-gray-400 text-center py-4">No network interfaces found</p>');let n="";e.forEach(e=>{const t=e.is_up?"text-green-400":"text-red-400",a=e.is_up?"UP":"DOWN";n+=`\n            <div class="border border-gray-700 rounded p-3">\n                <div class="flex items-center justify-between mb-2">\n                    <span class="font-medium">${e.name}</span>\n                    <span class="${t} text-xs">${a}</span>\n                </div>\n                <div class="text-xs text-gray-400 space-y-1">\n                    ${e.speed>0?`<div>Speed: ${e.speed} Mbps</div>`:""}\n                    ${e.addresses.map(e=>`<div>${e.address} (${e.family})</div>`).join("")}\n                </div>\n            </div>\n        `}),t.innerHTML=n}function updateNetworkStats(e){const t=document.getElementById("network-stats");if(!t)return;let n="";n+=`\n        <div class="bg-slate-800 rounded p-3">\n            <h4 class="font-medium mb-2">Connections</h4>\n            <div class="text-2xl font-bold text-blue-400">${e.total_connections}</div>\n            <div class="text-xs text-gray-400">Total active</div>\n        </div>\n    `,Object.entries(e.interfaces).slice(0,4).forEach(([e,t])=>{n+=`\n            <div class="bg-slate-800 rounded p-3">\n                <h4 class="font-medium mb-2">${e}</h4>\n                <div class="text-xs space-y-1">\n                    <div class="flex justify-between">\n                        <span class="text-gray-400">Sent:</span>\n                        <span class="text-green-400">${t.bytes_sent_formatted}</span>\n                    </div>\n                    <div class="flex justify-between">\n                        <span class="text-gray-400">Received:</span>\n                        <span class="text-blue-400">${t.bytes_recv_formatted}</span>\n                    </div>\n                    <div class="flex justify-between">\n                        <span class="text-gray-400">Packets:</span>\n                        <span>${t.packets_sent+t.packets_recv}</span>\n                    </div>\n                </div>\n            </div>\n        `}),t.innerHTML=n}function updateTemperatureDisplay(e){const t=document.getElementById("temperature-section"),n=document.getElementById("temperature-display");if(!t||!n)return;if(0===Object.keys(e).length)return void t.classList.add("hidden");t.classList.remove("hidden");let a="";Object.entries(e).forEach(([e,t])=>{a+=`\n            <div class="bg-slate-800 rounded p-3">\n                <h4 class="font-medium mb-1 text-sm">${e}</h4>\n                <div class="text-xl font-bold ${t>70?"text-red-400":t>50?"text-yellow-400":"text-green-400"}">${t.toFixed(1)}¬∞C</div>\n            </div>\n        `}),n.innerHTML=a}function sortProcesses(e){currentProcessSort=e,document.querySelectorAll(".process-sort-btn").forEach(t=>{t.dataset.sort===e?(t.classList.remove("bg-gray-600"),t.classList.add("bg-Ragnar-600")):(t.classList.remove("bg-Ragnar-600"),t.classList.add("bg-gray-600"))}),fetch(`/api/system/processes?sort=${e}`).then(e=>e.json()).then(e=>{updateProcessList(e)}).catch(e=>{console.error("Error sorting processes:",e)})}function refreshSystemStatus(){fetchSystemStatus(),fetchNetworkStats(),showSystemSuccess("System status refreshed")}function showSystemSuccess(e){showNotification(e,"success")}function showSystemError(e){showNotification(e,"error")}let currentNetkbFilter="all",netkbData=[];function loadNetkbData(){fetchNetkbData()}function fetchNetkbData(){fetch("/api/netkb/data").then(e=>e.json()).then(e=>{e.error?showNetkbError("Failed to load NetKB data: "+e.error):(netkbData=e.entries||[],updateNetkbStatistics(e.statistics||{}),displayNetkbData(netkbData))}).catch(e=>{console.error("Error fetching NetKB data:",e),showNetkbError("Failed to load NetKB data")})}function updateNetkbStatistics(e){const t=document.getElementById("netkb-total-entries"),n=document.getElementById("netkb-vulnerabilities"),a=document.getElementById("netkb-services"),s=document.getElementById("netkb-hosts");t&&(t.textContent=e.total_entries||0),n&&(n.textContent=e.vulnerabilities||0),a&&(a.textContent=e.services||0),s&&(s.textContent=e.unique_hosts||0)}function displayNetkbData(e){const t=document.getElementById("netkb-table-body");if(!t)return;if(0===e.length)return void(t.innerHTML='<tr><td colspan="7" class="text-center text-gray-400 py-8">No NetKB entries found</td></tr>');let n="";e.forEach(e=>{const t=getSeverityColor(e.severity),a=getTypeIcon(e.type),s=new Date(1e3*e.discovered).toLocaleDateString();n+=`\n            <tr class="border-b border-gray-800 hover:bg-slate-800 cursor-pointer" onclick="showNetkbEntryDetail('${e.id}')">\n                <td class="p-3">\n                    <span class="inline-flex items-center">\n                        ${a}\n                        <span class="ml-2 capitalize">${e.type}</span>\n                    </span>\n                </td>\n                <td class="p-3 font-mono text-sm">${e.host}</td>\n                <td class="p-3 font-mono text-sm">${e.port||"-"}</td>\n                <td class="p-3">\n                    <span class="font-medium">${e.service||e.description}</span>\n                    <div class="text-xs text-gray-400 mt-1">${e.description}</div>\n                </td>\n                <td class="p-3">\n                    <span class="px-2 py-1 rounded text-xs font-medium ${t}">\n                        ${e.severity}\n                    </span>\n                </td>\n                <td class="p-3 text-sm text-gray-400">${s}</td>\n                <td class="p-3">\n                    <div class="flex space-x-2">\n                        <button onclick="event.stopPropagation(); showNetkbEntryDetail('${e.id}')" \n                                class="text-blue-400 hover:text-blue-300 text-xs">\n                            View\n                        </button>\n                        ${"vulnerability"===e.type?`<button onclick="event.stopPropagation(); researchVulnerability('${e.cve||e.id}')" \n                                     class="text-orange-400 hover:text-orange-300 text-xs">\n                                Research\n                            </button>`:""}\n                    </div>\n                </td>\n            </tr>\n        `}),t.innerHTML=n}function getSeverityColor(e){switch(e.toLowerCase()){case"critical":return"bg-red-900 text-red-200";case"high":return"bg-red-800 text-red-100";case"medium":return"bg-yellow-800 text-yellow-100";case"low":return"bg-blue-800 text-blue-100";case"info":return"bg-gray-700 text-gray-200";default:return"bg-gray-600 text-gray-200"}}function getTypeIcon(e){switch(e.toLowerCase()){case"vulnerability":return'<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';case"service":return'<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>';case"host":return'<svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>';case"exploit":return'<svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>';default:return'<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'}}function filterNetkbData(e){currentNetkbFilter=e,document.querySelectorAll(".netkb-filter-btn").forEach(t=>{t.dataset.filter===e?(t.classList.remove("bg-gray-600"),t.classList.add("bg-Ragnar-600")):(t.classList.remove("bg-Ragnar-600"),t.classList.add("bg-gray-600"))});let t=netkbData;"all"!==e&&(t=netkbData.filter(t=>t.type===e)),displayNetkbData(t)}function searchNetkbData(e){displayNetkbData(netkbData.filter(t=>{const n=e.toLowerCase();return t.host.toLowerCase().includes(n)||t.service.toLowerCase().includes(n)||t.description.toLowerCase().includes(n)||t.type.toLowerCase().includes(n)}))}function clearNetkbSearch(){const e=document.getElementById("netkb-search");e&&(e.value="",filterNetkbData(currentNetkbFilter))}function showNetkbEntryDetail(e){const t=netkbData.find(t=>t.id===e);if(!t)return;const n=document.getElementById("netkb-detail-modal"),a=document.getElementById("netkb-detail-title"),s=document.getElementById("netkb-detail-content");if(!n||!a||!s)return;a.textContent=`${t.type.toUpperCase()}: ${t.host}`;const o=new Date(1e3*t.discovered).toLocaleString(),r=getSeverityColor(t.severity);s.innerHTML=`\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n            <div class="space-y-3">\n                <div>\n                    <label class="text-sm text-gray-400">Host/Target</label>\n                    <div class="font-mono text-lg">${t.host}</div>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">Service/Port</label>\n                    <div class="font-mono">${t.port||"N/A"} ${t.service?"("+t.service+")":""}</div>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">Type</label>\n                    <div class="capitalize">${t.type}</div>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">Severity</label>\n                    <div><span class="px-2 py-1 rounded text-sm ${r}">${t.severity}</span></div>\n                </div>\n            </div>\n            <div class="space-y-3">\n                <div>\n                    <label class="text-sm text-gray-400">Description</label>\n                    <div class="text-sm">${t.description}</div>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">Source</label>\n                    <div class="text-sm">${t.source}</div>\n                </div>\n                <div>\n                    <label class="text-sm text-gray-400">Discovered</label>\n                    <div class="text-sm">${o}</div>\n                </div>\n                ${t.cve?`\n                <div>\n                    <label class="text-sm text-gray-400">CVE</label>\n                    <div class="font-mono text-sm">${t.cve}</div>\n                </div>\n                `:""}\n            </div>\n        </div>\n        \n        <div class="mt-6 p-4 bg-slate-800 rounded-lg">\n            <h4 class="font-medium mb-2">Recommendations</h4>\n            <ul class="text-sm text-gray-300 space-y-1">\n                <li>‚Ä¢ Monitor this ${t.type} regularly for changes</li>\n                <li>‚Ä¢ Consider implementing additional security measures</li>\n                <li>‚Ä¢ Review access controls and firewall rules</li>\n                ${"vulnerability"===t.type?"<li>‚Ä¢ Apply security patches if available</li>":""}\n                ${"service"===t.type?"<li>‚Ä¢ Ensure service is properly configured and updated</li>":""}\n            </ul>\n        </div>\n    `;const i=document.getElementById("netkb-exploit-btn");i&&("vulnerability"===t.type?(i.classList.remove("hidden"),i.onclick=()=>exploitVulnerability(t)):i.classList.add("hidden"));const l=document.getElementById("netkb-research-btn");l&&(l.onclick=()=>researchEntry(t)),n.classList.remove("hidden"),n.classList.add("flex")}function closeNetkbModal(){const e=document.getElementById("netkb-detail-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))}function refreshNetkbData(){fetchNetkbData(),showNetkbSuccess("NetKB data refreshed")}function exportNetkbData(){const e=prompt("Export format (json/csv):","json");!e||"json"!==e&&"csv"!==e||(window.open(`/api/netkb/export?format=${e}`,"_blank"),showNetkbSuccess(`NetKB data exported as ${e.toUpperCase()}`))}function exportNetkbEntry(){showNetkbInfo("Individual entry export feature coming soon")}function researchEntry(e){let t="";t=e.cve?e.cve:e.service?`${e.service} vulnerability exploit`:`${e.host} ${e.description}`,window.open("https://www.google.com/search?q="+encodeURIComponent(t),"_blank"),showNetkbInfo(`Researching: ${t}`)}function researchVulnerability(e){window.open("https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&query="+encodeURIComponent(e),"_blank"),showNetkbInfo(`Researching vulnerability: ${e}`)}function exploitVulnerability(e){const t=`Are you sure you want to attempt exploitation of ${e.cve||e.description} on ${e.host}?`;confirm(t)&&showNetkbInfo("Exploitation feature not yet implemented - this would trigger automated exploit attempts")}function showNetkbSuccess(e){showNotification(e,"success")}function showNetkbError(e){showNotification(e,"error")}function showNetkbInfo(e){showNotification(e,"info")}async function loadThreatIntelData(){try{const e=await fetch("/api/vulnerabilities/grouped");if(e.ok){displayGroupedVulnerabilities(await e.json())}else{const e=await fetch("/api/vulnerabilities");if(e.ok){displayFallbackVulnerabilities(await e.json())}}}catch(e){console.error("Error loading vulnerability data:",e);const t=document.getElementById("grouped-vulnerabilities-container");t&&(t.innerHTML=`\n                <div class="glass rounded-lg p-6 text-center">\n                    <p class="text-red-400">Error loading vulnerabilities</p>\n                    <p class="text-slate-400 text-sm mt-2">${e.message}</p>\n                </div>\n            `)}}function displayGroupedVulnerabilities(e){const t=document.getElementById("grouped-vulnerabilities-container"),n=document.getElementById("threat-intel-vulnerable-hosts-count");n&&(n.textContent=e.total_hosts||0),document.getElementById("total-vulnerabilities-count").textContent=e.total_vulnerabilities||0;let a=0,s=0;if(e.grouped_vulnerabilities&&e.grouped_vulnerabilities.forEach(e=>{a+=e.severity_counts.critical||0,s+=e.severity_counts.high||0}),document.getElementById("critical-vuln-count").textContent=a,document.getElementById("high-vuln-count").textContent=s,!e.grouped_vulnerabilities||0===e.grouped_vulnerabilities.length)return void(t.innerHTML='\n            <div class="glass rounded-lg p-6 text-center">\n                <svg class="w-16 h-16 mx-auto mb-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <h3 class="text-xl font-semibold text-white mb-2">No Vulnerabilities Found</h3>\n                <p class="text-slate-400">All discovered hosts appear to be secure!</p>\n            </div>\n        ');let o="";e.grouped_vulnerabilities.forEach((e,t)=>{const n=e.severity_counts,a=e.total_vulnerabilities;let s="blue",r="Low Risk";n.critical>0?(s="red",r="Critical Risk"):n.high>5?(s="orange",r="High Risk"):n.high>0&&(s="yellow",r="Medium Risk"),o+=`\n            <div class="glass rounded-lg p-6">\n                \x3c!-- Host Header --\x3e\n                <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-700">\n                    <div class="flex items-center space-x-4">\n                        <div class="bg-${s}-500/20 p-3 rounded-lg">\n                            <svg class="w-8 h-8 text-${s}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>\n                            </svg>\n                        </div>\n                        <div>\n                            <h3 class="text-2xl font-bold text-white">${e.ip}</h3>\n                            <p class="text-sm text-slate-400">\n                                <span class="bg-${s}-500/20 text-${s}-300 px-2 py-1 rounded text-xs font-semibold">${r}</span>\n                                <span class="ml-2">${a} Vulnerabilities Found</span>\n                            </p>\n                        </div>\n                    </div>\n                    <button onclick="toggleHostDetails('host-${t}')" class="bg-Ragnar-600 hover:bg-Ragnar-700 text-white px-4 py-2 rounded-lg transition-colors">\n                        <span id="host-${t}-toggle">Show Details</span>\n                    </button>\n                </div>\n                \n                \x3c!-- Quick Stats --\x3e\n                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">\n                    <div class="bg-slate-800/50 rounded-lg p-3">\n                        <div class="text-red-400 text-2xl font-bold">${n.critical||0}</div>\n                        <div class="text-xs text-slate-400">Critical</div>\n                    </div>\n                    <div class="bg-slate-800/50 rounded-lg p-3">\n                        <div class="text-orange-400 text-2xl font-bold">${n.high||0}</div>\n                        <div class="text-xs text-slate-400">High</div>\n                    </div>\n                    <div class="bg-slate-800/50 rounded-lg p-3">\n                        <div class="text-yellow-400 text-2xl font-bold">${n.medium||0}</div>\n                        <div class="text-xs text-slate-400">Medium</div>\n                    </div>\n                    <div class="bg-slate-800/50 rounded-lg p-3">\n                        <div class="text-blue-400 text-2xl font-bold">${n.low||0}</div>\n                        <div class="text-xs text-slate-400">Low</div>\n                    </div>\n                </div>\n                \n                \x3c!-- Affected Services --\x3e\n                <div class="mb-4">\n                    <div class="text-sm text-slate-400 mb-2">Affected Services</div>\n                    <div class="flex flex-wrap gap-2">\n                        ${e.affected_services.map(e=>`<span class="bg-slate-700 px-3 py-1 rounded-full text-sm">${e}</span>`).join("")}\n                    </div>\n                    <div class="text-sm text-slate-400 mt-2">\n                        Ports: ${e.affected_ports.join(", ")}\n                    </div>\n                </div>\n                \n                \x3c!-- Detailed Vulnerabilities (Initially Hidden) --\x3e\n                <div id="host-${t}-details" class="hidden mt-4">\n                    <div class="border-t border-slate-700 pt-4">\n                        <h4 class="text-lg font-semibold mb-3 text-white">All Vulnerabilities (${a})</h4>\n                        <div class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin">\n                            ${e.vulnerabilities.map(e=>{const t={critical:"red",high:"orange",medium:"yellow",low:"blue"}[e.severity]||"gray",n=e.vulnerability.length>100?e.vulnerability.substring(0,100)+"...":e.vulnerability;return`\n                                    <div class="bg-slate-800/30 rounded p-3 hover:bg-slate-800/50 transition-colors">\n                                        <div class="flex items-start justify-between">\n                                            <div class="flex-1">\n                                                <div class="flex items-center space-x-2 mb-1">\n                                                    <span class="bg-${t}-500/20 text-${t}-300 px-2 py-0.5 rounded text-xs font-semibold uppercase">${e.severity}</span>\n                                                    <span class="text-slate-400 text-xs">${e.service}:${e.port}</span>\n                                                </div>\n                                                <div class="text-sm text-white font-mono">${n}</div>\n                                            </div>\n                                            <button onclick='showVulnerabilityDetails(${JSON.stringify(e).replace(/'/g,"\\'")})' \n                                                    class="ml-2 text-Ragnar-400 hover:text-Ragnar-300 text-xs">\n                                                Details\n                                            </button>\n                                        </div>\n                                    </div>\n                                `}).join("")}\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}),t.innerHTML=o}function toggleHostDetails(e){const t=document.getElementById(`${e}-details`),n=document.getElementById(`${e}-toggle`);t.classList.contains("hidden")?(t.classList.remove("hidden"),n.textContent="Hide Details"):(t.classList.add("hidden"),n.textContent="Show Details")}function showVulnerabilityDetails(e){const t=document.getElementById("vulnerability-detail-modal");document.getElementById("vuln-detail-content").innerHTML=`\n        <div class="space-y-4">\n            <div class="bg-slate-800/50 rounded-lg p-4">\n                <div class="text-sm text-slate-400 mb-1">Severity</div>\n                <div class="${{critical:"text-red-400",high:"text-orange-400",medium:"text-yellow-400",low:"text-blue-400"}[e.severity]} text-2xl font-bold uppercase">${e.severity}</div>\n            </div>\n            \n            <div class="bg-slate-800/50 rounded-lg p-4">\n                <div class="text-sm text-slate-400 mb-1">Vulnerability</div>\n                ${function(e){const t=e.match(/(CVE-\d{4}-\d{4,7})/gi);if(!t||0===t.length)return`<div class="text-white font-mono text-sm break-all">${e}</div>`;let n='<div class="mt-3 pt-3 border-t border-slate-700">';return n+='<div class="text-sm text-slate-400 mb-2">CVE References:</div>',n+='<div class="flex flex-wrap gap-2">',[...new Set(t)].forEach(e=>{n+=`\n                <div class="bg-slate-700/50 rounded px-3 py-2 flex items-center space-x-2">\n                    <span class="text-Ragnar-400 font-mono text-sm">${e}</span>\n                    <a href="${`https://nvd.nist.gov/vuln/detail/${e}`}" target="_blank" rel="noopener noreferrer" \n                       class="text-blue-400 hover:text-blue-300 transition-colors" \n                       title="View on NIST NVD">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" \n                                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>\n                        </svg>\n                    </a>\n                    <a href="${`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${e}`}" target="_blank" rel="noopener noreferrer" \n                       class="text-green-400 hover:text-green-300 transition-colors" \n                       title="View on MITRE">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" \n                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                        </svg>\n                    </a>\n                </div>\n            `}),n+="</div></div>",`<div class="text-white font-mono text-sm break-all">${e}</div>${n}`}(e.vulnerability)}\n            </div>\n            \n            <div class="grid grid-cols-2 gap-4">\n                <div class="bg-slate-800/50 rounded-lg p-4">\n                    <div class="text-sm text-slate-400 mb-1">Service</div>\n                    <div class="text-white">${e.service}</div>\n                </div>\n                <div class="bg-slate-800/50 rounded-lg p-4">\n                    <div class="text-sm text-slate-400 mb-1">Port</div>\n                    <div class="text-white">${e.port}</div>\n                </div>\n            </div>\n            \n            <div class="bg-slate-800/50 rounded-lg p-4">\n                <div class="text-sm text-slate-400 mb-1">Discovered</div>\n                <div class="text-white">${new Date(e.discovered).toLocaleString()}</div>\n            </div>\n            \n            <div class="bg-slate-800/50 rounded-lg p-4">\n                <div class="text-sm text-slate-400 mb-1">Status</div>\n                <div class="text-white capitalize">${e.status}</div>\n            </div>\n        </div>\n    `,t.classList.remove("hidden"),t.classList.add("flex")}function closeVulnerabilityModal(){const e=document.getElementById("vulnerability-detail-modal");e.classList.add("hidden"),e.classList.remove("flex")}function displayFallbackVulnerabilities(e){const t={};e.vulnerabilities&&e.vulnerabilities.forEach(e=>{t[e.host]||(t[e.host]={ip:e.host,total_vulnerabilities:0,severity_counts:{critical:0,high:0,medium:0,low:0},affected_ports:new Set,affected_services:new Set,vulnerabilities:[]}),t[e.host].total_vulnerabilities++,t[e.host].severity_counts[e.severity]++,t[e.host].affected_ports.add(e.port),t[e.host].affected_services.add(e.service),t[e.host].vulnerabilities.push(e)});const n=Object.values(t).map(e=>({...e,affected_ports:Array.from(e.affected_ports),affected_services:Array.from(e.affected_services)}));displayGroupedVulnerabilities({total_hosts:n.length,total_vulnerabilities:e.vulnerabilities?.length||0,grouped_vulnerabilities:n})}async function triggerManualVulnScan(){try{addConsoleMessage("Starting vulnerability scan on all discovered hosts...","info");const e=await fetchAPI("/api/threat-intelligence/trigger-vuln-scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:"all"})});"vulnerability_scan_triggered"===e.action?(addConsoleMessage(`‚úÖ ${e.message}`,"success"),addConsoleMessage(`üìã Scanning ${e.discovered_hosts} discovered hosts`,"info"),e.next_steps&&e.next_steps.forEach(e=>{addConsoleMessage(`   ‚Ä¢ ${e}`,"info")}),showNotification(`Vulnerability scan started on ${e.discovered_hosts} hosts. Check back in a few minutes!`,"success"),setTimeout(()=>{"threat-intel"===currentTab&&(loadThreatIntelData(),addConsoleMessage("üîÑ Checking for new threat intelligence findings...","info"))},3e4),setTimeout(()=>{"threat-intel"===currentTab&&(loadThreatIntelData(),addConsoleMessage("üîç Final check for vulnerability scan results...","info"))},12e4)):(addConsoleMessage("‚ùå Failed to start vulnerability scan","error"),showNotification("Failed to start vulnerability scan","error"))}catch(e){console.error("Error triggering vulnerability scan:",e),addConsoleMessage("‚ùå Error starting vulnerability scan: "+e.message,"error"),showNotification("Error starting vulnerability scan","error")}}function refreshThreatIntel(){showNotification("Refreshing threat intelligence...","info"),"threat-intel"===currentTab&&loadThreatIntelData()}function updateThreatIntelStats(e){document.getElementById("threat-sources-count").textContent=e.active_sources||0,document.getElementById("enriched-findings-count").textContent=e.enriched_findings_count||0,document.getElementById("high-risk-count").textContent=e.high_risk_count||0,document.getElementById("active-campaigns-count").textContent=e.active_campaigns||0;const t=e.risk_distribution||{};document.getElementById("critical-risk-count").textContent=t.critical||0,document.getElementById("high-risk-detail-count").textContent=t.high||0,document.getElementById("medium-risk-count").textContent=t.medium||0,document.getElementById("low-risk-count").textContent=t.low||0;const n=e.source_status||{};updateSourceStatus("cisa-status",n.cisa_kev||!1),updateSourceStatus("nvd-status",n.nvd_cve||!1),updateSourceStatus("otx-status",n.alienvault_otx||!1),updateSourceStatus("mitre-status",n.mitre_attack||!1),updateTopThreatsList(e.top_threats||[],e.last_update||e.last_intelligence_update||null)}function updateSourceStatus(e,t){const n=document.getElementById(e);n&&(n.className="w-3 h-3 rounded-full "+(t?"bg-green-400":"bg-red-400"))}function updateEnrichedFindingsTable(e){const t=document.getElementById("enriched-findings-table");e&&0!==e.length?t.innerHTML=e.map(e=>`\n        <tr class="border-b border-slate-700 hover:bg-slate-700/50">\n            <td class="py-3 px-4 text-white font-mono">${escapeHtml(e.target)}</td>\n            <td class="py-3 px-4">\n                <span class="px-2 py-1 rounded text-xs font-medium ${getRiskScoreClass(e.risk_score)}">\n                    ${e.risk_score}/100\n                </span>\n            </td>\n            <td class="py-3 px-4 text-slate-300 max-w-xs truncate" title="${escapeHtml(e.threat_context||"N/A")}">\n                ${escapeHtml(e.threat_context||"N/A")}\n            </td>\n            <td class="py-3 px-4 text-slate-300">${escapeHtml(e.attribution||"Unknown")}</td>\n            <td class="py-3 px-4 text-slate-400">${formatTimestamp(e.last_updated)}</td>\n            <td class="py-3 px-4">\n                <button onclick="downloadThreatReport('${e.target}')" \n                        class="text-blue-400 hover:text-blue-300 text-sm">\n                    Report\n                </button>\n            </td>\n        </tr>\n    `).join(""):t.innerHTML=`\n            <tr>\n                <td colspan="6" class="text-center py-12 text-slate-400">\n                    <div class="space-y-4">\n                        <div class="text-xl">üõ°Ô∏è No Threat Intelligence Findings</div>\n                        <div class="text-sm max-w-md mx-auto space-y-2">\n                            <p>Threat intelligence enrichment requires vulnerability discoveries first.</p>\n                            <p class="text-cyan-400">üìã Steps to generate threat intelligence:</p>\n                            <ol class="text-left text-xs space-y-1 mt-2">\n                                <li>1. Wait for network discovery to complete (${document.getElementById("target-count")?.textContent||"0"} hosts found)</li>\n                                <li>2. Run vulnerability scans on discovered hosts</li>\n                                <li>3. Threat intelligence will enrich discovered vulnerabilities</li>\n                            </ol>\n                            <div class="mt-4">\n                                <button onclick="triggerManualVulnScan()" class="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded text-sm transition-colors">\n                                    üöÄ Start Vulnerability Scan\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `}function updateTopThreatsList(e,t){const n=document.getElementById("top-threats-list"),a=document.getElementById("top-threats-updated");n&&(a&&(a.textContent=`Last updated: ${t?formatTimestamp(t):"N/A"}`),e&&0!==e.length?n.innerHTML=e.slice(0,5).map(e=>`\n        <li class="bg-slate-800/60 rounded-lg p-4 flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">\n            <div class="space-y-1">\n                <p class="text-white font-semibold">${escapeHtml(e.target||"Unknown Target")}</p>\n                <p class="text-slate-400 text-sm">${escapeHtml(e.summary||"No summary available")}</p>\n                <div class="text-xs text-slate-500 space-x-3">\n                    <span>Last Seen: ${formatTimestamp(e.last_seen)}</span>\n                    ${e.attribution?`<span>Attributed to: ${escapeHtml(e.attribution)}</span>`:""}\n                </div>\n            </div>\n            <span class="self-start sm:self-center px-2 py-1 rounded text-xs font-semibold ${getRiskScoreClass(e.risk_score)}">\n                ${e.risk_score}/100\n            </span>\n        </li>\n    `).join(""):n.innerHTML='\n            <li class="text-slate-400 text-center py-4">\n                <div class="space-y-2">\n                    <div>üõ°Ô∏è No active threats detected</div>\n                    <div class="text-xs">Threat intelligence will appear here when vulnerabilities are discovered and enriched</div>\n                </div>\n            </li>\n        ')}function getRiskScoreClass(e){return e>=90?"bg-red-600 text-white":e>=70?"bg-orange-600 text-white":e>=50?"bg-yellow-600 text-black":"bg-green-600 text-white"}async function enrichTarget(){const e=document.getElementById("enrichment-target"),t=e.value.trim();if(t)try{showNotification(`Enriching target: ${t}...`,"info");const n=await fetch("/api/threat-intelligence/enrich-target",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:t})});if(n.ok){showNotification(`Target enriched successfully. Risk score: ${(await n.json()).risk_score}/100`,"success"),e.value="","threat-intel"===currentTab&&loadThreatIntelData()}else{showNotification(`Enrichment failed: ${(await n.json()).error}`,"error")}}catch(e){console.error("Error enriching target:",e),showNotification("Error enriching target","error")}else showNotification("Please enter a target (IP, domain, or hash)","error")}async function downloadThreatReport(e){try{showNotification(`Analyzing ${e} for threat intelligence...`,"info");const t=await fetch("/api/threat-intelligence/download-report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:e})});if(t.ok){const n=await t.blob(),a=window.URL.createObjectURL(n),s=document.createElement("a");s.href=a;const o=(new Date).toISOString().slice(0,19).replace(/:/g,"-");s.download=`Threat_Intelligence_Report_${e.replace(/[^a-zA-Z0-9.-]/g,"_")}_${o}.txt`,document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(a),document.body.removeChild(s),showNotification(`Threat intelligence report downloaded for ${e}`,"success")}else{const n=await t.json();"no_findings"===n.target_type?showNotification(`No vulnerability findings detected for ${e} - run network scans first to discover vulnerabilities for threat intelligence enrichment`,"warning"):showNotification(`Failed to generate report: ${n.error}`,"error")}}catch(e){console.error("Error downloading threat report:",e),showNotification("Error downloading threat intelligence report","error")}}function formatTimestamp(e){if(!e)return"N/A";try{return new Date(e).toLocaleString()}catch(e){return"Invalid date"}}function escapeHtml(e){if("string"!=typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}function formatAIText(e){if(!e||"string"!=typeof e)return"";const t=escapeHtml(e).split("\n"),n=[];let a=!1;for(let e=0;e<t.length;e++){let s=t[e].trim();if(s){if(s.match(/^\*\*(.+?)\*\*:?$/)){a&&(n.push("</ul>"),a=!1);const e=s.replace(/^\*\*(.+?)\*\*:?$/,"$1");n.push(`<div class="font-bold text-sky-300 mt-4 mb-2">${e}</div>`);continue}if(s.match(/^[\-\*‚Ä¢]\s+(.+)$/)){a||(n.push('<ul class="list-disc list-inside space-y-1 ml-4 text-gray-300">'),a=!0);const e=s.replace(/^[\-\*‚Ä¢]\s+(.+)$/,"$1");n.push(`<li>${e}</li>`);continue}if(s.match(/^\d+\.\s+/)){a||(n.push('<ul class="list-decimal list-inside space-y-2 ml-4 text-gray-300">'),a=!0);let e=s.replace(/^\d+\.\s+/,"");e=e.replace(/\*\*(.+?)\*\*/g,'<strong class="text-sky-200">$1</strong>'),n.push(`<li class="mb-1">${e}</li>`);continue}a&&(n.push("</ul>"),a=!1),s=s.replace(/\*\*(.+?)\*\*/g,'<strong class="text-sky-200">$1</strong>'),n.push(`<p class="mb-2 text-gray-300">${s}</p>`)}else a&&(n.push("</ul>"),a=!1),n.push('<div class="mb-3"></div>')}return a&&n.push("</ul>"),n.join("")}window.loadConsoleLogs=loadConsoleLogs,window.clearConsole=clearConsole,window.refreshEpaperDisplay=refreshEpaperDisplay,window.toggleEpaperSize=toggleEpaperSize,window.checkForUpdates=checkForUpdates,window.checkForUpdatesQuiet=checkForUpdatesQuiet,window.performUpdate=performUpdate,window.handleReleaseGateDecision=handleReleaseGateDecision,window.restartService=restartService,window.rebootSystem=rebootSystem,window.startAPMode=startAPMode,window.refreshWifiStatus=refreshWifiStatus,window.updateManualPorts=updateManualPorts,window.executeManualAttack=executeManualAttack,window.startOrchestrator=startOrchestrator,window.stopOrchestrator=stopOrchestrator,window.triggerNetworkScan=triggerNetworkScan,window.triggerVulnScan=triggerVulnScan,window.refreshDashboard=refreshDashboard,window.loadWifiInterfaces=loadWifiInterfaces,window.scanWifiNetworks=scanWifiNetworks,window.openWifiConnectModal=openWifiConnectModal,window.closeWifiConnectModal=closeWifiConnectModal,window.togglePasswordVisibility=togglePasswordVisibility,window.connectToWifiNetwork=connectToWifiNetwork,window.refreshBluetoothStatus=refreshBluetoothStatus,window.toggleBluetoothPower=toggleBluetoothPower,window.toggleBluetoothDiscoverable=toggleBluetoothDiscoverable,window.startBluetoothScan=startBluetoothScan,window.showBluetoothDeviceDetails=showBluetoothDeviceDetails,window.closeBluetoothDeviceModal=closeBluetoothDeviceModal,window.pairBluetoothDevice=pairBluetoothDevice,window.enumerateBluetoothServices=enumerateBluetoothServices,window.clearBluetoothDevices=clearBluetoothDevices,window.loadFiles=loadFiles,window.downloadFile=downloadFile,window.deleteFile=deleteFile,window.uploadFile=uploadFile,window.clearFiles=clearFiles,window.refreshFiles=refreshFiles,window.closeFileModal=closeFileModal,window.openLootFile=openLootFile,window.loadSystemData=loadSystemData,window.sortProcesses=sortProcesses,window.refreshSystemStatus=refreshSystemStatus,window.loadDashboardData=loadDashboardData,window.updateDashboardStats=updateDashboardStats,window.loadNetkbData=loadNetkbData,window.refreshNetkbData=refreshNetkbData,window.filterNetkbData=filterNetkbData,window.searchNetkbData=searchNetkbData,window.clearNetkbSearch=clearNetkbSearch,window.showNetkbEntryDetail=showNetkbEntryDetail,window.closeNetkbModal=closeNetkbModal,window.exportNetkbData=exportNetkbData,window.exportNetkbEntry=exportNetkbEntry,window.researchEntry=researchEntry,window.researchVulnerability=researchVulnerability,window.exploitVulnerability=exploitVulnerability,window.triggerDeepScan=triggerDeepScan,window.handleCustomDeepScanRequest=handleCustomDeepScanRequest,window.testDeepScan=testDeepScan,window.debugDeepScanStates=function(){console.log("Current deep scan button states:",Object.fromEntries(deepScanButtonStates))},window.loadThreatIntelData=loadThreatIntelData,window.refreshThreatIntel=refreshThreatIntel,window.enrichTarget=enrichTarget,window.updateThreatIntelStats=updateThreatIntelStats,window.toggleHostDetails=toggleHostDetails,window.showVulnerabilityDetails=showVulnerabilityDetails,window.closeVulnerabilityModal=closeVulnerabilityModal;let aiInsightsCache={data:null,timestamp:null,ttl:36e5};async function loadAIInsights(){try{const e=Date.now();if(aiInsightsCache.data&&aiInsightsCache.timestamp){const t=e-aiInsightsCache.timestamp;if(t<aiInsightsCache.ttl)return console.log(`AI insights cached (${Math.floor(t/1e3)}s old, refreshes in ${Math.floor((aiInsightsCache.ttl-t)/1e3)}s)`),void displayAIInsights(aiInsightsCache.data)}const t=await fetch("/api/ai/status"),n=await t.json(),a=document.getElementById("ai-insights-section"),s=document.getElementById("ai-not-configured");if(!n.enabled||!n.configured)return a&&(a.style.display="none"),s&&(s.style.display="block"),aiInsightsCache.data=null,void(aiInsightsCache.timestamp=null);a&&(a.style.display="block"),s&&(s.style.display="none");const o=document.getElementById("ai-model-name");o&&n.model&&(o.textContent=n.model),console.log("Fetching fresh AI insights from server...");const r=await fetch("/api/ai/insights"),i=await r.json();aiInsightsCache.data=i,aiInsightsCache.timestamp=e,displayAIInsights(i)}catch(e){console.error("Error loading AI insights:",e)}}function displayAIInsights(e){if(e.enabled){const t=document.getElementById("ai-network-summary");t&&(t.innerHTML=formatAIText(e.network_summary||"Analyzing network..."));const n=document.getElementById("ai-vuln-section"),a=document.getElementById("ai-vuln-summary"),s=document.getElementById("ai-vuln-details"),o=document.getElementById("ai-vuln-toggle");if(a&&s)if(e.vulnerability_analysis){const{summary:t,details:r}=splitAIContent(e.vulnerability_analysis);a.innerHTML=formatAIText(t),s.innerHTML=formatAIText(r),o&&r.trim()?o.style.display="flex":o&&(o.style.display="none"),n&&(n.style.display="block")}else a.textContent="No vulnerabilities detected",s.innerHTML="",o&&(o.style.display="none"),n&&(n.style.display="block");const r=document.getElementById("ai-weakness-section"),i=document.getElementById("ai-weakness-summary"),l=document.getElementById("ai-weakness-details"),c=document.getElementById("ai-weakness-toggle");if(i&&l)if(e.weakness_analysis){const{summary:t,details:n}=splitAIContent(e.weakness_analysis);i.innerHTML=formatAIText(t),l.innerHTML=formatAIText(n),c&&n.trim()?c.style.display="flex":c&&(c.style.display="none"),r&&(r.style.display="block")}else i.textContent="Analyzing network topology...",l.innerHTML="",c&&(c.style.display="none"),r&&(r.style.display="block");const d=document.getElementById("ai-last-update");if(d&&aiInsightsCache.timestamp){const e=Math.floor((Date.now()-aiInsightsCache.timestamp)/1e3),t=Math.floor((aiInsightsCache.ttl-(Date.now()-aiInsightsCache.timestamp))/1e3);d.textContent=e<60?`Updated ${e}s ago (next refresh in ${Math.floor(t/60)}m)`:`Updated ${Math.floor(e/60)}m ago (next refresh in ${Math.floor(t/60)}m)`}}}async function refreshAIInsights(){try{aiInsightsCache.data=null,aiInsightsCache.timestamp=null,await fetch("/api/ai/clear-cache",{method:"POST"});const e=document.getElementById("ai-network-summary"),t=document.getElementById("ai-vuln-summary"),n=document.getElementById("ai-weakness-summary");e&&(e.textContent="Generating new AI analysis..."),t&&(t.textContent="Analyzing vulnerabilities..."),n&&(n.textContent="Identifying network weaknesses..."),await loadAIInsights(),showNotification("AI insights refreshed successfully","success")}catch(e){console.error("Error refreshing AI insights:",e),showNotification("Failed to refresh AI insights","error")}}function splitAIContent(e){if(!e||"string"!=typeof e)return{summary:"",details:""};const t=e.split(/\n\n+/);if(t.length<=1)return e.length<=200?{summary:e,details:""}:{summary:e.substring(0,200)+"...",details:e};return{summary:t[0],details:t.slice(1).join("\n\n")}}function toggleAISection(e){const t=`ai-${e}-details`,n=`ai-${e}-toggle-text`,a=`ai-${e}-toggle-icon`,s=document.getElementById(t),o=document.getElementById(n),r=document.getElementById(a);if(!s)return;"none"===s.style.display?(s.style.display="block",o&&(o.textContent="Show Less"),r&&r.classList.add("rotate-180")):(s.style.display="none",o&&(o.textContent="Show More"),r&&r.classList.remove("rotate-180"))}