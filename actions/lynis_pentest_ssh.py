"""
lynis_pentest_ssh.py - Executes a Lynis pentest audit on hosts with confirmed SSH credentials.
"""

import os
import time
import logging
import paramiko
from datetime import datetime
from shared import SharedData
from logger import Logger


logger = Logger(name="lynis_pentest_ssh.py", level=logging.DEBUG)

b_class = "LynisPentestSSH"
b_module = "lynis_pentest_ssh"
b_status = "lynis_pentest_ssh"
b_parent = "SSHBruteforce"
b_port = 22


class LynisPentestSSH:
	"""Run Lynis in pentest mode against hosts compromised via SSH."""

	def __init__(self, shared_data):
		self.shared_data = shared_data
		self.ssh_timeout = 25
		self.command_timeout = 900  # Lynis can take a while
		logger.info("LynisPentestSSH initialized")

	def execute(self, ip, port, row, status_key):
		try:
			parent_status = row.get(getattr(self, 'b_parent_action', ''), '')
			if 'success' not in parent_status:
				logger.info(f"Skipping Lynis audit for {ip}; parent action not successful")
				return 'failed'

			credentials = self._load_credentials(ip)
			if not credentials:
				logger.warning(f"No SSH credentials available for {ip}; cannot run Lynis")
				return 'failed'

			self.shared_data.ragnarorch_status = b_class
			time.sleep(2)

			os.makedirs(self.shared_data.vulnerabilities_dir, exist_ok=True)

			for username, password in credentials:
				if self.shared_data.orchestrator_should_exit:
					logger.info("Orchestrator requested stop; aborting Lynis runs")
					break
				try:
					with self._connect(ip, username, password) as ssh:
						if not self._ensure_lynis_available(ssh, password):
							continue
						report_path = self._run_lynis(ssh, password, ip, username)
						if report_path:
							logger.success(
								f"Lynis pentest report saved for {ip} using {username}: {report_path}"
							)
							return 'success'
				except Exception as exc:
					logger.error(f"Lynis run failed for {ip} with {username}: {exc}")

			logger.error(f"Unable to produce Lynis report for {ip}")
			return 'failed'
		except Exception as exc:
			logger.error(f"Unexpected LynisPentestSSH error for {ip}:{port}: {exc}")
			return 'failed'

	# ------------------------------------------------------------------
	# Helper functions
	# ------------------------------------------------------------------

	def _load_credentials(self, ip):
		creds = []
		if not os.path.exists(self.shared_data.sshfile):
			return creds
		try:
			with open(self.shared_data.sshfile, 'r', encoding='utf-8') as handle:
				lines = handle.readlines()[1:]
			for line in lines:
				parts = line.strip().split(',')
				if len(parts) < 5:
					continue
				if parts[1] == ip:
					creds.append((parts[3], parts[4]))
		except Exception as exc:
			logger.error(f"Error reading SSH credentials for {ip}: {exc}")
		return creds

	def _connect(self, ip, username, password):
		ssh = paramiko.SSHClient()
		ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
		ssh.connect(
			ip,
			port=b_port,
			username=username,
			password=password,
			timeout=self.ssh_timeout,
			auth_timeout=self.ssh_timeout,
			banner_timeout=self.ssh_timeout
		)
		logger.info(f"SSH session ready for Lynis on {ip} using {username}")
		return ssh

	def _run_remote_command(self, ssh, command, password=None, sudo=False, timeout=None):
		full_command = command if not sudo else f"sudo -S -p '' {command}"
		stdin, stdout, stderr = ssh.exec_command(full_command, get_pty=True, timeout=timeout or self.command_timeout)
		if sudo and password:
			stdin.write(f"{password}\n")
			stdin.flush()
		exit_code = stdout.channel.recv_exit_status()
		output = stdout.read().decode(errors='ignore')
		error = stderr.read().decode(errors='ignore')
		return exit_code, output.strip(), error.strip()

	def _ensure_lynis_available(self, ssh, password):
		exit_code, _, _ = self._run_remote_command(ssh, "command -v lynis")
		if exit_code == 0:
			return True

		logger.info("Lynis not found on target; installing via apt-get")
		commands = [
			"apt-get update",
			"DEBIAN_FRONTEND=noninteractive apt-get install -y lynis"
		]

		for cmd in commands:
			exit_code, out, err = self._run_remote_command(ssh, cmd, password=password, sudo=True, timeout=600)
			if exit_code != 0:
				logger.error(f"Command '{cmd}' failed during Lynis install: {err or out}")
				return False
		return True

	def _run_lynis(self, ssh, password, ip, username):
		timestamp = datetime.utcnow().strftime('%Y%m%d_%H%M%S')
		remote_log = f"/tmp/lynis-pentest-{timestamp}.log"
		audit_cmd = f"lynis audit system --pentest --quiet --logfile {remote_log}"

		logger.info(f"Running Lynis pentest on {ip} as {username}")
		exit_code, out, err = self._run_remote_command(
			ssh,
			audit_cmd,
			password=password,
			sudo=True,
			timeout=self.command_timeout
		)

		if exit_code != 0:
			logger.error(f"Lynis audit failed on {ip}: {err or out}")
			return None

		report_text = self._fetch_remote_file(ssh, remote_log)
		if not report_text:
			report_text = (out or '') + ("\n" + err if err else '')
		else:
			report_text = report_text + ("\n\n--- STDOUT ---\n" + out if out else '')

		local_report = os.path.join(
			self.shared_data.vulnerabilities_dir,
			f"lynis_{ip}_{timestamp}_pentest.txt"
		)

		header = (
			f"Lynis Pentest Report\nTarget: {ip}\nUser: {username}\n"
			f"Generated (UTC): {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')}\n"
			f"Command: lynis audit system --pentest\n\n"
		)

		with open(local_report, 'w', encoding='utf-8') as handle:
			handle.write(header)
			handle.write(report_text)

		logger.debug(f"Stored Lynis report at {local_report}")
		return local_report

	def _fetch_remote_file(self, ssh, remote_path):
		try:
			sftp = ssh.open_sftp()
			with sftp.open(remote_path, 'r') as remote_file:
				data = remote_file.read().decode(errors='ignore')
			try:
				sftp.remove(remote_path)
			except Exception:
				pass
			sftp.close()
			return data
		except FileNotFoundError:
			logger.warning(f"Remote Lynis log not found at {remote_path}")
			return ''
		except Exception as exc:
			logger.error(f"Error downloading Lynis log {remote_path}: {exc}")
			return ''


if __name__ == "__main__":
	shared = SharedData()
	action = LynisPentestSSH(shared)
	logger.info("LynisPentestSSH module ready")
